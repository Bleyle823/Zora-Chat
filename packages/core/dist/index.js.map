{"version":3,"sources":["../src/config.ts","../src/actions.ts","../src/context.ts","../src/database/CircuitBreaker.ts","../src/logger.ts","../src/parsing.ts","../src/database.ts","../src/settings.ts","../src/types.ts","../src/models.ts","../src/localembeddingManager.ts","../src/embedding.ts","../src/evaluators.ts","../src/generation.ts","../src/goals.ts","../src/memory.ts","../src/messages.ts","../src/posts.ts","../src/providers.ts","../src/relationships.ts","../src/runtime.ts","../src/uuid.ts","../src/knowledge.ts","../src/ragknowledge.ts","../src/environment.ts","../src/cache.ts"],"sourcesContent":["import dotenv from \"dotenv\";\r\nimport path from \"path\";\r\nimport { fileURLToPath } from \"url\";\r\n\r\nconst __filename = fileURLToPath(import.meta.url);\r\nconst __dirname = path.dirname(__filename);\r\n\r\n// Load environment variables from root .env file\r\ndotenv.config({ path: path.resolve(__dirname, \"../../../.env\") });\r\n","import { names, uniqueNamesGenerator } from \"unique-names-generator\";\r\nimport type { Action, ActionExample } from \"./types.ts\";\r\n\r\n/**\r\n * Composes a set of example conversations based on provided actions and a specified count.\r\n * It randomly selects examples from the provided actions and formats them with generated names.\r\n * @param actionsData - An array of `Action` objects from which to draw examples.\r\n * @param count - The number of examples to generate.\r\n * @returns A string containing formatted examples of conversations.\r\n */\r\nexport const composeActionExamples = (actionsData: Action[], count: number) => {\r\n    const data: ActionExample[][][] = actionsData.map((action: Action) => [\r\n        ...action.examples,\r\n    ]);\r\n\r\n    const actionExamples: ActionExample[][] = [];\r\n    let length = data.length;\r\n    for (let i = 0; i < count && length; i++) {\r\n        const actionId = i % length;\r\n        const examples = data[actionId];\r\n        if (examples.length) {\r\n            const rand = ~~(Math.random() * examples.length);\r\n            actionExamples[i] = examples.splice(rand, 1)[0];\r\n        } else {\r\n            i--;\r\n        }\r\n\r\n        if (examples.length == 0) {\r\n            data.splice(actionId, 1);\r\n            length--;\r\n        }\r\n    }\r\n\r\n    const formattedExamples = actionExamples.map((example) => {\r\n        const exampleNames = Array.from({ length: 5 }, () =>\r\n            uniqueNamesGenerator({ dictionaries: [names] })\r\n        );\r\n\r\n        return `\\n${example\r\n            .map((message) => {\r\n                let messageString = `${message.user}: ${message.content.text}${message.content.action ? ` (${message.content.action})` : \"\"}`;\r\n                for (let i = 0; i < exampleNames.length; i++) {\r\n                    messageString = messageString.replaceAll(\r\n                        `{{user${i + 1}}}`,\r\n                        exampleNames[i]\r\n                    );\r\n                }\r\n                return messageString;\r\n            })\r\n            .join(\"\\n\")}`;\r\n    });\r\n\r\n    return formattedExamples.join(\"\\n\");\r\n};\r\n\r\n/**\r\n * Formats the names of the provided actions into a comma-separated string.\r\n * @param actions - An array of `Action` objects from which to extract names.\r\n * @returns A comma-separated string of action names.\r\n */\r\nexport function formatActionNames(actions: Action[]) {\r\n    return actions\r\n        .sort(() => 0.5 - Math.random())\r\n        .map((action: Action) => `${action.name}`)\r\n        .join(\", \");\r\n}\r\n\r\n/**\r\n * Formats the provided actions into a detailed string listing each action's name and description, separated by commas and newlines.\r\n * @param actions - An array of `Action` objects to format.\r\n * @returns A detailed string of actions, including names and descriptions.\r\n */\r\nexport function formatActions(actions: Action[]) {\r\n    return actions\r\n        .sort(() => 0.5 - Math.random())\r\n        .map((action: Action) => `${action.name}: ${action.description}`)\r\n        .join(\",\\n\");\r\n}\r\n","import handlebars from \"handlebars\";\r\nimport type { State, TemplateType } from \"./types.ts\";\r\nimport { names, uniqueNamesGenerator } from \"unique-names-generator\";\r\n\r\n/**\r\n * Composes a context string by replacing placeholders in a template with corresponding values from the state.\r\n *\r\n * This function takes a template string with placeholders in the format `{{placeholder}}` and a state object.\r\n * It replaces each placeholder with the value from the state object that matches the placeholder's name.\r\n * If a matching key is not found in the state object for a given placeholder, the placeholder is replaced with an empty string.\r\n *\r\n * By default, this function uses a simple string replacement approach. However, when `templatingEngine` is set to `'handlebars'`, it uses Handlebars templating engine instead, compiling the template into a reusable function and evaluating it with the provided state object.\r\n *\r\n * @param {Object} params - The parameters for composing the context.\r\n * @param {State} params.state - The state object containing values to replace the placeholders in the template.\r\n * @param {TemplateType} params.template - The template string or function containing placeholders to be replaced with state values.\r\n * @param {\"handlebars\" | undefined} [params.templatingEngine] - The templating engine to use for compiling and evaluating the template (optional, default: `undefined`).\r\n * @returns {string} The composed context string with placeholders replaced by corresponding state values.\r\n *\r\n * @example\r\n * // Given a state object and a template\r\n * const state = { userName: \"Alice\", userAge: 30 };\r\n * const template = \"Hello, {{userName}}! You are {{userAge}} years old\";\r\n *\r\n * // Composing the context with simple string replacement will result in:\r\n * // \"Hello, Alice! You are 30 years old.\"\r\n * const contextSimple = composeContext({ state, template });\r\n *\r\n * // Using composeContext with a template function for dynamic template\r\n * const template = ({ state }) => {\r\n * const tone = Math.random() > 0.5 ? \"kind\" : \"rude\";\r\n *   return `Hello, {{userName}}! You are {{userAge}} years old. Be ${tone}`;\r\n * };\r\n * const contextSimple = composeContext({ state, template });\r\n */\r\n\r\nexport const composeContext = ({\r\n    state,\r\n    template,\r\n    templatingEngine,\r\n}: {\r\n    state: State;\r\n    template: TemplateType;\r\n    templatingEngine?: \"handlebars\";\r\n}) => {\r\n    const templateStr =\r\n        typeof template === \"function\" ? template({ state }) : template;\r\n\r\n    if (templatingEngine === \"handlebars\") {\r\n        const templateFunction = handlebars.compile(templateStr);\r\n        return templateFunction(state);\r\n    }\r\n\r\n    // @ts-expect-error match isn't working as expected\r\n    const out = templateStr.replace(/{{\\w+}}/g, (match) => {\r\n        const key = match.replace(/{{|}}/g, \"\");\r\n        return state[key] ?? \"\";\r\n    });\r\n    return out;\r\n};\r\n\r\n/**\r\n * Adds a header to a body of text.\r\n *\r\n * This function takes a header string and a body string and returns a new string with the header prepended to the body.\r\n * If the body string is empty, the header is returned as is.\r\n *\r\n * @param {string} header - The header to add to the body.\r\n * @param {string} body - The body to which to add the header.\r\n * @returns {string} The body with the header prepended.\r\n *\r\n * @example\r\n * // Given a header and a body\r\n * const header = \"Header\";\r\n * const body = \"Body\";\r\n *\r\n * // Adding the header to the body will result in:\r\n * // \"Header\\nBody\"\r\n * const text = addHeader(header, body);\r\n */\r\nexport const addHeader = (header: string, body: string) => {\r\n    return body.length > 0 ? `${header ? header + \"\\n\" : header}${body}\\n` : \"\";\r\n};\r\n\r\n/**\r\n * Generates a string with random user names populated in a template.\r\n *\r\n * This function generates a specified number of random user names and populates placeholders\r\n * in the provided template with these names. Placeholders in the template should follow the format `{{userX}}`\r\n * where `X` is the position of the user (e.g., `{{user1}}`, `{{user2}}`).\r\n *\r\n * @param {string} params.template - The template string containing placeholders for random user names.\r\n * @param {number} params.length - The number of random user names to generate.\r\n * @returns {string} The template string with placeholders replaced by random user names.\r\n *\r\n * @example\r\n * // Given a template and a length\r\n * const template = \"Hello, {{user1}}! Meet {{user2}} and {{user3}}.\";\r\n * const length = 3;\r\n *\r\n * // Composing the random user string will result in:\r\n * // \"Hello, John! Meet Alice and Bob.\"\r\n * const result = composeRandomUser({ template, length });\r\n */\r\nexport const composeRandomUser = (template: string, length: number) => {\r\n    const exampleNames = Array.from({ length }, () =>\r\n        uniqueNamesGenerator({ dictionaries: [names] })\r\n    );\r\n    let result = template;\r\n    for (let i = 0; i < exampleNames.length; i++) {\r\n        result = result.replaceAll(`{{user${i + 1}}}`, exampleNames[i]);\r\n    }\r\n\r\n    return result;\r\n};\r\n","export type CircuitBreakerState = \"CLOSED\" | \"OPEN\" | \"HALF_OPEN\";\r\n\r\nexport class CircuitBreaker {\r\n    private state: CircuitBreakerState = \"CLOSED\";\r\n    private failureCount = 0;\r\n    private lastFailureTime?: number;\r\n    private halfOpenSuccesses = 0;\r\n\r\n    private readonly failureThreshold: number;\r\n    private readonly resetTimeout: number;\r\n    private readonly halfOpenMaxAttempts: number;\r\n\r\n    constructor(\r\n        private readonly config: {\r\n            failureThreshold?: number;\r\n            resetTimeout?: number;\r\n            halfOpenMaxAttempts?: number;\r\n        } = {}\r\n    ) {\r\n        this.failureThreshold = config.failureThreshold ?? 5;\r\n        this.resetTimeout = config.resetTimeout ?? 60000;\r\n        this.halfOpenMaxAttempts = config.halfOpenMaxAttempts ?? 3;\r\n    }\r\n\r\n    async execute<T>(operation: () => Promise<T>): Promise<T> {\r\n        if (this.state === \"OPEN\") {\r\n            if (Date.now() - (this.lastFailureTime || 0) > this.resetTimeout) {\r\n                this.state = \"HALF_OPEN\";\r\n                this.halfOpenSuccesses = 0;\r\n            } else {\r\n                throw new Error(\"Circuit breaker is OPEN\");\r\n            }\r\n        }\r\n\r\n        try {\r\n            const result = await operation();\r\n\r\n            if (this.state === \"HALF_OPEN\") {\r\n                this.halfOpenSuccesses++;\r\n                if (this.halfOpenSuccesses >= this.halfOpenMaxAttempts) {\r\n                    this.reset();\r\n                }\r\n            }\r\n\r\n            return result;\r\n        } catch (error) {\r\n            this.handleFailure();\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    private handleFailure(): void {\r\n        this.failureCount++;\r\n        this.lastFailureTime = Date.now();\r\n\r\n        if (\r\n            this.state !== \"OPEN\" &&\r\n            this.failureCount >= this.failureThreshold\r\n        ) {\r\n            this.state = \"OPEN\";\r\n        }\r\n    }\r\n\r\n    private reset(): void {\r\n        this.state = \"CLOSED\";\r\n        this.failureCount = 0;\r\n        this.lastFailureTime = undefined;\r\n    }\r\n\r\n    getState(): \"CLOSED\" | \"OPEN\" | \"HALF_OPEN\" {\r\n        return this.state;\r\n    }\r\n}\r\n","import pino, { type LogFn } from \"pino\";\r\nimport pretty from \"pino-pretty\";\r\n\r\nimport { parseBooleanFromText } from \"./parsing.ts\";\r\n\r\n\r\nconst customLevels: Record<string, number> = {\r\n    fatal: 60,\r\n    error: 50,\r\n    warn: 40,\r\n    info: 30,\r\n    log: 29,\r\n    progress: 28,\r\n    success: 27,\r\n    debug: 20,\r\n    trace: 10,\r\n};\r\n\r\nconst raw = parseBooleanFromText(process?.env?.LOG_JSON_FORMAT) || false;\r\n\r\nconst createStream = () => {\r\n    if (raw) {\r\n        return undefined;\r\n    }\r\n    return pretty({\r\n        colorize: true,\r\n        translateTime: \"yyyy-mm-dd HH:MM:ss\",\r\n        ignore: \"pid,hostname\",\r\n    });\r\n};\r\n\r\nconst defaultLevel = process?.env?.DEFAULT_LOG_LEVEL || \"info\";\r\n\r\nconst options = {\r\n    level: defaultLevel,\r\n    customLevels,\r\n    hooks: {\r\n        logMethod(\r\n            inputArgs: [string | Record<string, unknown>, ...unknown[]],\r\n            method: LogFn\r\n        ): void {\r\n            const [arg1, ...rest] = inputArgs;\r\n\r\n            if (typeof arg1 === \"object\") {\r\n                const messageParts = rest.map((arg) =>\r\n                    typeof arg === \"string\" ? arg : JSON.stringify(arg)\r\n                );\r\n                const message = messageParts.join(\" \");\r\n                method.apply(this, [arg1, message]);\r\n            } else {\r\n                const context = {};\r\n                const messageParts = [arg1, ...rest].map((arg) =>\r\n                    typeof arg === \"string\" ? arg : arg\r\n                );\r\n                const message = messageParts\r\n                    .filter((part) => typeof part === \"string\")\r\n                    .join(\" \");\r\n                const jsonParts = messageParts.filter(\r\n                    (part) => typeof part === \"object\"\r\n                );\r\n\r\n                Object.assign(context, ...jsonParts);\r\n\r\n                method.apply(this, [context, message]);\r\n            }\r\n        },\r\n    },\r\n};\r\n\r\nexport const elizaLogger = pino(options, createStream());\r\n\r\nexport default elizaLogger;\r\n","import type { ActionResponse } from \"./types.ts\";\r\nconst jsonBlockPattern = /```json\\n([\\s\\S]*?)\\n```/;\r\n\r\nexport const messageCompletionFooter = `\\nResponse format should be formatted in a valid JSON block like this:\r\n\\`\\`\\`json\r\n{ \"user\": \"{{agentName}}\", \"text\": \"<string>\", \"action\": \"<string>\" }\r\n\\`\\`\\`\r\n\r\nThe “action” field should be one of the options in [Available Actions] and the \"text\" field should be the response you want to send.\r\n`;\r\n\r\nexport const shouldRespondFooter = `The available options are [RESPOND], [IGNORE], or [STOP]. Choose the most appropriate option.\r\nIf {{agentName}} is talking too much, you can choose [IGNORE]\r\n\r\nYour response must include one of the options.`;\r\n\r\nexport const parseShouldRespondFromText = (\r\n    text: string\r\n): \"RESPOND\" | \"IGNORE\" | \"STOP\" | null => {\r\n    const match = text\r\n        .split(\"\\n\")[0]\r\n        .trim()\r\n        .replace(\"[\", \"\")\r\n        .toUpperCase()\r\n        .replace(\"]\", \"\")\r\n        .match(/^(RESPOND|IGNORE|STOP)$/i);\r\n    return match\r\n        ? (match[0].toUpperCase() as \"RESPOND\" | \"IGNORE\" | \"STOP\")\r\n        : text.includes(\"RESPOND\")\r\n        ? \"RESPOND\"\r\n        : text.includes(\"IGNORE\")\r\n        ? \"IGNORE\"\r\n        : text.includes(\"STOP\")\r\n        ? \"STOP\"\r\n        : null;\r\n};\r\n\r\nexport const booleanFooter = `Respond with only a YES or a NO.`;\r\n\r\n/**\r\n * Parses a string to determine its boolean equivalent.\r\n *\r\n * Recognized affirmative values: \"YES\", \"Y\", \"TRUE\", \"T\", \"1\", \"ON\", \"ENABLE\".\r\n * Recognized negative values: \"NO\", \"N\", \"FALSE\", \"F\", \"0\", \"OFF\", \"DISABLE\".\r\n *\r\n * @param {string} text - The input text to parse.\r\n * @returns {boolean|null} - Returns `true` for affirmative inputs, `false` for negative inputs, and `null` for unrecognized inputs or null/undefined.\r\n */\r\nexport const parseBooleanFromText = (text: string) => {\r\n    if (!text) return null; // Handle null or undefined input\r\n\r\n    const affirmative = [\"YES\", \"Y\", \"TRUE\", \"T\", \"1\", \"ON\", \"ENABLE\"];\r\n    const negative = [\"NO\", \"N\", \"FALSE\", \"F\", \"0\", \"OFF\", \"DISABLE\"];\r\n\r\n    const normalizedText = text.trim().toUpperCase();\r\n\r\n    if (affirmative.includes(normalizedText)) {\r\n        return true;\r\n    } else if (negative.includes(normalizedText)) {\r\n        return false;\r\n    }\r\n\r\n    return null; // Return null for unrecognized inputs\r\n};\r\n\r\nexport const stringArrayFooter = `Respond with a JSON array containing the values in a valid JSON block formatted for markdown with this structure:\r\n\\`\\`\\`json\r\n[\r\n  'value',\r\n  'value'\r\n]\r\n\\`\\`\\`\r\n\r\nYour response must include the valid JSON block.`;\r\n\r\n/**\r\n * Parses a JSON array from a given text. The function looks for a JSON block wrapped in triple backticks\r\n * with `json` language identifier, and if not found, it searches for an array pattern within the text.\r\n * It then attempts to parse the JSON string into a JavaScript object. If parsing is successful and the result\r\n * is an array, it returns the array; otherwise, it returns null.\r\n *\r\n * @param text - The input text from which to extract and parse the JSON array.\r\n * @returns An array parsed from the JSON string if successful; otherwise, null.\r\n */\r\nexport function parseJsonArrayFromText(text: string) {\r\n    let jsonData = null;\r\n\r\n    // First try to parse with the original JSON format\r\n    const jsonBlockMatch = text.match(jsonBlockPattern);\r\n\r\n    if (jsonBlockMatch) {\r\n        try {\r\n            // Only replace quotes that are actually being used for string delimitation\r\n            const normalizedJson = jsonBlockMatch[1].replace(\r\n                /(?<!\\\\)'([^']*)'(?=\\s*[,}\\]])/g,\r\n                '\"$1\"'\r\n            );\r\n            jsonData = JSON.parse(normalizedJson);\r\n        } catch (e) {\r\n            console.error(\"Error parsing JSON:\", e);\r\n            console.error(\"Failed parsing text:\", jsonBlockMatch[1]);\r\n        }\r\n    }\r\n\r\n    // If that fails, try to find an array pattern\r\n    if (!jsonData) {\r\n        const arrayPattern = /\\[\\s*(['\"])(.*?)\\1\\s*\\]/;\r\n        const arrayMatch = text.match(arrayPattern);\r\n\r\n        if (arrayMatch) {\r\n            try {\r\n                // Only replace quotes that are actually being used for string delimitation\r\n                const normalizedJson = arrayMatch[0].replace(\r\n                    /(?<!\\\\)'([^']*)'(?=\\s*[,}\\]])/g,\r\n                    '\"$1\"'\r\n                );\r\n                jsonData = JSON.parse(normalizedJson);\r\n            } catch (e) {\r\n                console.error(\"Error parsing JSON:\", e);\r\n                console.error(\"Failed parsing text:\", arrayMatch[0]);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (Array.isArray(jsonData)) {\r\n        return jsonData;\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * Parses a JSON object from a given text. The function looks for a JSON block wrapped in triple backticks\r\n * with `json` language identifier, and if not found, it searches for an object pattern within the text.\r\n * It then attempts to parse the JSON string into a JavaScript object. If parsing is successful and the result\r\n * is an object (but not an array), it returns the object; otherwise, it tries to parse an array if the result\r\n * is an array, or returns null if parsing is unsuccessful or the result is neither an object nor an array.\r\n *\r\n * @param text - The input text from which to extract and parse the JSON object.\r\n * @returns An object parsed from the JSON string if successful; otherwise, null or the result of parsing an array.\r\n */\r\nexport function parseJSONObjectFromText(\r\n    text: string\r\n): Record<string, any> | null {\r\n    let jsonData = null;\r\n    const jsonBlockMatch = text.match(jsonBlockPattern);\r\n\r\n    if (jsonBlockMatch) {\r\n        text = cleanJsonResponse(text);\r\n        // see issue 3779\r\n        //const parsingText = normalizeJsonString(text);\r\n        try {\r\n            jsonData = JSON.parse(text);\r\n        } catch (e) {\r\n            console.error(\"Error parsing JSON:\", e);\r\n            console.error(\"Text is not JSON\", text);\r\n            return extractAttributes(text);\r\n        }\r\n    } else {\r\n        const objectPattern = /{[\\s\\S]*?}?/;\r\n        const objectMatch = text.match(objectPattern);\r\n\r\n        if (objectMatch) {\r\n            text = cleanJsonResponse(text);\r\n            // see issue 3779\r\n\t    //const parsingText = normalizeJsonString(text);\r\n            try {\r\n                jsonData = JSON.parse(text);\r\n            } catch (e) {\r\n                console.error(\"Error parsing JSON:\", e);\r\n                console.error(\"Text is not JSON\", text);\r\n                return extractAttributes(text);\r\n            }\r\n        }\r\n    }\r\n\r\n    if (\r\n        typeof jsonData === \"object\" &&\r\n        jsonData !== null &&\r\n        !Array.isArray(jsonData)\r\n    ) {\r\n        return jsonData;\r\n    } else if (typeof jsonData === \"object\" && Array.isArray(jsonData)) {\r\n        return parseJsonArrayFromText(text);\r\n    } else {\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Extracts specific attributes (e.g., user, text, action) from a JSON-like string using regex.\r\n * @param response - The cleaned string response to extract attributes from.\r\n * @param attributesToExtract - An array of attribute names to extract.\r\n * @returns An object containing the extracted attributes.\r\n */\r\nexport function extractAttributes(\r\n    response: string,\r\n    attributesToExtract?: string[]\r\n): { [key: string]: string | undefined } {\r\n    response = response.trim();\r\n    const attributes: { [key: string]: string | undefined } = {};\r\n\r\n    if (!attributesToExtract || attributesToExtract.length === 0) {\r\n        // Extract all attributes if no specific attributes are provided\r\n        const matches = response.matchAll(/\"([^\"]+)\"\\s*:\\s*\"([^\"]*)\"?/g);\r\n        for (const match of matches) {\r\n            attributes[match[1]] = match[2];\r\n        }\r\n    } else {\r\n        // Extract only specified attributes\r\n        attributesToExtract.forEach((attribute) => {\r\n            const match = response.match(\r\n                new RegExp(`\"${attribute}\"\\\\s*:\\\\s*\"([^\"]*)\"?`, \"i\")\r\n            );\r\n            if (match) {\r\n                attributes[attribute] = match[1];\r\n            }\r\n        });\r\n    }\r\n\r\n    return Object.entries(attributes).length > 0 ? attributes : null;\r\n}\r\n\r\n/**\r\n * Normalizes a JSON-like string by correcting formatting issues:\r\n * - Removes extra spaces after '{' and before '}'.\r\n * - Wraps unquoted values in double quotes.\r\n * - Converts single-quoted values to double-quoted.\r\n * - Ensures consistency in key-value formatting.\r\n * - Normalizes mixed adjacent quote pairs.\r\n *\r\n * This is useful for cleaning up improperly formatted JSON strings\r\n * before parsing them into valid JSON.\r\n *\r\n * @param str - The JSON-like string to normalize.\r\n * @returns A properly formatted JSON string.\r\n */\r\n\r\nexport const normalizeJsonString = (str: string) => {\r\n    // Remove extra spaces after '{' and before '}'\r\n    str = str.replace(/\\{\\s+/, '{').replace(/\\s+\\}/, '}').trim();\r\n\r\n    // \"key\": unquotedValue → \"key\": \"unquotedValue\"\r\n    str = str.replace(\r\n      /(\"[\\w\\d_-]+\")\\s*: \\s*(?!\"|\\[|\\{|null|true|false|\\d+)([\\s\\S]+?)(?=(,\\s*\"|\\}))/g,\r\n      '$1: \"$2\"',\r\n    );\r\n\r\n    // \"key\": 'value' → \"key\": \"value\"\r\n    str = str.replace(\r\n      /\"([^\"]+)\"\\s*:\\s*'([^']*)'/g,\r\n      (_, key, value) => `\"${key}\": \"${value}\"`,\r\n    );\r\n\r\n    // \"key\": someWord → \"key\": \"someWord\"\r\n    str = str.replace(/(\"[\\w\\d_-]+\")\\s*:\\s*(?!null|false|true)([A-Za-z_]+)(?![\"\\w])/g, '$1: \"$2\"');\r\n\r\n    // Replace adjacent quote pairs with a single double quote\r\n    str = str.replace(/(?:\"')|(?:'\")/g, '\"');\r\n    return str;\r\n};\r\n\r\n/**\r\n * Cleans a JSON-like response string by removing unnecessary markers, line breaks, and extra whitespace.\r\n * This is useful for handling improperly formatted JSON responses from external sources.\r\n *\r\n * @param response - The raw JSON-like string response to clean.\r\n * @returns The cleaned string, ready for parsing or further processing.\r\n */\r\n\r\nexport function cleanJsonResponse(response: string): string {\r\n    return response\r\n        .replace(/```json\\s*/g, \"\") // Remove ```json\r\n        .replace(/```\\s*/g, \"\") // Remove any remaining ```\r\n        .replace(/(\\r\\n|\\n|\\r)/g, \"\") // Remove line breaks\r\n        .trim();\r\n}\r\n\r\nexport const postActionResponseFooter = `Choose any combination of [LIKE], [RETWEET], [QUOTE], and [REPLY] that are appropriate. Each action must be on its own line. Your response must only include the chosen actions.`;\r\n\r\nexport const parseActionResponseFromText = (\r\n    text: string\r\n): { actions: ActionResponse } => {\r\n    const actions: ActionResponse = {\r\n        like: false,\r\n        retweet: false,\r\n        quote: false,\r\n        reply: false,\r\n    };\r\n\r\n    // Regex patterns\r\n    const likePattern = /\\[LIKE\\]/i;\r\n    const retweetPattern = /\\[RETWEET\\]/i;\r\n    const quotePattern = /\\[QUOTE\\]/i;\r\n    const replyPattern = /\\[REPLY\\]/i;\r\n\r\n    // Check with regex\r\n    actions.like = likePattern.test(text);\r\n    actions.retweet = retweetPattern.test(text);\r\n    actions.quote = quotePattern.test(text);\r\n    actions.reply = replyPattern.test(text);\r\n\r\n    // Also do line by line parsing as backup\r\n    const lines = text.split(\"\\n\");\r\n    for (const line of lines) {\r\n        const trimmed = line.trim();\r\n        if (trimmed === \"[LIKE]\") actions.like = true;\r\n        if (trimmed === \"[RETWEET]\") actions.retweet = true;\r\n        if (trimmed === \"[QUOTE]\") actions.quote = true;\r\n        if (trimmed === \"[REPLY]\") actions.reply = true;\r\n    }\r\n\r\n    return { actions };\r\n};\r\n\r\n/**\r\n * Truncate text to fit within the character limit, ensuring it ends at a complete sentence.\r\n */\r\nexport function truncateToCompleteSentence(\r\n    text: string,\r\n    maxLength: number\r\n): string {\r\n    if (text.length <= maxLength) {\r\n        return text;\r\n    }\r\n\r\n    // Attempt to truncate at the last period within the limit\r\n    const lastPeriodIndex = text.lastIndexOf(\".\", maxLength - 1);\r\n    if (lastPeriodIndex !== -1) {\r\n        const truncatedAtPeriod = text.slice(0, lastPeriodIndex + 1).trim();\r\n        if (truncatedAtPeriod.length > 0) {\r\n            return truncatedAtPeriod;\r\n        }\r\n    }\r\n\r\n    // If no period, truncate to the nearest whitespace within the limit\r\n    const lastSpaceIndex = text.lastIndexOf(\" \", maxLength - 1);\r\n    if (lastSpaceIndex !== -1) {\r\n        const truncatedAtSpace = text.slice(0, lastSpaceIndex).trim();\r\n        if (truncatedAtSpace.length > 0) {\r\n            return truncatedAtSpace + \"...\";\r\n        }\r\n    }\r\n\r\n    // Fallback: Hard truncate and add ellipsis\r\n    const hardTruncated = text.slice(0, maxLength - 3).trim();\r\n    return hardTruncated + \"...\";\r\n}\r\n","import type {\r\n    Account,\r\n    Actor,\r\n    GoalStatus,\r\n    Goal,\r\n    Memory,\r\n    Relationship,\r\n    UUID,\r\n    RAGKnowledgeItem,\r\n    Participant,\r\n    IDatabaseAdapter,\r\n} from \"./types.ts\";\r\nimport { CircuitBreaker } from \"./database/CircuitBreaker\";\r\nimport { elizaLogger } from \"./logger\";\r\n\r\n/**\r\n * An abstract class representing a database adapter for managing various entities\r\n * like accounts, memories, actors, goals, and rooms.\r\n */\r\nexport abstract class DatabaseAdapter<DB = any> implements IDatabaseAdapter {\r\n    /**\r\n     * The database instance.\r\n     */\r\n    db: DB;\r\n\r\n    /**\r\n     * Circuit breaker instance used to handle fault tolerance and prevent cascading failures.\r\n     * Implements the Circuit Breaker pattern to temporarily disable operations when a failure threshold is reached.\r\n     *\r\n     * The circuit breaker has three states:\r\n     * - CLOSED: Normal operation, requests pass through\r\n     * - OPEN: Failure threshold exceeded, requests are blocked\r\n     * - HALF_OPEN: Testing if service has recovered\r\n     *\r\n     * @protected\r\n     */\r\n    protected circuitBreaker: CircuitBreaker;\r\n\r\n    /**\r\n     * Creates a new DatabaseAdapter instance with optional circuit breaker configuration.\r\n     *\r\n     * @param circuitBreakerConfig - Configuration options for the circuit breaker\r\n     * @param circuitBreakerConfig.failureThreshold - Number of failures before circuit opens (defaults to 5)\r\n     * @param circuitBreakerConfig.resetTimeout - Time in ms before attempting to close circuit (defaults to 60000)\r\n     * @param circuitBreakerConfig.halfOpenMaxAttempts - Number of successful attempts needed to close circuit (defaults to 3)\r\n     */\r\n    constructor(circuitBreakerConfig?: {\r\n        failureThreshold?: number;\r\n        resetTimeout?: number;\r\n        halfOpenMaxAttempts?: number;\r\n    }) {\r\n        this.circuitBreaker = new CircuitBreaker(circuitBreakerConfig);\r\n    }\r\n\r\n    /**\r\n     * Optional initialization method for the database adapter.\r\n     * @returns A Promise that resolves when initialization is complete.\r\n     */\r\n    abstract init(): Promise<void>;\r\n\r\n    /**\r\n     * Optional close method for the database adapter.\r\n     * @returns A Promise that resolves when closing is complete.\r\n     */\r\n    abstract close(): Promise<void>;\r\n\r\n    /**\r\n     * Retrieves an account by its ID.\r\n     * @param userId The UUID of the user account to retrieve.\r\n     * @returns A Promise that resolves to the Account object or null if not found.\r\n     */\r\n    abstract getAccountById(userId: UUID): Promise<Account | null>;\r\n\r\n    /**\r\n     * Creates a new account in the database.\r\n     * @param account The account object to create.\r\n     * @returns A Promise that resolves when the account creation is complete.\r\n     */\r\n    abstract createAccount(account: Account): Promise<boolean>;\r\n\r\n    /**\r\n     * Retrieves memories based on the specified parameters.\r\n     * @param params An object containing parameters for the memory retrieval.\r\n     * @returns A Promise that resolves to an array of Memory objects.\r\n     */\r\n    abstract getMemories(params: {\r\n        agentId: UUID;\r\n        roomId: UUID;\r\n        count?: number;\r\n        unique?: boolean;\r\n        tableName: string;\r\n    }): Promise<Memory[]>;\r\n\r\n    abstract getMemoriesByRoomIds(params: {\r\n        agentId: UUID;\r\n        roomIds: UUID[];\r\n        tableName: string;\r\n        limit?: number;\r\n    }): Promise<Memory[]>;\r\n\r\n    abstract getMemoryById(id: UUID): Promise<Memory | null>;\r\n\r\n    /**\r\n     * Retrieves multiple memories by their IDs\r\n     * @param memoryIds Array of UUIDs of the memories to retrieve\r\n     * @param tableName Optional table name to filter memories by type\r\n     * @returns Promise resolving to array of Memory objects\r\n     */\r\n    abstract getMemoriesByIds(\r\n        memoryIds: UUID[],\r\n        tableName?: string\r\n    ): Promise<Memory[]>;\r\n\r\n    /**\r\n     * Retrieves cached embeddings based on the specified query parameters.\r\n     * @param params An object containing parameters for the embedding retrieval.\r\n     * @returns A Promise that resolves to an array of objects containing embeddings and levenshtein scores.\r\n     */\r\n    abstract getCachedEmbeddings({\r\n        query_table_name,\r\n        query_threshold,\r\n        query_input,\r\n        query_field_name,\r\n        query_field_sub_name,\r\n        query_match_count,\r\n    }: {\r\n        query_table_name: string;\r\n        query_threshold: number;\r\n        query_input: string;\r\n        query_field_name: string;\r\n        query_field_sub_name: string;\r\n        query_match_count: number;\r\n    }): Promise<\r\n        {\r\n            embedding: number[];\r\n            levenshtein_score: number;\r\n        }[]\r\n    >;\r\n\r\n    /**\r\n     * Logs an event or action with the specified details.\r\n     * @param params An object containing parameters for the log entry.\r\n     * @returns A Promise that resolves when the log entry has been saved.\r\n     */\r\n    abstract log(params: {\r\n        body: { [key: string]: unknown };\r\n        userId: UUID;\r\n        roomId: UUID;\r\n        type: string;\r\n    }): Promise<void>;\r\n\r\n    /**\r\n     * Retrieves details of actors in a given room.\r\n     * @param params An object containing the roomId to search for actors.\r\n     * @returns A Promise that resolves to an array of Actor objects.\r\n     */\r\n    abstract getActorDetails(params: { roomId: UUID }): Promise<Actor[]>;\r\n\r\n    /**\r\n     * Searches for memories based on embeddings and other specified parameters.\r\n     * @param params An object containing parameters for the memory search.\r\n     * @returns A Promise that resolves to an array of Memory objects.\r\n     */\r\n    abstract searchMemories(params: {\r\n        tableName: string;\r\n        agentId: UUID;\r\n        roomId: UUID;\r\n        embedding: number[];\r\n        match_threshold: number;\r\n        match_count: number;\r\n        unique: boolean;\r\n    }): Promise<Memory[]>;\r\n\r\n    /**\r\n     * Updates the status of a specific goal.\r\n     * @param params An object containing the goalId and the new status.\r\n     * @returns A Promise that resolves when the goal status has been updated.\r\n     */\r\n    abstract updateGoalStatus(params: {\r\n        goalId: UUID;\r\n        status: GoalStatus;\r\n    }): Promise<void>;\r\n\r\n    /**\r\n     * Searches for memories by embedding and other specified parameters.\r\n     * @param embedding The embedding vector to search with.\r\n     * @param params Additional parameters for the search.\r\n     * @returns A Promise that resolves to an array of Memory objects.\r\n     */\r\n    abstract searchMemoriesByEmbedding(\r\n        embedding: number[],\r\n        params: {\r\n            match_threshold?: number;\r\n            count?: number;\r\n            roomId?: UUID;\r\n            agentId?: UUID;\r\n            unique?: boolean;\r\n            tableName: string;\r\n        }\r\n    ): Promise<Memory[]>;\r\n\r\n    /**\r\n     * Creates a new memory in the database.\r\n     * @param memory The memory object to create.\r\n     * @param tableName The table where the memory should be stored.\r\n     * @param unique Indicates if the memory should be unique.\r\n     * @returns A Promise that resolves when the memory has been created.\r\n     */\r\n    abstract createMemory(\r\n        memory: Memory,\r\n        tableName: string,\r\n        unique?: boolean\r\n    ): Promise<void>;\r\n\r\n    /**\r\n     * Removes a specific memory from the database.\r\n     * @param memoryId The UUID of the memory to remove.\r\n     * @param tableName The table from which the memory should be removed.\r\n     * @returns A Promise that resolves when the memory has been removed.\r\n     */\r\n    abstract removeMemory(memoryId: UUID, tableName: string): Promise<void>;\r\n\r\n    /**\r\n     * Removes all memories associated with a specific room.\r\n     * @param roomId The UUID of the room whose memories should be removed.\r\n     * @param tableName The table from which the memories should be removed.\r\n     * @returns A Promise that resolves when all memories have been removed.\r\n     */\r\n    abstract removeAllMemories(roomId: UUID, tableName: string): Promise<void>;\r\n\r\n    /**\r\n     * Counts the number of memories in a specific room.\r\n     * @param roomId The UUID of the room for which to count memories.\r\n     * @param unique Specifies whether to count only unique memories.\r\n     * @param tableName Optional table name to count memories from.\r\n     * @returns A Promise that resolves to the number of memories.\r\n     */\r\n    abstract countMemories(\r\n        roomId: UUID,\r\n        unique?: boolean,\r\n        tableName?: string\r\n    ): Promise<number>;\r\n\r\n    /**\r\n     * Retrieves goals based on specified parameters.\r\n     * @param params An object containing parameters for goal retrieval.\r\n     * @returns A Promise that resolves to an array of Goal objects.\r\n     */\r\n    abstract getGoals(params: {\r\n        agentId: UUID;\r\n        roomId: UUID;\r\n        userId?: UUID | null;\r\n        onlyInProgress?: boolean;\r\n        count?: number;\r\n    }): Promise<Goal[]>;\r\n\r\n    /**\r\n     * Updates a specific goal in the database.\r\n     * @param goal The goal object with updated properties.\r\n     * @returns A Promise that resolves when the goal has been updated.\r\n     */\r\n    abstract updateGoal(goal: Goal): Promise<void>;\r\n\r\n    /**\r\n     * Creates a new goal in the database.\r\n     * @param goal The goal object to create.\r\n     * @returns A Promise that resolves when the goal has been created.\r\n     */\r\n    abstract createGoal(goal: Goal): Promise<void>;\r\n\r\n    /**\r\n     * Removes a specific goal from the database.\r\n     * @param goalId The UUID of the goal to remove.\r\n     * @returns A Promise that resolves when the goal has been removed.\r\n     */\r\n    abstract removeGoal(goalId: UUID): Promise<void>;\r\n\r\n    /**\r\n     * Removes all goals associated with a specific room.\r\n     * @param roomId The UUID of the room whose goals should be removed.\r\n     * @returns A Promise that resolves when all goals have been removed.\r\n     */\r\n    abstract removeAllGoals(roomId: UUID): Promise<void>;\r\n\r\n    /**\r\n     * Retrieves the room ID for a given room, if it exists.\r\n     * @param roomId The UUID of the room to retrieve.\r\n     * @returns A Promise that resolves to the room ID or null if not found.\r\n     */\r\n    abstract getRoom(roomId: UUID): Promise<UUID | null>;\r\n\r\n    /**\r\n     * Creates a new room with an optional specified ID.\r\n     * @param roomId Optional UUID to assign to the new room.\r\n     * @returns A Promise that resolves to the UUID of the created room.\r\n     */\r\n    abstract createRoom(roomId?: UUID): Promise<UUID>;\r\n\r\n    /**\r\n     * Removes a specific room from the database.\r\n     * @param roomId The UUID of the room to remove.\r\n     * @returns A Promise that resolves when the room has been removed.\r\n     */\r\n    abstract removeRoom(roomId: UUID): Promise<void>;\r\n\r\n    /**\r\n     * Retrieves room IDs for which a specific user is a participant.\r\n     * @param userId The UUID of the user.\r\n     * @returns A Promise that resolves to an array of room IDs.\r\n     */\r\n    abstract getRoomsForParticipant(userId: UUID): Promise<UUID[]>;\r\n\r\n    /**\r\n     * Retrieves room IDs for which specific users are participants.\r\n     * @param userIds An array of UUIDs of the users.\r\n     * @returns A Promise that resolves to an array of room IDs.\r\n     */\r\n    abstract getRoomsForParticipants(userIds: UUID[]): Promise<UUID[]>;\r\n\r\n    /**\r\n     * Adds a user as a participant to a specific room.\r\n     * @param userId The UUID of the user to add as a participant.\r\n     * @param roomId The UUID of the room to which the user will be added.\r\n     * @returns A Promise that resolves to a boolean indicating success or failure.\r\n     */\r\n    abstract addParticipant(userId: UUID, roomId: UUID): Promise<boolean>;\r\n\r\n    /**\r\n     * Removes a user as a participant from a specific room.\r\n     * @param userId The UUID of the user to remove as a participant.\r\n     * @param roomId The UUID of the room from which the user will be removed.\r\n     * @returns A Promise that resolves to a boolean indicating success or failure.\r\n     */\r\n    abstract removeParticipant(userId: UUID, roomId: UUID): Promise<boolean>;\r\n\r\n    /**\r\n     * Retrieves participants associated with a specific account.\r\n     * @param userId The UUID of the account.\r\n     * @returns A Promise that resolves to an array of Participant objects.\r\n     */\r\n    abstract getParticipantsForAccount(userId: UUID): Promise<Participant[]>;\r\n\r\n    /**\r\n     * Retrieves participants associated with a specific account.\r\n     * @param userId The UUID of the account.\r\n     * @returns A Promise that resolves to an array of Participant objects.\r\n     */\r\n    abstract getParticipantsForAccount(userId: UUID): Promise<Participant[]>;\r\n\r\n    /**\r\n     * Retrieves participants for a specific room.\r\n     * @param roomId The UUID of the room for which to retrieve participants.\r\n     * @returns A Promise that resolves to an array of UUIDs representing the participants.\r\n     */\r\n    abstract getParticipantsForRoom(roomId: UUID): Promise<UUID[]>;\r\n\r\n    abstract getParticipantUserState(\r\n        roomId: UUID,\r\n        userId: UUID\r\n    ): Promise<\"FOLLOWED\" | \"MUTED\" | null>;\r\n    abstract setParticipantUserState(\r\n        roomId: UUID,\r\n        userId: UUID,\r\n        state: \"FOLLOWED\" | \"MUTED\" | null\r\n    ): Promise<void>;\r\n\r\n    /**\r\n     * Creates a new relationship between two users.\r\n     * @param params An object containing the UUIDs of the two users (userA and userB).\r\n     * @returns A Promise that resolves to a boolean indicating success or failure of the creation.\r\n     */\r\n    abstract createRelationship(params: {\r\n        userA: UUID;\r\n        userB: UUID;\r\n    }): Promise<boolean>;\r\n\r\n    /**\r\n     * Retrieves a relationship between two users if it exists.\r\n     * @param params An object containing the UUIDs of the two users (userA and userB).\r\n     * @returns A Promise that resolves to the Relationship object or null if not found.\r\n     */\r\n    abstract getRelationship(params: {\r\n        userA: UUID;\r\n        userB: UUID;\r\n    }): Promise<Relationship | null>;\r\n\r\n    /**\r\n     * Retrieves all relationships for a specific user.\r\n     * @param params An object containing the UUID of the user.\r\n     * @returns A Promise that resolves to an array of Relationship objects.\r\n     */\r\n    abstract getRelationships(params: {\r\n        userId: UUID;\r\n    }): Promise<Relationship[]>;\r\n\r\n    /**\r\n     * Retrieves knowledge items based on specified parameters.\r\n     * @param params Object containing search parameters\r\n     * @returns Promise resolving to array of knowledge items\r\n     */\r\n    abstract getKnowledge(params: {\r\n        id?: UUID;\r\n        agentId: UUID;\r\n        limit?: number;\r\n        query?: string;\r\n        conversationContext?: string;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n\r\n    abstract searchKnowledge(params: {\r\n        agentId: UUID;\r\n        embedding: Float32Array;\r\n        match_threshold: number;\r\n        match_count: number;\r\n        searchText?: string;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n\r\n    /**\r\n     * Creates a new knowledge item in the database.\r\n     * @param knowledge The knowledge item to create\r\n     * @returns Promise resolving when creation is complete\r\n     */\r\n    abstract createKnowledge(knowledge: RAGKnowledgeItem): Promise<void>;\r\n\r\n    /**\r\n     * Removes a knowledge item and its associated chunks from the database.\r\n     * @param id The ID of the knowledge item to remove\r\n     * @returns Promise resolving when removal is complete\r\n     */\r\n    abstract removeKnowledge(id: UUID): Promise<void>;\r\n\r\n    /**\r\n     * Removes an agents full knowledge database and its associated chunks from the database.\r\n     * @param agentId The Agent ID of the knowledge items to remove\r\n     * @returns Promise resolving when removal is complete\r\n     */\r\n    abstract clearKnowledge(agentId: UUID, shared?: boolean): Promise<void>;\r\n\r\n    /**\r\n     * Executes an operation with circuit breaker protection.\r\n     * @param operation A function that returns a Promise to be executed with circuit breaker protection\r\n     * @param context A string describing the context/operation being performed for logging purposes\r\n     * @returns A Promise that resolves to the result of the operation\r\n     * @throws Will throw an error if the circuit breaker is open or if the operation fails\r\n     * @protected\r\n     */\r\n    protected async withCircuitBreaker<T>(\r\n        operation: () => Promise<T>,\r\n        context: string\r\n    ): Promise<T> {\r\n        try {\r\n            return await this.circuitBreaker.execute(operation);\r\n        } catch (error) {\r\n            elizaLogger.error(`Circuit breaker error in ${context}:`, {\r\n                error: error instanceof Error ? error.message : String(error),\r\n                state: this.circuitBreaker.getState(),\r\n            });\r\n            throw error;\r\n        }\r\n    }\r\n}\r\n","import { config } from \"dotenv\";\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport elizaLogger from \"./logger.ts\";\r\n\r\nelizaLogger.info(\"Loading embedding settings:\", {\r\n    USE_OPENAI_EMBEDDING: process.env.USE_OPENAI_EMBEDDING,\r\n    USE_OLLAMA_EMBEDDING: process.env.USE_OLLAMA_EMBEDDING,\r\n    OLLAMA_EMBEDDING_MODEL:\r\n        process.env.OLLAMA_EMBEDDING_MODEL || \"mxbai-embed-large\",\r\n});\r\n\r\n// Add this logging block\r\nelizaLogger.debug(\"Loading character settings:\", {\r\n    CHARACTER_PATH: process.env.CHARACTER_PATH,\r\n    ARGV: process.argv,\r\n    CHARACTER_ARG: process.argv.find((arg) => arg.startsWith(\"--character=\")),\r\n    CWD: process.cwd(),\r\n});\r\n\r\ninterface Settings {\r\n    [key: string]: string | undefined;\r\n}\r\n\r\ninterface NamespacedSettings {\r\n    [namespace: string]: Settings;\r\n}\r\n\r\nlet environmentSettings: Settings = {};\r\n\r\n/**\r\n * Determines if code is running in a browser environment\r\n * @returns {boolean} True if in browser environment\r\n */\r\nconst isBrowser = (): boolean => {\r\n    return (\r\n        typeof window !== \"undefined\" && typeof window.document !== \"undefined\"\r\n    );\r\n};\r\n\r\n/**\r\n * Recursively searches for a .env file starting from the current directory\r\n * and moving up through parent directories (Node.js only)\r\n * @param {string} [startDir=process.cwd()] - Starting directory for the search\r\n * @returns {string|null} Path to the nearest .env file or null if not found\r\n */\r\nexport function findNearestEnvFile(startDir = process.cwd()) {\r\n    if (isBrowser()) return null;\r\n\r\n    let currentDir = startDir;\r\n\r\n    // Continue searching until we reach the root directory\r\n    while (currentDir !== path.parse(currentDir).root) {\r\n        const envPath = path.join(currentDir, \".env\");\r\n\r\n        if (fs.existsSync(envPath)) {\r\n            return envPath;\r\n        }\r\n\r\n        // Move up to parent directory\r\n        currentDir = path.dirname(currentDir);\r\n    }\r\n\r\n    // Check root directory as well\r\n    const rootEnvPath = path.join(path.parse(currentDir).root, \".env\");\r\n    return fs.existsSync(rootEnvPath) ? rootEnvPath : null;\r\n}\r\n\r\n/**\r\n * Configures environment settings for browser usage\r\n * @param {Settings} settings - Object containing environment variables\r\n */\r\nexport function configureSettings(settings: Settings) {\r\n    environmentSettings = { ...settings };\r\n}\r\n\r\n/**\r\n * Loads environment variables from the nearest .env file in Node.js\r\n * or returns configured settings in browser\r\n * @returns {Settings} Environment variables object\r\n * @throws {Error} If no .env file is found in Node.js environment\r\n */\r\nexport function loadEnvConfig(): Settings {\r\n    // For browser environments, return the configured settings\r\n    if (isBrowser()) {\r\n        return environmentSettings;\r\n    }\r\n\r\n    // Node.js environment: load from .env file\r\n    const envPath = findNearestEnvFile();\r\n\r\n    // attempt to Load the .env file into process.env\r\n    const result = config(envPath ? { path: envPath } : {});\r\n\r\n    if (!result.error) {\r\n        elizaLogger.log(`Loaded .env file from: ${envPath}`);\r\n    }\r\n\r\n    // Parse namespaced settings\r\n    const namespacedSettings = parseNamespacedSettings(process.env as Settings);\r\n\r\n    // Attach to process.env for backward compatibility\r\n    Object.entries(namespacedSettings).forEach(([namespace, settings]) => {\r\n        process.env[`__namespaced_${namespace}`] = JSON.stringify(settings);\r\n    });\r\n\r\n    return process.env as Settings;\r\n}\r\n\r\n/**\r\n * Gets a specific environment variable\r\n * @param {string} key - The environment variable key\r\n * @param {string} [defaultValue] - Optional default value if key doesn't exist\r\n * @returns {string|undefined} The environment variable value or default value\r\n */\r\nexport function getEnvVariable(\r\n    key: string,\r\n    defaultValue?: string\r\n): string | undefined {\r\n    if (isBrowser()) {\r\n        return environmentSettings[key] || defaultValue;\r\n    }\r\n    return process.env[key] || defaultValue;\r\n}\r\n\r\n/**\r\n * Checks if a specific environment variable exists\r\n * @param {string} key - The environment variable key\r\n * @returns {boolean} True if the environment variable exists\r\n */\r\nexport function hasEnvVariable(key: string): boolean {\r\n    if (isBrowser()) {\r\n        return key in environmentSettings;\r\n    }\r\n    return key in process.env;\r\n}\r\n\r\n// Initialize settings based on environment\r\nexport const settings = isBrowser() ? environmentSettings : loadEnvConfig();\r\n\r\nelizaLogger.info(\"Parsed settings:\", {\r\n    USE_OPENAI_EMBEDDING: settings.USE_OPENAI_EMBEDDING,\r\n    USE_OPENAI_EMBEDDING_TYPE: typeof settings.USE_OPENAI_EMBEDDING,\r\n    USE_OLLAMA_EMBEDDING: settings.USE_OLLAMA_EMBEDDING,\r\n    USE_OLLAMA_EMBEDDING_TYPE: typeof settings.USE_OLLAMA_EMBEDDING,\r\n    OLLAMA_EMBEDDING_MODEL:\r\n        settings.OLLAMA_EMBEDDING_MODEL || \"mxbai-embed-large\",\r\n});\r\n\r\nexport default settings;\r\n\r\n// Add this function to parse namespaced settings\r\nfunction parseNamespacedSettings(env: Settings): NamespacedSettings {\r\n    const namespaced: NamespacedSettings = {};\r\n\r\n    for (const [key, value] of Object.entries(env)) {\r\n        if (!value) continue;\r\n\r\n        const [namespace, ...rest] = key.split(\".\");\r\n        if (!namespace || rest.length === 0) continue;\r\n\r\n        const settingKey = rest.join(\".\");\r\n        namespaced[namespace] = namespaced[namespace] || {};\r\n        namespaced[namespace][settingKey] = value;\r\n    }\r\n\r\n    return namespaced;\r\n}\r\n","import type { Readable } from \"stream\";\r\n\r\n/**\r\n * Represents a UUID string in the format \"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\"\r\n */\r\nexport type UUID = `${string}-${string}-${string}-${string}-${string}`;\r\n\r\n/**\r\n * Represents the content of a message or communication\r\n */\r\nexport interface Content {\r\n    /** The main text content */\r\n    text: string;\r\n\r\n    /** Optional action associated with the message */\r\n    action?: string;\r\n\r\n    /** Optional source/origin of the content */\r\n    source?: string;\r\n\r\n    /** URL of the original message/post (e.g. tweet URL, Discord message link) */\r\n    url?: string;\r\n\r\n    /** UUID of parent message if this is a reply/thread */\r\n    inReplyTo?: UUID;\r\n\r\n    /** Array of media attachments */\r\n    attachments?: Media[];\r\n\r\n    /** Additional dynamic properties */\r\n    [key: string]: unknown;\r\n}\r\n\r\n/**\r\n * Example content with associated user for demonstration purposes\r\n */\r\nexport interface ActionExample {\r\n    /** User associated with the example */\r\n    user: string;\r\n\r\n    /** Content of the example */\r\n    content: Content;\r\n}\r\n\r\n/**\r\n * Example conversation content with user ID\r\n */\r\nexport interface ConversationExample {\r\n    /** UUID of user in conversation */\r\n    userId: UUID;\r\n\r\n    /** Content of the conversation */\r\n    content: Content;\r\n}\r\n\r\n/**\r\n * Represents an actor/participant in a conversation\r\n */\r\nexport interface Actor {\r\n    /** Display name */\r\n    name: string;\r\n\r\n    /** Username/handle */\r\n    username: string;\r\n\r\n    /** Additional profile details */\r\n    details: {\r\n        /** Short profile tagline */\r\n        tagline: string;\r\n\r\n        /** Longer profile summary */\r\n        summary: string;\r\n\r\n        /** Favorite quote */\r\n        quote: string;\r\n    };\r\n\r\n    /** Unique identifier */\r\n    id: UUID;\r\n}\r\n\r\n/**\r\n * Represents a single objective within a goal\r\n */\r\nexport interface Objective {\r\n    /** Optional unique identifier */\r\n    id?: string;\r\n\r\n    /** Description of what needs to be achieved */\r\n    description: string;\r\n\r\n    /** Whether objective is completed */\r\n    completed: boolean;\r\n}\r\n\r\n/**\r\n * Status enum for goals\r\n */\r\nexport enum GoalStatus {\r\n    DONE = \"DONE\",\r\n    FAILED = \"FAILED\",\r\n    IN_PROGRESS = \"IN_PROGRESS\",\r\n}\r\n\r\n/**\r\n * Represents a high-level goal composed of objectives\r\n */\r\nexport interface Goal {\r\n    /** Optional unique identifier */\r\n    id?: UUID;\r\n\r\n    /** Room ID where goal exists */\r\n    roomId: UUID;\r\n\r\n    /** User ID of goal owner */\r\n    userId: UUID;\r\n\r\n    /** Name/title of the goal */\r\n    name: string;\r\n\r\n    /** Current status */\r\n    status: GoalStatus;\r\n\r\n    /** Component objectives */\r\n    objectives: Objective[];\r\n}\r\n\r\n/**\r\n * Model size/type classification\r\n */\r\nexport enum ModelClass {\r\n    SMALL = \"small\",\r\n    MEDIUM = \"medium\",\r\n    LARGE = \"large\",\r\n    EMBEDDING = \"embedding\",\r\n    IMAGE = \"image\",\r\n}\r\n\r\n/**\r\n * Model settings\r\n */\r\nexport type ModelSettings = {\r\n    /** Model name */\r\n    name: string;\r\n\r\n    /** Maximum input tokens */\r\n    maxInputTokens: number;\r\n\r\n    /** Maximum output tokens */\r\n    maxOutputTokens: number;\r\n\r\n    /** Optional frequency penalty */\r\n    frequency_penalty?: number;\r\n\r\n    /** Optional presence penalty */\r\n    presence_penalty?: number;\r\n\r\n    /** Optional repetition penalty */\r\n    repetition_penalty?: number;\r\n\r\n    /** Stop sequences */\r\n    stop: string[];\r\n\r\n    /** Temperature setting */\r\n    temperature: number;\r\n\r\n    /** Optional telemetry configuration (experimental) */\r\n    experimental_telemetry?: TelemetrySettings;\r\n};\r\n\r\n/** Image model settings */\r\nexport type ImageModelSettings = {\r\n    name: string;\r\n    steps?: number;\r\n};\r\n\r\n/** Embedding model settings */\r\nexport type EmbeddingModelSettings = {\r\n    name: string;\r\n    dimensions?: number;\r\n};\r\n\r\n/**\r\n * Configuration for an AI model\r\n */\r\nexport type Model = {\r\n    /** Optional API endpoint */\r\n    endpoint?: string;\r\n\r\n    /** Model names by size class */\r\n    model: {\r\n        [ModelClass.SMALL]?: ModelSettings;\r\n        [ModelClass.MEDIUM]?: ModelSettings;\r\n        [ModelClass.LARGE]?: ModelSettings;\r\n        [ModelClass.EMBEDDING]?: EmbeddingModelSettings;\r\n        [ModelClass.IMAGE]?: ImageModelSettings;\r\n    };\r\n};\r\n\r\n/**\r\n * Model configurations by provider\r\n */\r\nexport type Models = {\r\n    [ModelProviderName.OPENAI]: Model;\r\n    [ModelProviderName.ETERNALAI]: Model;\r\n    [ModelProviderName.ANTHROPIC]: Model;\r\n    [ModelProviderName.GROK]: Model;\r\n    [ModelProviderName.GROQ]: Model;\r\n    [ModelProviderName.LLAMACLOUD]: Model;\r\n    [ModelProviderName.TOGETHER]: Model;\r\n    [ModelProviderName.LLAMALOCAL]: Model;\r\n    [ModelProviderName.LMSTUDIO]: Model;\r\n    [ModelProviderName.GOOGLE]: Model;\r\n    [ModelProviderName.MISTRAL]: Model;\r\n    [ModelProviderName.CLAUDE_VERTEX]: Model;\r\n    [ModelProviderName.REDPILL]: Model;\r\n    [ModelProviderName.OPENROUTER]: Model;\r\n    [ModelProviderName.AIMLAPI]: Model;\r\n    [ModelProviderName.OLLAMA]: Model;\r\n    [ModelProviderName.HEURIST]: Model;\r\n    [ModelProviderName.GALADRIEL]: Model;\r\n    [ModelProviderName.FAL]: Model;\r\n    [ModelProviderName.GAIANET]: Model;\r\n    [ModelProviderName.ALI_BAILIAN]: Model;\r\n    [ModelProviderName.VOLENGINE]: Model;\r\n    [ModelProviderName.NANOGPT]: Model;\r\n    [ModelProviderName.HYPERBOLIC]: Model;\r\n    [ModelProviderName.VENICE]: Model;\r\n    [ModelProviderName.NVIDIA]: Model;\r\n    [ModelProviderName.NINETEEN_AI]: Model;\r\n    [ModelProviderName.AKASH_CHAT_API]: Model;\r\n    [ModelProviderName.LIVEPEER]: Model;\r\n    [ModelProviderName.DEEPSEEK]: Model;\r\n    [ModelProviderName.INFERA]: Model;\r\n    [ModelProviderName.BEDROCK]: Model;\r\n    [ModelProviderName.ATOMA]: Model;\r\n    [ModelProviderName.SECRETAI]: Model;\r\n    [ModelProviderName.NEARAI]: Model;\r\n    [ModelProviderName.KLUSTERAI]: Model;\r\n    [ModelProviderName.MEM0]: Model;\r\n};\r\n\r\n/**\r\n * Available model providers\r\n */\r\nexport enum ModelProviderName {\r\n    OPENAI = \"openai\",\r\n    ETERNALAI = \"eternalai\",\r\n    ANTHROPIC = \"anthropic\",\r\n    GROK = \"grok\",\r\n    GROQ = \"groq\",\r\n    LLAMACLOUD = \"llama_cloud\",\r\n    TOGETHER = \"together\",\r\n    LLAMALOCAL = \"llama_local\",\r\n    LMSTUDIO = \"lmstudio\",\r\n    GOOGLE = \"google\",\r\n    MISTRAL = \"mistral\",\r\n    CLAUDE_VERTEX = \"claude_vertex\",\r\n    REDPILL = \"redpill\",\r\n    OPENROUTER = \"openrouter\",\r\n    AIMLAPI = \"aimlapi\",\r\n    OLLAMA = \"ollama\",\r\n    HEURIST = \"heurist\",\r\n    GALADRIEL = \"galadriel\",\r\n    FAL = \"falai\",\r\n    GAIANET = \"gaianet\",\r\n    ALI_BAILIAN = \"ali_bailian\",\r\n    VOLENGINE = \"volengine\",\r\n    NANOGPT = \"nanogpt\",\r\n    HYPERBOLIC = \"hyperbolic\",\r\n    VENICE = \"venice\",\r\n    NVIDIA = \"nvidia\",\r\n    NINETEEN_AI = \"nineteen_ai\",\r\n    AKASH_CHAT_API = \"akash_chat_api\",\r\n    LIVEPEER = \"livepeer\",\r\n    LETZAI = \"letzai\",\r\n    DEEPSEEK = \"deepseek\",\r\n    INFERA = \"infera\",\r\n    BEDROCK = \"bedrock\",\r\n    ATOMA = \"atoma\",\r\n    SECRETAI = \"secret_ai\",\r\n    NEARAI = \"nearai\",\r\n    KLUSTERAI = \"kluster_ai\",\r\n    MEM0 = \"mem0\",\r\n}\r\n\r\n/**\r\n * Represents the current state/context of a conversation\r\n */\r\nexport interface State {\r\n    /** ID of user who sent current message */\r\n    userId?: UUID;\r\n\r\n    /** ID of agent in conversation */\r\n    agentId?: UUID;\r\n\r\n    /** Agent's biography */\r\n    bio: string;\r\n\r\n    /** Agent's background lore */\r\n    lore: string;\r\n\r\n    /** Message handling directions */\r\n    messageDirections: string;\r\n\r\n    /** Post handling directions */\r\n    postDirections: string;\r\n\r\n    /** Current room/conversation ID */\r\n    roomId: UUID;\r\n\r\n    /** Optional agent name */\r\n    agentName?: string;\r\n\r\n    /** Optional message sender name */\r\n    senderName?: string;\r\n\r\n    /** String representation of conversation actors */\r\n    actors: string;\r\n\r\n    /** Optional array of actor objects */\r\n    actorsData?: Actor[];\r\n\r\n    /** Optional string representation of goals */\r\n    goals?: string;\r\n\r\n    /** Optional array of goal objects */\r\n    goalsData?: Goal[];\r\n\r\n    /** Recent message history as string */\r\n    recentMessages: string;\r\n\r\n    /** Recent message objects */\r\n    recentMessagesData: Memory[];\r\n\r\n    /** Optional valid action names */\r\n    actionNames?: string;\r\n\r\n    /** Optional action descriptions */\r\n    actions?: string;\r\n\r\n    /** Optional action objects */\r\n    actionsData?: Action[];\r\n\r\n    /** Optional action examples */\r\n    actionExamples?: string;\r\n\r\n    /** Optional provider descriptions */\r\n    providers?: string;\r\n\r\n    /** Optional response content */\r\n    responseData?: Content;\r\n\r\n    /** Optional recent interaction objects */\r\n    recentInteractionsData?: Memory[];\r\n\r\n    /** Optional recent interactions string */\r\n    recentInteractions?: string;\r\n\r\n    /** Optional formatted conversation */\r\n    formattedConversation?: string;\r\n\r\n    /** Optional formatted knowledge */\r\n    knowledge?: string;\r\n    /** Optional knowledge data */\r\n    knowledgeData?: KnowledgeItem[];\r\n    /** Optional knowledge data */\r\n    ragKnowledgeData?: RAGKnowledgeItem[];\r\n\r\n    /** Additional dynamic properties */\r\n    [key: string]: unknown;\r\n}\r\n\r\n/**\r\n * Represents a stored memory/message\r\n */\r\nexport interface Memory {\r\n    /** Optional unique identifier */\r\n    id?: UUID;\r\n\r\n    /** Associated user ID */\r\n    userId: UUID;\r\n\r\n    /** Associated agent ID */\r\n    agentId: UUID;\r\n\r\n    /** Optional creation timestamp */\r\n    createdAt?: number;\r\n\r\n    /** Memory content */\r\n    content: Content;\r\n\r\n    /** Optional embedding vector */\r\n    embedding?: number[];\r\n\r\n    /** Associated room ID */\r\n    roomId: UUID;\r\n\r\n    /** Whether memory is unique */\r\n    unique?: boolean;\r\n\r\n    /** Embedding similarity score */\r\n    similarity?: number;\r\n}\r\n\r\n/**\r\n * Example message for demonstration\r\n */\r\nexport interface MessageExample {\r\n    /** Associated user */\r\n    user: string;\r\n\r\n    /** Message content */\r\n    content: Content;\r\n}\r\n\r\n/**\r\n * Handler function type for processing messages\r\n */\r\nexport type Handler = (\r\n    runtime: IAgentRuntime,\r\n    message: Memory,\r\n    state?: State,\r\n    options?: { [key: string]: unknown },\r\n    callback?: HandlerCallback,\r\n) => Promise<unknown>;\r\n\r\n/**\r\n * Callback function type for handlers\r\n */\r\nexport type HandlerCallback = (\r\n    response: Content,\r\n    files?: any,\r\n) => Promise<Memory[]>;\r\n\r\n/**\r\n * Validator function type for actions/evaluators\r\n */\r\nexport type Validator = (\r\n    runtime: IAgentRuntime,\r\n    message: Memory,\r\n    state?: State,\r\n) => Promise<boolean>;\r\n\r\n/**\r\n * Represents an action the agent can perform\r\n */\r\nexport interface Action {\r\n    /** Similar action descriptions */\r\n    similes: string[];\r\n\r\n    /** Detailed description */\r\n    description: string;\r\n\r\n    /** Example usages */\r\n    examples: ActionExample[][];\r\n\r\n    /** Handler function */\r\n    handler: Handler;\r\n\r\n    /** Action name */\r\n    name: string;\r\n\r\n    /** Validation function */\r\n    validate: Validator;\r\n\r\n    /** Whether to suppress the initial message when this action is used */\r\n    suppressInitialMessage?: boolean;\r\n}\r\n\r\n/**\r\n * Example for evaluating agent behavior\r\n */\r\nexport interface EvaluationExample {\r\n    /** Evaluation context */\r\n    context: string;\r\n\r\n    /** Example messages */\r\n    messages: Array<ActionExample>;\r\n\r\n    /** Expected outcome */\r\n    outcome: string;\r\n}\r\n\r\n/**\r\n * Evaluator for assessing agent responses\r\n */\r\nexport interface Evaluator {\r\n    /** Whether to always run */\r\n    alwaysRun?: boolean;\r\n\r\n    /** Detailed description */\r\n    description: string;\r\n\r\n    /** Similar evaluator descriptions */\r\n    similes: string[];\r\n\r\n    /** Example evaluations */\r\n    examples: EvaluationExample[];\r\n\r\n    /** Handler function */\r\n    handler: Handler;\r\n\r\n    /** Evaluator name */\r\n    name: string;\r\n\r\n    /** Validation function */\r\n    validate: Validator;\r\n}\r\n\r\n/**\r\n * Provider for external data/services\r\n */\r\nexport interface Provider {\r\n    /** Data retrieval function */\r\n    get: (\r\n        runtime: IAgentRuntime,\r\n        message: Memory,\r\n        state?: State,\r\n    ) => Promise<any>;\r\n}\r\n\r\n/**\r\n * Represents a relationship between users\r\n */\r\nexport interface Relationship {\r\n    /** Unique identifier */\r\n    id: UUID;\r\n\r\n    /** First user ID */\r\n    userA: UUID;\r\n\r\n    /** Second user ID */\r\n    userB: UUID;\r\n\r\n    /** Primary user ID */\r\n    userId: UUID;\r\n\r\n    /** Associated room ID */\r\n    roomId: UUID;\r\n\r\n    /** Relationship status */\r\n    status: string;\r\n\r\n    /** Optional creation timestamp */\r\n    createdAt?: string;\r\n}\r\n\r\n/**\r\n * Represents a user account\r\n */\r\nexport interface Account {\r\n    /** Unique identifier */\r\n    id: UUID;\r\n\r\n    /** Display name */\r\n    name: string;\r\n\r\n    /** Username */\r\n    username: string;\r\n\r\n    /** Optional additional details */\r\n    details?: { [key: string]: any };\r\n\r\n    /** Optional email */\r\n    email?: string;\r\n\r\n    /** Optional avatar URL */\r\n    avatarUrl?: string;\r\n}\r\n\r\n/**\r\n * Room participant with account details\r\n */\r\nexport interface Participant {\r\n    /** Unique identifier */\r\n    id: UUID;\r\n\r\n    /** Associated account */\r\n    account: Account;\r\n}\r\n\r\n/**\r\n * Represents a conversation room\r\n */\r\nexport interface Room {\r\n    /** Unique identifier */\r\n    id: UUID;\r\n\r\n    /** Room participants */\r\n    participants: Participant[];\r\n}\r\n\r\n/**\r\n * Represents a media attachment\r\n */\r\nexport type Media = {\r\n    /** Unique identifier */\r\n    id: string;\r\n\r\n    /** Media URL */\r\n    url: string;\r\n\r\n    /** Media title */\r\n    title: string;\r\n\r\n    /** Media source */\r\n    source: string;\r\n\r\n    /** Media description */\r\n    description: string;\r\n\r\n    /** Text content */\r\n    text: string;\r\n\r\n    /** Content type */\r\n    contentType?: string;\r\n};\r\n\r\n/**\r\n * Client instance\r\n */\r\nexport type ClientInstance = {\r\n    /** Client name */\r\n    // name: string;\r\n\r\n    /** Stop client connection */\r\n    stop: (runtime: IAgentRuntime) => Promise<unknown>;\r\n};\r\n\r\n/**\r\n * Client interface for platform connections\r\n */\r\nexport type Client = {\r\n    /** Client name */\r\n    name: string;\r\n\r\n    /** Client configuration */\r\n    config?: { [key: string]: any };\r\n\r\n    /** Start client connection */\r\n    start: (runtime: IAgentRuntime) => Promise<ClientInstance>;\r\n};\r\n\r\n/**\r\n * Database adapter initialization\r\n */\r\nexport type Adapter = {\r\n    /** Initialize the adapter */\r\n    init: (runtime: IAgentRuntime) => IDatabaseAdapter & IDatabaseCacheAdapter;\r\n};\r\n\r\n/**\r\n * Plugin for extending agent functionality\r\n */\r\nexport type Plugin = {\r\n    /** Plugin name */\r\n    name: string;\r\n\r\n    /** Plugin npm name */\r\n    npmName?: string;\r\n\r\n    /** Plugin configuration */\r\n    config?: { [key: string]: any };\r\n\r\n    /** Plugin description */\r\n    description: string;\r\n\r\n    /** Optional actions */\r\n    actions?: Action[];\r\n\r\n    /** Optional providers */\r\n    providers?: Provider[];\r\n\r\n    /** Optional evaluators */\r\n    evaluators?: Evaluator[];\r\n\r\n    /** Optional services */\r\n    services?: Service[];\r\n\r\n    /** Optional clients */\r\n    clients?: Client[];\r\n\r\n    /** Optional adapters */\r\n    adapters?: Adapter[];\r\n\r\n    /** Optional post character processor handler */\r\n    handlePostCharacterLoaded?: (char: Character) => Promise<Character>;\r\n};\r\n\r\nexport interface IAgentConfig {\r\n    [key: string]: string;\r\n}\r\n\r\nexport type TelemetrySettings = {\r\n    /**\r\n     * Enable or disable telemetry. Disabled by default while experimental.\r\n     */\r\n    isEnabled?: boolean;\r\n    /**\r\n     * Enable or disable input recording. Enabled by default.\r\n     *\r\n     * You might want to disable input recording to avoid recording sensitive\r\n     * information, to reduce data transfers, or to increase performance.\r\n     */\r\n    recordInputs?: boolean;\r\n    /**\r\n     * Enable or disable output recording. Enabled by default.\r\n     *\r\n     * You might want to disable output recording to avoid recording sensitive\r\n     * information, to reduce data transfers, or to increase performance.\r\n     */\r\n    recordOutputs?: boolean;\r\n    /**\r\n     * Identifier for this function. Used to group telemetry data by function.\r\n     */\r\n    functionId?: string;\r\n};\r\n\r\nexport interface ModelConfiguration {\r\n    temperature?: number;\r\n    maxOutputTokens?: number;\r\n    frequency_penalty?: number;\r\n    presence_penalty?: number;\r\n    maxInputTokens?: number;\r\n    experimental_telemetry?: TelemetrySettings;\r\n}\r\n\r\nexport type TemplateType = string | ((options: { state: State }) => string);\r\n\r\n/**\r\n * Configuration for an agent character\r\n */\r\nexport type Character = {\r\n    /** Optional unique identifier */\r\n    id?: UUID;\r\n\r\n    /** Character name */\r\n    name: string;\r\n\r\n    /** Optional username */\r\n    username?: string;\r\n\r\n    /** Optional email */\r\n    email?: string;\r\n\r\n    /** Optional system prompt */\r\n    system?: string;\r\n\r\n    /** Model provider to use */\r\n    modelProvider: ModelProviderName;\r\n\r\n    /** Image model provider to use, if different from modelProvider */\r\n    imageModelProvider?: ModelProviderName;\r\n\r\n    /** Image Vision model provider to use, if different from modelProvider */\r\n    imageVisionModelProvider?: ModelProviderName;\r\n\r\n    /** Optional model endpoint override */\r\n    modelEndpointOverride?: string;\r\n\r\n    /** Optional prompt templates */\r\n    templates?: {\r\n        goalsTemplate?: TemplateType;\r\n        factsTemplate?: TemplateType;\r\n        messageHandlerTemplate?: TemplateType;\r\n        shouldRespondTemplate?: TemplateType;\r\n        continueMessageHandlerTemplate?: TemplateType;\r\n        evaluationTemplate?: TemplateType;\r\n        twitterSearchTemplate?: TemplateType;\r\n        twitterActionTemplate?: TemplateType;\r\n        twitterPostTemplate?: TemplateType;\r\n        twitterMessageHandlerTemplate?: TemplateType;\r\n        twitterShouldRespondTemplate?: TemplateType;\r\n        twitterVoiceHandlerTemplate?: TemplateType;\r\n        instagramPostTemplate?: TemplateType;\r\n        instagramMessageHandlerTemplate?: TemplateType;\r\n        instagramShouldRespondTemplate?: TemplateType;\r\n        farcasterPostTemplate?: TemplateType;\r\n        lensPostTemplate?: TemplateType;\r\n        farcasterMessageHandlerTemplate?: TemplateType;\r\n        lensMessageHandlerTemplate?: TemplateType;\r\n        farcasterShouldRespondTemplate?: TemplateType;\r\n        lensShouldRespondTemplate?: TemplateType;\r\n        telegramMessageHandlerTemplate?: TemplateType;\r\n        telegramShouldRespondTemplate?: TemplateType;\r\n        telegramAutoPostTemplate?: string;\r\n        telegramPinnedMessageTemplate?: string;\r\n        discordAutoPostTemplate?: string;\r\n        discordAnnouncementHypeTemplate?: string;\r\n        discordVoiceHandlerTemplate?: TemplateType;\r\n        discordShouldRespondTemplate?: TemplateType;\r\n        discordMessageHandlerTemplate?: TemplateType;\r\n        slackMessageHandlerTemplate?: TemplateType;\r\n        slackShouldRespondTemplate?: TemplateType;\r\n        jeeterPostTemplate?: string;\r\n        jeeterSearchTemplate?: string;\r\n        jeeterInteractionTemplate?: string;\r\n        jeeterMessageHandlerTemplate?: string;\r\n        jeeterShouldRespondTemplate?: string;\r\n        devaPostTemplate?: string;\r\n    };\r\n\r\n    /** Character biography */\r\n    bio: string | string[];\r\n\r\n    /** Character background lore */\r\n    lore: string[];\r\n\r\n    /** Example messages */\r\n    messageExamples: MessageExample[][];\r\n\r\n    /** Example posts */\r\n    postExamples: string[];\r\n\r\n    /** Known topics */\r\n    topics: string[];\r\n\r\n    /** Character traits */\r\n    adjectives: string[];\r\n\r\n    /** Optional knowledge base */\r\n    knowledge?: (string | { path: string; shared?: boolean } | { directory: string; shared?: boolean })[];\r\n\r\n    /** Available plugins */\r\n    plugins: Plugin[];\r\n\r\n    /** Character Processor Plugins */\r\n    postProcessors?: Pick<Plugin, 'name' | 'description' | 'handlePostCharacterLoaded'>[];\r\n\r\n    /** Optional configuration */\r\n    settings?: {\r\n        secrets?: { [key: string]: string };\r\n        intiface?: boolean;\r\n        imageSettings?: {\r\n            steps?: number;\r\n            width?: number;\r\n            height?: number;\r\n            cfgScale?: number;\r\n            negativePrompt?: string;\r\n            numIterations?: number;\r\n            guidanceScale?: number;\r\n            seed?: number;\r\n            modelId?: string;\r\n            jobId?: string;\r\n            count?: number;\r\n            stylePreset?: string;\r\n            hideWatermark?: boolean;\r\n            safeMode?: boolean;\r\n        };\r\n        voice?: {\r\n            model?: string; // For VITS\r\n            url?: string; // Legacy VITS support\r\n            elevenlabs?: {\r\n                // New structured ElevenLabs config\r\n                voiceId: string;\r\n                model?: string;\r\n                stability?: string;\r\n                similarityBoost?: string;\r\n                style?: string;\r\n                useSpeakerBoost?: string;\r\n            };\r\n        };\r\n        model?: string;\r\n        modelConfig?: ModelConfiguration;\r\n        embeddingModel?: string;\r\n        chains?: {\r\n            evm?: any[];\r\n            solana?: any[];\r\n            [key: string]: any[];\r\n        };\r\n        transcription?: TranscriptionProvider;\r\n        ragKnowledge?: boolean;\r\n    };\r\n\r\n    /** Optional client-specific config */\r\n    clientConfig?: {\r\n        discord?: {\r\n            shouldIgnoreBotMessages?: boolean;\r\n            shouldIgnoreDirectMessages?: boolean;\r\n            shouldRespondOnlyToMentions?: boolean;\r\n            messageSimilarityThreshold?: number;\r\n            isPartOfTeam?: boolean;\r\n            teamAgentIds?: string[];\r\n            teamLeaderId?: string;\r\n            teamMemberInterestKeywords?: string[];\r\n            allowedChannelIds?: string[];\r\n            autoPost?: {\r\n                enabled?: boolean;\r\n                monitorTime?: number;\r\n                inactivityThreshold?: number;\r\n                mainChannelId?: string;\r\n                announcementChannelIds?: string[];\r\n                minTimeBetweenPosts?: number;\r\n            };\r\n        };\r\n        telegram?: {\r\n            shouldIgnoreBotMessages?: boolean;\r\n            shouldIgnoreDirectMessages?: boolean;\r\n            shouldRespondOnlyToMentions?: boolean;\r\n            shouldOnlyJoinInAllowedGroups?: boolean;\r\n            allowedGroupIds?: string[];\r\n            messageSimilarityThreshold?: number;\r\n            isPartOfTeam?: boolean;\r\n            teamAgentIds?: string[];\r\n            teamLeaderId?: string;\r\n            teamMemberInterestKeywords?: string[];\r\n            autoPost?: {\r\n                enabled?: boolean;\r\n                monitorTime?: number;\r\n                inactivityThreshold?: number;\r\n                mainChannelId?: string;\r\n                pinnedMessagesGroups?: string[];\r\n                minTimeBetweenPosts?: number;\r\n            };\r\n        };\r\n        slack?: {\r\n            shouldIgnoreBotMessages?: boolean;\r\n            shouldIgnoreDirectMessages?: boolean;\r\n        };\r\n        gitbook?: {\r\n            keywords?: {\r\n                projectTerms?: string[];\r\n                generalQueries?: string[];\r\n            };\r\n            documentTriggers?: string[];\r\n        };\r\n    };\r\n\r\n    /** Writing style guides */\r\n    style: {\r\n        all: string[];\r\n        chat: string[];\r\n        post: string[];\r\n    };\r\n\r\n    /** Optional Twitter profile */\r\n    twitterProfile?: {\r\n        id: string;\r\n        username: string;\r\n        screenName: string;\r\n        bio: string;\r\n        nicknames?: string[];\r\n    };\r\n\r\n    /** Optional Instagram profile */\r\n    instagramProfile?: {\r\n        id: string;\r\n        username: string;\r\n        bio: string;\r\n        nicknames?: string[];\r\n    };\r\n\r\n    /** Optional SimsAI profile */\r\n    simsaiProfile?: {\r\n        id: string;\r\n        username: string;\r\n        screenName: string;\r\n        bio: string;\r\n    };\r\n\r\n    /** Optional NFT prompt */\r\n    nft?: {\r\n        prompt: string;\r\n    };\r\n\r\n    /**Optinal Parent characters to inherit information from */\r\n    extends?: string[];\r\n\r\n    twitterSpaces?: TwitterSpaceDecisionOptions;\r\n};\r\n\r\nexport interface TwitterSpaceDecisionOptions {\r\n    maxSpeakers?: number;\r\n    topics?: string[];\r\n    typicalDurationMinutes?: number;\r\n    idleKickTimeoutMs?: number;\r\n    minIntervalBetweenSpacesMinutes?: number;\r\n    businessHoursOnly?: boolean;\r\n    randomChance?: number;\r\n    enableIdleMonitor?: boolean;\r\n    enableSttTts?: boolean;\r\n    enableRecording?: boolean;\r\n    voiceId?: string;\r\n    sttLanguage?: string;\r\n    speakerMaxDurationMs?: number;\r\n}\r\n\r\n/**\r\n * Interface for database operations\r\n */\r\nexport interface IDatabaseAdapter {\r\n    /** Database instance */\r\n    db: any;\r\n\r\n    /** Optional initialization */\r\n    init(): Promise<void>;\r\n\r\n    /** Close database connection */\r\n    close(): Promise<void>;\r\n\r\n    /** Get account by ID */\r\n    getAccountById(userId: UUID): Promise<Account | null>;\r\n\r\n    /** Create new account */\r\n    createAccount(account: Account): Promise<boolean>;\r\n\r\n    /** Get memories matching criteria */\r\n    getMemories(params: {\r\n        roomId: UUID;\r\n        count?: number;\r\n        unique?: boolean;\r\n        tableName: string;\r\n        agentId: UUID;\r\n        start?: number;\r\n        end?: number;\r\n    }): Promise<Memory[]>;\r\n\r\n    getMemoryById(id: UUID): Promise<Memory | null>;\r\n\r\n    getMemoriesByIds(ids: UUID[], tableName?: string): Promise<Memory[]>;\r\n\r\n    getMemoriesByRoomIds(params: {\r\n        tableName: string;\r\n        agentId: UUID;\r\n        roomIds: UUID[];\r\n        limit?: number;\r\n    }): Promise<Memory[]>;\r\n\r\n    getCachedEmbeddings(params: {\r\n        query_table_name: string;\r\n        query_threshold: number;\r\n        query_input: string;\r\n        query_field_name: string;\r\n        query_field_sub_name: string;\r\n        query_match_count: number;\r\n    }): Promise<{ embedding: number[]; levenshtein_score: number }[]>;\r\n\r\n    log(params: {\r\n        body: { [key: string]: unknown };\r\n        userId: UUID;\r\n        roomId: UUID;\r\n        type: string;\r\n    }): Promise<void>;\r\n\r\n    getActorDetails(params: { roomId: UUID }): Promise<Actor[]>;\r\n\r\n    searchMemories(params: {\r\n        tableName: string;\r\n        agentId: UUID;\r\n        roomId: UUID;\r\n        embedding: number[];\r\n        match_threshold: number;\r\n        match_count: number;\r\n        unique: boolean;\r\n    }): Promise<Memory[]>;\r\n\r\n    updateGoalStatus(params: {\r\n        goalId: UUID;\r\n        status: GoalStatus;\r\n    }): Promise<void>;\r\n\r\n    searchMemoriesByEmbedding(\r\n        embedding: number[],\r\n        params: {\r\n            match_threshold?: number;\r\n            count?: number;\r\n            roomId?: UUID;\r\n            agentId?: UUID;\r\n            unique?: boolean;\r\n            tableName: string;\r\n        },\r\n    ): Promise<Memory[]>;\r\n\r\n    createMemory(\r\n        memory: Memory,\r\n        tableName: string,\r\n        unique?: boolean,\r\n    ): Promise<void>;\r\n\r\n    removeMemory(memoryId: UUID, tableName: string): Promise<void>;\r\n\r\n    removeAllMemories(roomId: UUID, tableName: string): Promise<void>;\r\n\r\n    countMemories(\r\n        roomId: UUID,\r\n        unique?: boolean,\r\n        tableName?: string,\r\n    ): Promise<number>;\r\n\r\n    getGoals(params: {\r\n        agentId: UUID;\r\n        roomId: UUID;\r\n        userId?: UUID | null;\r\n        onlyInProgress?: boolean;\r\n        count?: number;\r\n    }): Promise<Goal[]>;\r\n\r\n    updateGoal(goal: Goal): Promise<void>;\r\n\r\n    createGoal(goal: Goal): Promise<void>;\r\n\r\n    removeGoal(goalId: UUID): Promise<void>;\r\n\r\n    removeAllGoals(roomId: UUID): Promise<void>;\r\n\r\n    getRoom(roomId: UUID): Promise<UUID | null>;\r\n\r\n    createRoom(roomId?: UUID): Promise<UUID>;\r\n\r\n    removeRoom(roomId: UUID): Promise<void>;\r\n\r\n    getRoomsForParticipant(userId: UUID): Promise<UUID[]>;\r\n\r\n    getRoomsForParticipants(userIds: UUID[]): Promise<UUID[]>;\r\n\r\n    addParticipant(userId: UUID, roomId: UUID): Promise<boolean>;\r\n\r\n    removeParticipant(userId: UUID, roomId: UUID): Promise<boolean>;\r\n\r\n    getParticipantsForAccount(userId: UUID): Promise<Participant[]>;\r\n\r\n    getParticipantsForRoom(roomId: UUID): Promise<UUID[]>;\r\n\r\n    getParticipantUserState(\r\n        roomId: UUID,\r\n        userId: UUID,\r\n    ): Promise<\"FOLLOWED\" | \"MUTED\" | null>;\r\n\r\n    setParticipantUserState(\r\n        roomId: UUID,\r\n        userId: UUID,\r\n        state: \"FOLLOWED\" | \"MUTED\" | null,\r\n    ): Promise<void>;\r\n\r\n    createRelationship(params: { userA: UUID; userB: UUID }): Promise<boolean>;\r\n\r\n    getRelationship(params: {\r\n        userA: UUID;\r\n        userB: UUID;\r\n    }): Promise<Relationship | null>;\r\n\r\n    getRelationships(params: { userId: UUID }): Promise<Relationship[]>;\r\n\r\n    getKnowledge(params: {\r\n        id?: UUID;\r\n        agentId: UUID;\r\n        limit?: number;\r\n        query?: string;\r\n        conversationContext?: string;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n\r\n    searchKnowledge(params: {\r\n        agentId: UUID;\r\n        embedding: Float32Array;\r\n        match_threshold: number;\r\n        match_count: number;\r\n        searchText?: string;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n\r\n    createKnowledge(knowledge: RAGKnowledgeItem): Promise<void>;\r\n    removeKnowledge(id: UUID): Promise<void>;\r\n    clearKnowledge(agentId: UUID, shared?: boolean): Promise<void>;\r\n}\r\n\r\nexport interface IDatabaseCacheAdapter {\r\n    getCache(params: {\r\n        agentId: UUID;\r\n        key: string;\r\n    }): Promise<string | undefined>;\r\n\r\n    setCache(params: {\r\n        agentId: UUID;\r\n        key: string;\r\n        value: string;\r\n    }): Promise<boolean>;\r\n\r\n    deleteCache(params: { agentId: UUID; key: string }): Promise<boolean>;\r\n}\r\n\r\nexport interface IMemoryManager {\r\n    runtime: IAgentRuntime;\r\n    tableName: string;\r\n    constructor: Function;\r\n\r\n    addEmbeddingToMemory(memory: Memory): Promise<Memory>;\r\n\r\n    getMemories(opts: {\r\n        roomId: UUID;\r\n        count?: number;\r\n        unique?: boolean;\r\n        start?: number;\r\n        end?: number;\r\n    }): Promise<Memory[]>;\r\n\r\n    getCachedEmbeddings(\r\n        content: string,\r\n    ): Promise<{ embedding: number[]; levenshtein_score: number }[]>;\r\n\r\n    getMemoriesByIds(ids: UUID[]): Promise<Memory[]>;\r\n    getMemoryById(id: UUID): Promise<Memory | null>;\r\n    getMemoriesByRoomIds(params: {\r\n        roomIds: UUID[];\r\n        limit?: number;\r\n    }): Promise<Memory[]>;\r\n    searchMemoriesByEmbedding(\r\n        embedding: number[],\r\n        opts: {\r\n            match_threshold?: number;\r\n            count?: number;\r\n            roomId: UUID;\r\n            unique?: boolean;\r\n        },\r\n    ): Promise<Memory[]>;\r\n\r\n    createMemory(memory: Memory, unique?: boolean): Promise<void>;\r\n\r\n    removeMemory(memoryId: UUID): Promise<void>;\r\n\r\n    removeAllMemories(roomId: UUID): Promise<void>;\r\n\r\n    countMemories(roomId: UUID, unique?: boolean): Promise<number>;\r\n}\r\n\r\nexport interface IRAGKnowledgeManager {\r\n    runtime: IAgentRuntime;\r\n    tableName: string;\r\n\r\n    getKnowledge(params: {\r\n        query?: string;\r\n        id?: UUID;\r\n        limit?: number;\r\n        conversationContext?: string;\r\n        agentId?: UUID;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n    createKnowledge(item: RAGKnowledgeItem): Promise<void>;\r\n    removeKnowledge(id: UUID): Promise<void>;\r\n    searchKnowledge(params: {\r\n        agentId: UUID;\r\n        embedding: Float32Array | number[];\r\n        match_threshold?: number;\r\n        match_count?: number;\r\n        searchText?: string;\r\n    }): Promise<RAGKnowledgeItem[]>;\r\n    clearKnowledge(shared?: boolean): Promise<void>;\r\n    processFile(file: {\r\n        path: string;\r\n        content: string;\r\n        type: \"pdf\" | \"md\" | \"txt\";\r\n        isShared: boolean;\r\n    }): Promise<void>;\r\n    cleanupDeletedKnowledgeFiles(): Promise<void>;\r\n    generateScopedId(path: string, isShared: boolean): UUID;\r\n}\r\n\r\nexport type CacheOptions = {\r\n    expires?: number;\r\n};\r\n\r\nexport enum CacheStore {\r\n    REDIS = \"redis\",\r\n    DATABASE = \"database\",\r\n    FILESYSTEM = \"filesystem\",\r\n}\r\n\r\nexport interface ICacheManager {\r\n    get<T = unknown>(key: string): Promise<T | undefined>;\r\n    set<T>(key: string, value: T, options?: CacheOptions): Promise<void>;\r\n    delete(key: string): Promise<void>;\r\n}\r\n\r\nexport abstract class Service {\r\n    private static instance: Service | null = null;\r\n\r\n    static get serviceType(): ServiceType {\r\n        throw new Error(\"Service must implement static serviceType getter\");\r\n    }\r\n\r\n    public static getInstance<T extends Service>(): T {\r\n        if (!Service.instance) {\r\n            Service.instance = new (this as any)();\r\n        }\r\n        return Service.instance as T;\r\n    }\r\n\r\n    get serviceType(): ServiceType {\r\n        return (this.constructor as typeof Service).serviceType;\r\n    }\r\n\r\n    // Add abstract initialize method that must be implemented by derived classes\r\n    abstract initialize(runtime: IAgentRuntime): Promise<void>;\r\n}\r\n\r\nexport interface IAgentRuntime {\r\n    // Properties\r\n    agentId: UUID;\r\n    serverUrl: string;\r\n    databaseAdapter: IDatabaseAdapter;\r\n    token: string | null;\r\n    modelProvider: ModelProviderName;\r\n    imageModelProvider: ModelProviderName;\r\n    imageVisionModelProvider: ModelProviderName;\r\n    character: Character;\r\n    providers: Provider[];\r\n    actions: Action[];\r\n    evaluators: Evaluator[];\r\n    plugins: Plugin[];\r\n\r\n    fetch?: typeof fetch | null;\r\n\r\n    messageManager: IMemoryManager;\r\n    descriptionManager: IMemoryManager;\r\n    documentsManager: IMemoryManager;\r\n    knowledgeManager: IMemoryManager;\r\n    ragKnowledgeManager: IRAGKnowledgeManager;\r\n    loreManager: IMemoryManager;\r\n\r\n    cacheManager: ICacheManager;\r\n\r\n    services: Map<ServiceType, Service>;\r\n    clients: ClientInstance[];\r\n\r\n    // verifiableInferenceAdapter?: IVerifiableInferenceAdapter | null;\r\n\r\n    initialize(): Promise<void>;\r\n\r\n    registerMemoryManager(manager: IMemoryManager): void;\r\n\r\n    getMemoryManager(name: string): IMemoryManager | null;\r\n\r\n    getService<T extends Service>(service: ServiceType): T | null;\r\n\r\n    registerService(service: Service): void;\r\n\r\n    getSetting(key: string): string | null;\r\n\r\n    // Methods\r\n    getConversationLength(): number;\r\n\r\n    processActions(\r\n        message: Memory,\r\n        responses: Memory[],\r\n        state?: State,\r\n        callback?: HandlerCallback,\r\n    ): Promise<void>;\r\n\r\n    evaluate(\r\n        message: Memory,\r\n        state?: State,\r\n        didRespond?: boolean,\r\n        callback?: HandlerCallback,\r\n    ): Promise<string[] | null>;\r\n\r\n    ensureParticipantExists(userId: UUID, roomId: UUID): Promise<void>;\r\n\r\n    ensureUserExists(\r\n        userId: UUID,\r\n        userName: string | null,\r\n        name: string | null,\r\n        source: string | null,\r\n    ): Promise<void>;\r\n\r\n    registerAction(action: Action): void;\r\n\r\n    ensureConnection(\r\n        userId: UUID,\r\n        roomId: UUID,\r\n        userName?: string,\r\n        userScreenName?: string,\r\n        source?: string,\r\n    ): Promise<void>;\r\n\r\n    ensureParticipantInRoom(userId: UUID, roomId: UUID): Promise<void>;\r\n\r\n    ensureRoomExists(roomId: UUID): Promise<void>;\r\n\r\n    composeState(\r\n        message: Memory,\r\n        additionalKeys?: { [key: string]: unknown },\r\n    ): Promise<State>;\r\n\r\n    updateRecentMessageState(state: State): Promise<State>;\r\n}\r\n\r\nexport interface IImageDescriptionService extends Service {\r\n    describeImage(\r\n        imageUrl: string,\r\n    ): Promise<{ title: string; description: string }>;\r\n}\r\n\r\nexport interface ITranscriptionService extends Service {\r\n    transcribeAttachment(audioBuffer: ArrayBuffer): Promise<string | null>;\r\n    transcribeAttachmentLocally(\r\n        audioBuffer: ArrayBuffer,\r\n    ): Promise<string | null>;\r\n    transcribe(audioBuffer: ArrayBuffer): Promise<string | null>;\r\n    transcribeLocally(audioBuffer: ArrayBuffer): Promise<string | null>;\r\n}\r\n\r\nexport interface IVideoService extends Service {\r\n    isVideoUrl(url: string): boolean;\r\n    fetchVideoInfo(url: string): Promise<Media>;\r\n    downloadVideo(videoInfo: Media): Promise<string>;\r\n    processVideo(url: string, runtime: IAgentRuntime): Promise<Media>;\r\n}\r\n\r\nexport interface ITextGenerationService extends Service {\r\n    initializeModel(): Promise<void>;\r\n    queueMessageCompletion(\r\n        context: string,\r\n        temperature: number,\r\n        stop: string[],\r\n        frequency_penalty: number,\r\n        presence_penalty: number,\r\n        max_tokens: number,\r\n    ): Promise<any>;\r\n    queueTextCompletion(\r\n        context: string,\r\n        temperature: number,\r\n        stop: string[],\r\n        frequency_penalty: number,\r\n        presence_penalty: number,\r\n        max_tokens: number,\r\n    ): Promise<string>;\r\n    getEmbeddingResponse(input: string): Promise<number[] | undefined>;\r\n}\r\n\r\nexport interface IBrowserService extends Service {\r\n    closeBrowser(): Promise<void>;\r\n    getPageContent(\r\n        url: string,\r\n        runtime: IAgentRuntime,\r\n    ): Promise<{ title: string; description: string; bodyContent: string }>;\r\n}\r\n\r\nexport interface ISpeechService extends Service {\r\n    getInstance(): ISpeechService;\r\n    generate(runtime: IAgentRuntime, text: string): Promise<Readable>;\r\n}\r\n\r\nexport interface IPdfService extends Service {\r\n    getInstance(): IPdfService;\r\n    convertPdfToText(pdfBuffer: Buffer): Promise<string>;\r\n}\r\n\r\nexport interface IAwsS3Service extends Service {\r\n    uploadFile(\r\n        imagePath: string,\r\n        subDirectory: string,\r\n        useSignedUrl: boolean,\r\n        expiresIn: number,\r\n    ): Promise<{\r\n        success: boolean;\r\n        url?: string;\r\n        error?: string;\r\n    }>;\r\n    generateSignedUrl(fileName: string, expiresIn: number): Promise<string>;\r\n}\r\n\r\nexport interface UploadIrysResult {\r\n    success: boolean;\r\n    url?: string;\r\n    error?: string;\r\n    data?: any;\r\n}\r\n\r\nexport interface DataIrysFetchedFromGQL {\r\n    success: boolean;\r\n    data: any;\r\n    error?: string;\r\n}\r\n\r\nexport interface GraphQLTag {\r\n    name: string;\r\n    values: any[];\r\n}\r\n\r\nexport enum IrysMessageType {\r\n    REQUEST = \"REQUEST\",\r\n    DATA_STORAGE = \"DATA_STORAGE\",\r\n    REQUEST_RESPONSE = \"REQUEST_RESPONSE\",\r\n}\r\n\r\nexport enum IrysDataType {\r\n    FILE = \"FILE\",\r\n    IMAGE = \"IMAGE\",\r\n    OTHER = \"OTHER\",\r\n}\r\n\r\nexport interface IrysTimestamp {\r\n    from: number;\r\n    to: number;\r\n}\r\n\r\nexport interface IIrysService extends Service {\r\n    getDataFromAnAgent(\r\n        agentsWalletPublicKeys: string[],\r\n        tags: GraphQLTag[],\r\n        timestamp: IrysTimestamp,\r\n    ): Promise<DataIrysFetchedFromGQL>;\r\n    workerUploadDataOnIrys(\r\n        data: any,\r\n        dataType: IrysDataType,\r\n        messageType: IrysMessageType,\r\n        serviceCategory: string[],\r\n        protocol: string[],\r\n        validationThreshold: number[],\r\n        minimumProviders: number[],\r\n        testProvider: boolean[],\r\n        reputation: number[],\r\n    ): Promise<UploadIrysResult>;\r\n    providerUploadDataOnIrys(\r\n        data: any,\r\n        dataType: IrysDataType,\r\n        serviceCategory: string[],\r\n        protocol: string[],\r\n    ): Promise<UploadIrysResult>;\r\n}\r\n\r\nexport interface ITeeLogService extends Service {\r\n    getInstance(): ITeeLogService;\r\n    log(\r\n        agentId: string,\r\n        roomId: string,\r\n        userId: string,\r\n        type: string,\r\n        content: string,\r\n    ): Promise<boolean>;\r\n}\r\n\r\nexport enum ServiceType {\r\n    IMAGE_DESCRIPTION = \"image_description\",\r\n    TRANSCRIPTION = \"transcription\",\r\n    VIDEO = \"video\",\r\n    TEXT_GENERATION = \"text_generation\",\r\n    BROWSER = \"browser\",\r\n    SPEECH_GENERATION = \"speech_generation\",\r\n    PDF = \"pdf\",\r\n    INTIFACE = \"intiface\",\r\n    AWS_S3 = \"aws_s3\",\r\n    BUTTPLUG = \"buttplug\",\r\n    SLACK = \"slack\",\r\n    VERIFIABLE_LOGGING = \"verifiable_logging\",\r\n    IRYS = \"irys\",\r\n    TEE_LOG = \"tee_log\",\r\n    GOPLUS_SECURITY = \"goplus_security\",\r\n    WEB_SEARCH = \"web_search\",\r\n    EMAIL_AUTOMATION = \"email_automation\",\r\n    NKN_CLIENT_SERVICE = \"nkn_client_service\",\r\n}\r\n\r\nexport enum LoggingLevel {\r\n    DEBUG = \"debug\",\r\n    VERBOSE = \"verbose\",\r\n    NONE = \"none\",\r\n}\r\n\r\nexport type KnowledgeItem = {\r\n    id: UUID;\r\n    content: Content;\r\n};\r\n\r\nexport interface RAGKnowledgeItem {\r\n    id: UUID;\r\n    agentId: UUID;\r\n    content: {\r\n        text: string;\r\n        metadata?: {\r\n            isMain?: boolean;\r\n            isChunk?: boolean;\r\n            originalId?: UUID;\r\n            chunkIndex?: number;\r\n            source?: string;\r\n            type?: string;\r\n            isShared?: boolean;\r\n            [key: string]: unknown;\r\n        };\r\n    };\r\n    embedding?: Float32Array;\r\n    createdAt?: number;\r\n    similarity?: number;\r\n    score?: number;\r\n}\r\n\r\nexport interface ActionResponse {\r\n    like: boolean;\r\n    retweet: boolean;\r\n    quote?: boolean;\r\n    reply?: boolean;\r\n}\r\n\r\nexport interface ISlackService extends Service {\r\n    client: any;\r\n}\r\n\r\nexport enum TokenizerType {\r\n    Auto = \"auto\",\r\n    TikToken = \"tiktoken\",\r\n}\r\n\r\nexport enum TranscriptionProvider {\r\n    OpenAI = \"openai\",\r\n    Deepgram = \"deepgram\",\r\n    Local = \"local\",\r\n}\r\n\r\nexport enum ActionTimelineType {\r\n    ForYou = \"foryou\",\r\n    Following = \"following\",\r\n}\r\nexport enum KnowledgeScope {\r\n    SHARED = \"shared\",\r\n    PRIVATE = \"private\",\r\n}\r\n\r\nexport enum CacheKeyPrefix {\r\n    KNOWLEDGE = \"knowledge\",\r\n}\r\n\r\nexport interface DirectoryItem {\r\n    directory: string;\r\n    shared?: boolean;\r\n}\r\n\r\nexport interface ChunkRow {\r\n    id: string;\r\n    // Add other properties if needed\r\n}\r\n","import settings from \"./settings.ts\";\r\nimport {\r\n    type EmbeddingModelSettings,\r\n    type ImageModelSettings,\r\n    ModelClass,\r\n    ModelProviderName,\r\n    type Models,\r\n    type ModelSettings,\r\n} from \"./types.ts\";\r\n\r\nexport const models: Models = {\r\n    [ModelProviderName.OPENAI]: {\r\n        endpoint: settings.OPENAI_API_URL || \"https://api.openai.com/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_OPENAI_MODEL || \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_OPENAI_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_OPENAI_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name:\r\n                    settings.EMBEDDING_OPENAI_MODEL || \"text-embedding-3-small\",\r\n                dimensions: 1536,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.IMAGE_OPENAI_MODEL || \"dall-e-3\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.ETERNALAI]: {\r\n        endpoint: settings.ETERNALAI_URL,\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.ETERNALAI_MODEL ||\r\n                    \"neuralmagic/Meta-Llama-3.1-405B-Instruct-quantized.w4a16\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.ETERNALAI_MODEL ||\r\n                    \"neuralmagic/Meta-Llama-3.1-405B-Instruct-quantized.w4a16\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.ETERNALAI_MODEL ||\r\n                    \"neuralmagic/Meta-Llama-3.1-405B-Instruct-quantized.w4a16\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.ANTHROPIC]: {\r\n        endpoint: settings.ANTHROPIC_API_URL || \"https://api.anthropic.com/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_ANTHROPIC_MODEL || \"claude-3-haiku-20240307\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 4096,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_ANTHROPIC_MODEL ||\r\n                    \"claude-3-5-sonnet-20241022\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 4096,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_ANTHROPIC_MODEL ||\r\n                    \"claude-3-5-sonnet-20241022\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 4096,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.CLAUDE_VERTEX]: {\r\n        endpoint: settings.ANTHROPIC_API_URL || \"https://api.anthropic.com/v1\", // TODO: check\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: \"claude-3-5-sonnet-20241022\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: \"claude-3-5-sonnet-20241022\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: \"claude-3-opus-20240229\",\r\n                stop: [],\r\n                maxInputTokens: 200000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.GROK]: {\r\n        endpoint: \"https://api.x.ai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_GROK_MODEL || \"grok-2-1212\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_GROK_MODEL || \"grok-2-1212\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_GROK_MODEL || \"grok-2-1212\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: settings.EMBEDDING_GROK_MODEL || \"grok-2-1212\", // not sure about this one\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.GROQ]: {\r\n        endpoint: \"https://api.groq.com/openai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_GROQ_MODEL || \"llama-3.1-8b-instant\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8000,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_GROQ_MODEL || \"llama-3.3-70b-versatile\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8000,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_GROQ_MODEL || \"llama-3.2-90b-vision-preview\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8000,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: settings.EMBEDDING_GROQ_MODEL || \"llama-3.1-8b-instant\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.LLAMACLOUD]: {\r\n        endpoint: \"https://api.llamacloud.com/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: \"meta-llama/Llama-3.2-3B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: \"meta-llama-3.1-8b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: \"meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"togethercomputer/m2-bert-80M-32k-retrieval\",\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: \"black-forest-labs/FLUX.1-schnell\",\r\n                steps: 4,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.TOGETHER]: {\r\n        endpoint: \"https://api.together.ai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: \"meta-llama/Llama-3.2-3B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: \"meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo-128K\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: \"meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"togethercomputer/m2-bert-80M-32k-retrieval\",\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: \"black-forest-labs/FLUX.1-schnell\",\r\n                steps: 4,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.LLAMALOCAL]: {\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: \"NousResearch/Hermes-3-Llama-3.1-8B-GGUF/resolve/main/Hermes-3-Llama-3.1-8B.Q8_0.gguf?download=true\",\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: \"NousResearch/Hermes-3-Llama-3.1-8B-GGUF/resolve/main/Hermes-3-Llama-3.1-8B.Q8_0.gguf?download=true\", // TODO: ?download=true\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: \"NousResearch/Hermes-3-Llama-3.1-8B-GGUF/resolve/main/Hermes-3-Llama-3.1-8B.Q8_0.gguf?download=true\", // \"RichardErkhov/NousResearch_-_Meta-Llama-3.1-70B-gguf\", // TODO:\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"togethercomputer/m2-bert-80M-32k-retrieval\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.LMSTUDIO]: {\r\n        endpoint: settings.LMSTUDIO_SERVER_URL || \"http://localhost:1234/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_LMSTUDIO_MODEL || settings.LMSTUDIO_MODEL || \"hermes-3-llama-3.1-8b\",\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_LMSTUDIO_MODEL || settings.LMSTUDIO_MODEL || \"hermes-3-llama-3.1-8b\",\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_LMSTUDIO_MODEL || settings.LMSTUDIO_MODEL || \"hermes-3-llama-3.1-8b\",\r\n                stop: [\"<|eot_id|>\", \"<|eom_id|>\"],\r\n                maxInputTokens: 32768,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.GOOGLE]: {\r\n        endpoint: \"https://generativelanguage.googleapis.com\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_GOOGLE_MODEL ||\r\n                    settings.GOOGLE_MODEL ||\r\n                    \"gemini-2.0-flash-exp\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_GOOGLE_MODEL ||\r\n                    settings.GOOGLE_MODEL ||\r\n                    \"gemini-2.0-flash-exp\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_GOOGLE_MODEL ||\r\n                    settings.GOOGLE_MODEL ||\r\n                    \"gemini-2.0-flash-exp\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name:\r\n                    settings.EMBEDDING_GOOGLE_MODEL ||\r\n                    settings.GOOGLE_MODEL ||\r\n                    \"text-embedding-004\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.MISTRAL]: {\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_MISTRAL_MODEL ||\r\n                    settings.MISTRAL_MODEL ||\r\n                    \"mistral-small-latest\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_MISTRAL_MODEL ||\r\n                    settings.MISTRAL_MODEL ||\r\n                    \"mistral-large-latest\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_MISTRAL_MODEL ||\r\n                    settings.MISTRAL_MODEL ||\r\n                    \"mistral-large-latest\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.REDPILL]: {\r\n        endpoint: \"https://api.red-pill.ai/v1\",\r\n        // Available models: https://docs.red-pill.ai/get-started/supported-models\r\n        // To test other models, change the models below\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_REDPILL_MODEL ||\r\n                    settings.REDPILL_MODEL ||\r\n                    \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_REDPILL_MODEL ||\r\n                    settings.REDPILL_MODEL ||\r\n                    \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_REDPILL_MODEL ||\r\n                    settings.REDPILL_MODEL ||\r\n                    \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"text-embedding-3-small\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.OPENROUTER]: {\r\n        endpoint: \"https://openrouter.ai/api/v1\",\r\n        // Available models: https://openrouter.ai/models\r\n        // To test other models, change the models below\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_OPENROUTER_MODEL ||\r\n                    settings.OPENROUTER_MODEL ||\r\n                    \"nousresearch/hermes-3-llama-3.1-405b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_OPENROUTER_MODEL ||\r\n                    settings.OPENROUTER_MODEL ||\r\n                    \"nousresearch/hermes-3-llama-3.1-405b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_OPENROUTER_MODEL ||\r\n                    settings.OPENROUTER_MODEL ||\r\n                    \"nousresearch/hermes-3-llama-3.1-405b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"text-embedding-3-small\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.AIMLAPI]: {\r\n        endpoint: \"https://api.aimlapi.com/v1\",\r\n        // Available models: https://aimlapi.com/models\r\n        // To test other models, change the models below\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_AIMLAPI_MODEL ||\r\n                    settings.AIMLAPI_MODEL ||\r\n                    \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_AIMLAPI_MODEL ||\r\n                    settings.AIMLAPI_MODEL ||\r\n                    \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_AIMLAPI_MODEL ||\r\n                    settings.AIMLAPI_MODEL ||\r\n                    \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"text-embedding-3-small\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.OLLAMA]: {\r\n        endpoint: settings.OLLAMA_SERVER_URL || \"http://localhost:11434\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_OLLAMA_MODEL ||\r\n                    settings.OLLAMA_MODEL ||\r\n                    \"llama3.2\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_OLLAMA_MODEL ||\r\n                    settings.OLLAMA_MODEL ||\r\n                    \"hermes3\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_OLLAMA_MODEL ||\r\n                    settings.OLLAMA_MODEL ||\r\n                    \"hermes3:70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n\r\n            [ModelClass.EMBEDDING]: {\r\n                name: settings.OLLAMA_EMBEDDING_MODEL || \"mxbai-embed-large\",\r\n                dimensions: 1024,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.HEURIST]: {\r\n        endpoint: \"https://llm-gateway.heurist.xyz\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_HEURIST_MODEL ||\r\n                    \"meta-llama/llama-3-70b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_HEURIST_MODEL ||\r\n                    \"meta-llama/llama-3-70b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_HEURIST_MODEL ||\r\n                    \"meta-llama/llama-3.3-70b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.HEURIST_IMAGE_MODEL || \"FLUX.1-dev\",\r\n                steps: 20,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: \"BAAI/bge-large-en-v1.5\",\r\n                dimensions: 1024,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.GALADRIEL]: {\r\n        endpoint: \"https://api.galadriel.com/v1/verified\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_GALADRIEL_MODEL || \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_GALADRIEL_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_GALADRIEL_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.FAL]: {\r\n        endpoint: \"https://api.fal.ai/v1\",\r\n        model: {\r\n            [ModelClass.IMAGE]: { name: \"fal-ai/flux-lora\", steps: 28 },\r\n        },\r\n    },\r\n    [ModelProviderName.GAIANET]: {\r\n        endpoint: settings.GAIANET_SERVER_URL,\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.GAIANET_MODEL ||\r\n                    settings.SMALL_GAIANET_MODEL ||\r\n                    \"llama3b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.GAIANET_MODEL ||\r\n                    settings.MEDIUM_GAIANET_MODEL ||\r\n                    \"llama\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.GAIANET_MODEL ||\r\n                    settings.LARGE_GAIANET_MODEL ||\r\n                    \"qwen72b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                repetition_penalty: 0.4,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: settings.GAIANET_EMBEDDING_MODEL || \"nomic-embed\",\r\n                dimensions: 768,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.ALI_BAILIAN]: {\r\n        endpoint: \"https://dashscope.aliyuncs.com/compatible-mode/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: \"qwen-turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: \"qwen-plus\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: \"qwen-max\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: \"wanx-v1\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.VOLENGINE]: {\r\n        endpoint:\r\n            settings.VOLENGINE_API_URL ||\r\n            \"https://open.volcengineapi.com/api/v3/\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_VOLENGINE_MODEL ||\r\n                    settings.VOLENGINE_MODEL ||\r\n                    \"doubao-lite-128k\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_VOLENGINE_MODEL ||\r\n                    settings.VOLENGINE_MODEL ||\r\n                    \"doubao-pro-128k\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_VOLENGINE_MODEL ||\r\n                    settings.VOLENGINE_MODEL ||\r\n                    \"doubao-pro-256k\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.4,\r\n                presence_penalty: 0.4,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name: settings.VOLENGINE_EMBEDDING_MODEL || \"doubao-embedding\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.NANOGPT]: {\r\n        endpoint: \"https://nano-gpt.com/api/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_NANOGPT_MODEL || \"gpt-4o-mini\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_NANOGPT_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_NANOGPT_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.HYPERBOLIC]: {\r\n        endpoint: \"https://api.hyperbolic.xyz/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_HYPERBOLIC_MODEL ||\r\n                    settings.HYPERBOLIC_MODEL ||\r\n                    \"meta-llama/Llama-3.2-3B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_HYPERBOLIC_MODEL ||\r\n                    settings.HYPERBOLIC_MODEL ||\r\n                    \"meta-llama/Meta-Llama-3.1-70B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_HYPERBOLIC_MODEL ||\r\n                    settings.HYPERBOLIC_MODEL ||\r\n                    \"meta-llama/Meta-Llama-3.1-405-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.IMAGE_HYPERBOLIC_MODEL || \"FLUX.1-dev\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.VENICE]: {\r\n        endpoint: \"https://api.venice.ai/api/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_VENICE_MODEL || \"llama-3.3-70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_VENICE_MODEL || \"llama-3.3-70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_VENICE_MODEL || \"llama-3.1-405b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.IMAGE_VENICE_MODEL || \"fluently-xl\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.NVIDIA]: {\r\n        endpoint: \"https://integrate.api.nvidia.com/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_NVIDIA_MODEL || \"meta/llama-3.2-3b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_NVIDIA_MODEL || \"meta/llama-3.3-70b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_NVIDIA_MODEL || \"meta/llama-3.1-405b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.NINETEEN_AI]: {\r\n        endpoint: \"https://api.nineteen.ai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_NINETEEN_AI_MODEL ||\r\n                    \"unsloth/Llama-3.2-3B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_NINETEEN_AI_MODEL ||\r\n                    \"unsloth/Meta-Llama-3.1-8B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_NINETEEN_AI_MODEL ||\r\n                    \"hugging-quants/Meta-Llama-3.1-70B-Instruct-AWQ-INT4\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name:\r\n                    settings.IMAGE_NINETEEN_AI_MODEL ||\r\n                    \"dataautogpt3/ProteusV0.4-Lightning\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.AKASH_CHAT_API]: {\r\n        endpoint: \"https://chatapi.akash.network/api/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_AKASH_CHAT_API_MODEL ||\r\n                    \"Meta-Llama-3-2-3B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_AKASH_CHAT_API_MODEL ||\r\n                    \"Meta-Llama-3-3-70B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_AKASH_CHAT_API_MODEL ||\r\n                    \"Meta-Llama-3-1-405B-Instruct-FP8\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.LIVEPEER]: {\r\n        endpoint: settings.LIVEPEER_GATEWAY_URL || \"http://gateway.test-gateway\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_LIVEPEER_MODEL ||\r\n                    \"meta-llama/Meta-Llama-3.1-8B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 8000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_LIVEPEER_MODEL ||\r\n                    \"meta-llama/Meta-Llama-3.1-8B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 8000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_LIVEPEER_MODEL ||\r\n                    \"meta-llama/Meta-Llama-3.1-8B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 8000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name:\r\n                    settings.IMAGE_LIVEPEER_MODEL || \"ByteDance/SDXL-Lightning\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.INFERA]: {\r\n        endpoint: \"https://api.infera.org\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_INFERA_MODEL || \"llama3.2:3b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_INFERA_MODEL || \"mistral-nemo:latest\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_INFERA_MODEL || \"mistral-small:latest\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.DEEPSEEK]: {\r\n        endpoint: settings.DEEPSEEK_API_URL || \"https://api.deepseek.com\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_DEEPSEEK_MODEL || \"deepseek-chat\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_DEEPSEEK_MODEL || \"deepseek-chat\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_DEEPSEEK_MODEL || \"deepseek-chat\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.BEDROCK]: {\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_BEDROCK_MODEL || \"amazon.nova-micro-v1:0\",\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 5120,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n                stop: [],\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_BEDROCK_MODEL || \"amazon.nova-lite-v1:0\",\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 5120,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n                stop: [],\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_BEDROCK_MODEL || \"amazon.nova-pro-v1:0\",\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 5120,\r\n                frequency_penalty: 0.0,\r\n                presence_penalty: 0.0,\r\n                temperature: 0.6,\r\n                stop: [],\r\n            },\r\n            [ModelClass.EMBEDDING]: {\r\n                name:\r\n                    settings.EMBEDDING_BEDROCK_MODEL ||\r\n                    \"amazon.titan-embed-text-v1\",\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.IMAGE_BEDROCK_MODEL || \"amazon.nova-canvas-v1:0\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.ATOMA]: {\r\n        endpoint: settings.ATOMA_API_URL || \"https://api.atoma.network/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_ATOMA_MODEL ||\r\n                    \"meta-llama/Llama-3.3-70B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_ATOMA_MODEL ||\r\n                    \"meta-llama/Llama-3.3-70B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_ATOMA_MODEL ||\r\n                    \"meta-llama/Llama-3.3-70B-Instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.SECRETAI]: {\r\n        endpoint: settings.SECRET_AI_URL || \"https://ai1.scrtlabs.com:21434\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_SECRET_AI_MODEL ||\r\n                    \"deepseek-r1:70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_SECRET_AI_MODEL ||\r\n                    \"deepseek-r1:70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_SECRET_AI_MODEL ||\r\n                    \"deepseek-r1:70b\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.7,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.MEM0]: {\r\n        endpoint: settings.MEM0_API_URL || \"https://api.openai.com/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_MEM0_MODEL || \"gpt-4o-mini\",\r\n                stop: [],   \r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_MEM0_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_MEM0_MODEL || \"gpt-4o\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.NEARAI]: {\r\n        endpoint: settings.NEARAI_API_URL || \"https://api.near.ai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name:\r\n                    settings.SMALL_NEARAI_MODEL ||\r\n                    settings.NEARAI_MODEL ||\r\n                    \"fireworks::accounts/fireworks/models/llama-v3p2-3b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name:\r\n                    settings.MEDIUM_NEARAI_MODEL ||\r\n                    settings.NEARAI_MODEL ||\r\n                    \"fireworks::accounts/fireworks/models/llama-v3p1-70b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name:\r\n                    settings.LARGE_NEARAI_MODEL ||\r\n                    settings.NEARAI_MODEL ||\r\n                    \"fireworks::accounts/fireworks/models/llama-v3p1-405b-instruct\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.IMAGE]: {\r\n                name: settings.IMAGE_NEARAI_MODEL || \"fireworks::accounts/fireworks/models/playground-v2-5-1024px-aesthetic\",\r\n            },\r\n        },\r\n    },\r\n    [ModelProviderName.KLUSTERAI]: {\r\n        endpoint: \"https://api.kluster.ai/v1\",\r\n        model: {\r\n            [ModelClass.SMALL]: {\r\n                name: settings.SMALL_KLUSTERAI_MODEL || \"klusterai/Meta-Llama-3.1-8B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.MEDIUM]: {\r\n                name: settings.MEDIUM_KLUSTERAI_MODEL || \"klusterai/Meta-Llama-3.3-70B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            },\r\n            [ModelClass.LARGE]: {\r\n                name: settings.LARGE_KLUSTERAI_MODEL || \"klusterai/Meta-Llama-3.1-405B-Instruct-Turbo\",\r\n                stop: [],\r\n                maxInputTokens: 128000,\r\n                maxOutputTokens: 8192,\r\n                temperature: 0.6,\r\n            }\r\n        },\r\n    },\r\n};\r\n\r\nexport function getModelSettings(\r\n    provider: ModelProviderName,\r\n    type: ModelClass\r\n): ModelSettings | undefined {\r\n    return models[provider]?.model[type] as ModelSettings | undefined;\r\n}\r\n\r\nexport function getImageModelSettings(\r\n    provider: ModelProviderName\r\n): ImageModelSettings | undefined {\r\n    return models[provider]?.model[ModelClass.IMAGE] as\r\n        | ImageModelSettings\r\n        | undefined;\r\n}\r\n\r\nexport function getEmbeddingModelSettings(\r\n    provider: ModelProviderName\r\n): EmbeddingModelSettings | undefined {\r\n    return models[provider]?.model[ModelClass.EMBEDDING] as\r\n        | EmbeddingModelSettings\r\n        | undefined;\r\n}\r\n\r\nexport function getEndpoint(provider: ModelProviderName) {\r\n    return models[provider].endpoint;\r\n}\r\n","import path from \"node:path\";\r\nimport { fileURLToPath } from \"url\";\r\nimport { FlagEmbedding, EmbeddingModel } from \"fastembed\";\r\nimport elizaLogger from \"./logger\";\r\n\r\nclass LocalEmbeddingModelManager {\r\n    private static instance: LocalEmbeddingModelManager | null;\r\n    private model: FlagEmbedding | null = null;\r\n    private initPromise: Promise<void> | null = null;\r\n    private initializationLock = false;\r\n\r\n    private constructor() {}\r\n\r\n    public static getInstance(): LocalEmbeddingModelManager {\r\n        if (!LocalEmbeddingModelManager.instance) {\r\n            LocalEmbeddingModelManager.instance =\r\n                new LocalEmbeddingModelManager();\r\n        }\r\n        return LocalEmbeddingModelManager.instance;\r\n    }\r\n\r\n    private async getRootPath(): Promise<string> {\r\n        const __filename = fileURLToPath(import.meta.url);\r\n        const __dirname = path.dirname(__filename);\r\n        const rootPath = path.resolve(__dirname, \"..\");\r\n        return rootPath.includes(\"/eliza/\")\r\n            ? rootPath.split(\"/eliza/\")[0] + \"/eliza/\"\r\n            : path.resolve(__dirname, \"..\");\r\n    }\r\n\r\n    public async initialize(): Promise<void> {\r\n        // If already initialized, return immediately\r\n        if (this.model) {\r\n            return;\r\n        }\r\n\r\n        // If initialization is in progress, wait for it\r\n        if (this.initPromise) {\r\n            return this.initPromise;\r\n        }\r\n\r\n        // Use a lock to prevent multiple simultaneous initializations\r\n        if (this.initializationLock) {\r\n            // Wait for current initialization to complete\r\n            while (this.initializationLock) {\r\n                await new Promise((resolve) => setTimeout(resolve, 100));\r\n            }\r\n            return;\r\n        }\r\n\r\n        this.initializationLock = true;\r\n\r\n        try {\r\n            this.initPromise = this.initializeModel();\r\n            await this.initPromise;\r\n        } finally {\r\n            this.initializationLock = false;\r\n            this.initPromise = null;\r\n        }\r\n    }\r\n\r\n    private async initializeModel(): Promise<void> {\r\n        const isNode =\r\n            typeof process !== \"undefined\" &&\r\n            process.versions != null &&\r\n            process.versions.node != null;\r\n\r\n        if (!isNode) {\r\n            throw new Error(\"Local embedding not supported in browser\");\r\n        }\r\n\r\n        try {\r\n            const fs = await import(\"fs\");\r\n            const cacheDir = (await this.getRootPath()) + \"/cache/\";\r\n\r\n            if (!fs.existsSync(cacheDir)) {\r\n                fs.mkdirSync(cacheDir, { recursive: true });\r\n            }\r\n\r\n            elizaLogger.debug(\"Initializing BGE embedding model...\");\r\n\r\n            this.model = await FlagEmbedding.init({\r\n                cacheDir: cacheDir,\r\n                model: EmbeddingModel.BGESmallENV15,\r\n                maxLength: 512,\r\n            });\r\n\r\n            elizaLogger.debug(\"BGE model initialized successfully\");\r\n        } catch (error) {\r\n            elizaLogger.error(\"Failed to initialize BGE model:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    public async generateEmbedding(input: string): Promise<number[]> {\r\n        if (!this.model) {\r\n            await this.initialize();\r\n        }\r\n\r\n        if (!this.model) {\r\n            throw new Error(\"Failed to initialize model\");\r\n        }\r\n\r\n        try {\r\n            // Let fastembed handle tokenization internally\r\n            const embedding = await this.model.queryEmbed(input);\r\n            // Debug the raw embedding - uncomment if debugging embeddings\r\n            // elizaLogger.debug(\"Raw embedding from BGE:\", {\r\n            //     type: typeof embedding,\r\n            //     isArray: Array.isArray(embedding),\r\n            //     dimensions: Array.isArray(embedding)\r\n            //         ? embedding.length\r\n            //         : \"not an array\",\r\n            //     sample: Array.isArray(embedding)\r\n            //         ? embedding.slice(0, 5)\r\n            //         : embedding,\r\n            // });\r\n            return this.processEmbedding(embedding);\r\n        } catch (error) {\r\n            elizaLogger.error(\"Embedding generation failed:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    private processEmbedding(embedding: number[]): number[] {\r\n        let finalEmbedding: number[];\r\n\r\n        if (\r\n            ArrayBuffer.isView(embedding) &&\r\n            embedding.constructor === Float32Array\r\n        ) {\r\n            finalEmbedding = Array.from(embedding);\r\n        } else if (\r\n            Array.isArray(embedding) &&\r\n            ArrayBuffer.isView(embedding[0]) &&\r\n            embedding[0].constructor === Float32Array\r\n        ) {\r\n            finalEmbedding = Array.from(embedding[0]);\r\n        } else if (Array.isArray(embedding)) {\r\n            finalEmbedding = embedding;\r\n        } else {\r\n            throw new Error(`Unexpected embedding format: ${typeof embedding}`);\r\n        }\r\n\r\n        finalEmbedding = finalEmbedding.map((n) => Number(n));\r\n\r\n        if (!Array.isArray(finalEmbedding) || finalEmbedding[0] === undefined) {\r\n            throw new Error(\r\n                \"Invalid embedding format: must be an array starting with a number\"\r\n            );\r\n        }\r\n\r\n        if (finalEmbedding.length !== 384) {\r\n            elizaLogger.warn(\r\n                `Unexpected embedding dimension: ${finalEmbedding.length}`\r\n            );\r\n        }\r\n\r\n        return finalEmbedding;\r\n    }\r\n\r\n    public async reset(): Promise<void> {\r\n        if (this.model) {\r\n            // Add any cleanup logic here if needed\r\n            this.model = null;\r\n        }\r\n        this.initPromise = null;\r\n        this.initializationLock = false;\r\n    }\r\n\r\n    // For testing purposes\r\n    public static resetInstance(): void {\r\n        if (LocalEmbeddingModelManager.instance) {\r\n            LocalEmbeddingModelManager.instance.reset();\r\n            LocalEmbeddingModelManager.instance = null;\r\n        }\r\n    }\r\n}\r\n\r\nexport default LocalEmbeddingModelManager;\r\n","import { getEmbeddingModelSettings, getEndpoint } from \"./models.ts\";\r\nimport { type IAgentRuntime, ModelProviderName } from \"./types.ts\";\r\nimport settings from \"./settings.ts\";\r\nimport elizaLogger from \"./logger.ts\";\r\nimport LocalEmbeddingModelManager from \"./localembeddingManager.ts\";\r\n\r\ninterface EmbeddingOptions {\r\n    model: string;\r\n    endpoint: string;\r\n    apiKey?: string;\r\n    length?: number;\r\n    isOllama?: boolean;\r\n    dimensions?: number;\r\n    provider?: string;\r\n}\r\n\r\nexport const EmbeddingProvider = {\r\n    OpenAI: \"OpenAI\",\r\n    Ollama: \"Ollama\",\r\n    GaiaNet: \"GaiaNet\",\r\n    Heurist: \"Heurist\",\r\n    BGE: \"BGE\",\r\n    Custom: \"Custom\",\r\n} as const;\r\n\r\nexport type EmbeddingProviderType =\r\n    (typeof EmbeddingProvider)[keyof typeof EmbeddingProvider];\r\n\r\nexport type EmbeddingConfig = {\r\n    readonly dimensions: number;\r\n    readonly model: string;\r\n    readonly provider: EmbeddingProviderType;\r\n};\r\n\r\nexport const getEmbeddingConfig = (): EmbeddingConfig => {\r\n    // Check for custom embedding configuration first\r\n    if (settings.USE_CUSTOM_EMBEDDING?.toLowerCase() === \"true\") {\r\n        // Ensure all custom embedding settings are provided\r\n        if (!settings.CUSTOM_EMBEDDING_DIMENSIONS || !settings.CUSTOM_EMBEDDING_MODEL || \r\n            !settings.CUSTOM_EMBEDDING_ENDPOINT || !settings.CUSTOM_EMBEDDING_API_KEY) {\r\n            elizaLogger.error(\"Custom embedding configuration error\", {\r\n                dimensions: settings.CUSTOM_EMBEDDING_DIMENSIONS,\r\n                model: settings.CUSTOM_EMBEDDING_MODEL,\r\n                endpoint: settings.CUSTOM_EMBEDDING_ENDPOINT,\r\n                apiKey: settings.CUSTOM_EMBEDDING_API_KEY\r\n            });\r\n            throw new Error('Custom embedding enabled but missing required settings');\r\n        }\r\n        \r\n        return {\r\n            dimensions: Number(settings.CUSTOM_EMBEDDING_DIMENSIONS),\r\n            model: settings.CUSTOM_EMBEDDING_MODEL,\r\n            provider: EmbeddingProvider.Custom,\r\n        };\r\n    }\r\n\r\n    return {\r\n        dimensions:\r\n            settings.USE_OPENAI_EMBEDDING?.toLowerCase() === \"true\"\r\n                ? getEmbeddingModelSettings(ModelProviderName.OPENAI).dimensions\r\n                : settings.USE_OLLAMA_EMBEDDING?.toLowerCase() === \"true\"\r\n                  ? getEmbeddingModelSettings(ModelProviderName.OLLAMA).dimensions\r\n                  : settings.USE_GAIANET_EMBEDDING?.toLowerCase() === \"true\"\r\n                    ? getEmbeddingModelSettings(ModelProviderName.GAIANET)\r\n                          .dimensions\r\n                    : settings.USE_HEURIST_EMBEDDING?.toLowerCase() === \"true\"\r\n                      ? getEmbeddingModelSettings(ModelProviderName.HEURIST)\r\n                            .dimensions\r\n                      : 384, // BGE\r\n        model:\r\n            settings.USE_OPENAI_EMBEDDING?.toLowerCase() === \"true\"\r\n                ? getEmbeddingModelSettings(ModelProviderName.OPENAI).name\r\n                : settings.USE_OLLAMA_EMBEDDING?.toLowerCase() === \"true\"\r\n                  ? getEmbeddingModelSettings(ModelProviderName.OLLAMA).name\r\n                  : settings.USE_GAIANET_EMBEDDING?.toLowerCase() === \"true\"\r\n                    ? getEmbeddingModelSettings(ModelProviderName.GAIANET).name\r\n                    : settings.USE_HEURIST_EMBEDDING?.toLowerCase() === \"true\"\r\n                      ? getEmbeddingModelSettings(ModelProviderName.HEURIST).name\r\n                      : \"BGE-small-en-v1.5\",\r\n        provider:\r\n            settings.USE_OPENAI_EMBEDDING?.toLowerCase() === \"true\"\r\n                ? \"OpenAI\"\r\n                : settings.USE_OLLAMA_EMBEDDING?.toLowerCase() === \"true\"\r\n                  ? \"Ollama\"\r\n                  : settings.USE_GAIANET_EMBEDDING?.toLowerCase() === \"true\"\r\n                    ? \"GaiaNet\"\r\n                    : settings.USE_HEURIST_EMBEDDING?.toLowerCase() === \"true\"\r\n                      ? \"Heurist\"\r\n                      : \"BGE\",\r\n    };\r\n};\r\n\r\nasync function getRemoteEmbedding(\r\n    input: string,\r\n    options: EmbeddingOptions\r\n): Promise<number[]> {\r\n    // Ensure endpoint ends with /v1 for OpenAI\r\n    const baseEndpoint = options.endpoint.endsWith(\"/v1\")\r\n        ? options.endpoint\r\n        : `${options.endpoint}${options.isOllama ? \"/v1\" : \"\"}`;\r\n\r\n    // Construct full URL\r\n    const fullUrl = `${baseEndpoint}/embeddings`;\r\n\r\n    const requestOptions = {\r\n        method: \"POST\",\r\n        headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            ...(options.apiKey\r\n                ? {\r\n                      Authorization: `Bearer ${options.apiKey}`,\r\n                  }\r\n                : {}),\r\n        },\r\n        body: JSON.stringify({\r\n            input,\r\n            model: options.model,\r\n            dimensions:\r\n                options.dimensions ||\r\n                options.length ||\r\n                getEmbeddingConfig().dimensions, // Prefer dimensions, fallback to length\r\n        }),\r\n    };\r\n\r\n    try {\r\n        const response = await fetch(fullUrl, requestOptions);\r\n\r\n        if (!response.ok) {\r\n            elizaLogger.error(\"API Response:\", await response.text()); // Debug log\r\n            throw new Error(\r\n                `Embedding API Error: ${response.status} ${response.statusText}`\r\n            );\r\n        }\r\n\r\n        interface EmbeddingResponse {\r\n            data: Array<{ embedding: number[] }>;\r\n        }\r\n\r\n        const data: EmbeddingResponse = await response.json();\r\n        return data?.data?.[0].embedding;\r\n    } catch (e) {\r\n        elizaLogger.error(\"Full error details:\", e);\r\n        throw e;\r\n    }\r\n}\r\n\r\nexport function getEmbeddingType(runtime: IAgentRuntime): \"local\" | \"remote\" {\r\n    const isNode =\r\n        typeof process !== \"undefined\" &&\r\n        process.versions != null &&\r\n        process.versions.node != null;\r\n\r\n    // Use local embedding if:\r\n    // - Running in Node.js\r\n    // - Not using OpenAI provider\r\n    // - Not forcing OpenAI embeddings\r\n    const isLocal =\r\n        isNode &&\r\n        runtime.character.modelProvider !== ModelProviderName.OPENAI &&\r\n        runtime.character.modelProvider !== ModelProviderName.GAIANET &&\r\n        runtime.character.modelProvider !== ModelProviderName.HEURIST &&\r\n        !settings.USE_OPENAI_EMBEDDING;\r\n\r\n    return isLocal ? \"local\" : \"remote\";\r\n}\r\n\r\nexport function getEmbeddingZeroVector(): number[] {\r\n    let embeddingDimension = 384; // Default BGE dimension\r\n\r\n    if (settings.USE_OPENAI_EMBEDDING?.toLowerCase() === \"true\") {\r\n        embeddingDimension = getEmbeddingModelSettings(\r\n            ModelProviderName.OPENAI\r\n        ).dimensions; // OpenAI dimension\r\n    } else if (settings.USE_OLLAMA_EMBEDDING?.toLowerCase() === \"true\") {\r\n        embeddingDimension = getEmbeddingModelSettings(\r\n            ModelProviderName.OLLAMA\r\n        ).dimensions; // Ollama mxbai-embed-large dimension\r\n    } else if (settings.USE_GAIANET_EMBEDDING?.toLowerCase() === \"true\") {\r\n        embeddingDimension = getEmbeddingModelSettings(\r\n            ModelProviderName.GAIANET\r\n        ).dimensions; // GaiaNet dimension\r\n    } else if (settings.USE_HEURIST_EMBEDDING?.toLowerCase() === \"true\") {\r\n        embeddingDimension = getEmbeddingModelSettings(\r\n            ModelProviderName.HEURIST\r\n        ).dimensions; // Heurist dimension\r\n    }\r\n\r\n    return Array(embeddingDimension).fill(0);\r\n}\r\n\r\n/**\r\n * Gets embeddings from a remote API endpoint.  Falls back to local BGE/384\r\n *\r\n * @param {IAgentRuntime} runtime - The agent runtime context\r\n * @param {string} input - The text to generate embeddings for\r\n * @returns {Promise<number[]>} Array of embedding values\r\n * @throws {Error} If the API request fails\r\n */\r\nexport async function embed(runtime: IAgentRuntime, input: string): Promise<number[]> {\r\n    elizaLogger.debug(\"Embedding request:\", {\r\n        modelProvider: runtime.character.modelProvider,\r\n        useOpenAI: process.env.USE_OPENAI_EMBEDDING,\r\n        input: input?.slice(0, 50) + \"...\",\r\n        inputType: typeof input,\r\n        inputLength: input?.length,\r\n        isString: typeof input === \"string\",\r\n        isEmpty: !input,\r\n    });\r\n\r\n    // Validate input\r\n    if (!input || typeof input !== \"string\" || input.trim().length === 0) {\r\n        elizaLogger.warn(\"Invalid embedding input:\", {\r\n            input,\r\n            type: typeof input,\r\n            length: input?.length,\r\n        });\r\n        return []; // Return empty embedding array\r\n    }\r\n\r\n    // Check cache first\r\n    const cachedEmbedding = await retrieveCachedEmbedding(runtime, input);\r\n    if (cachedEmbedding) return cachedEmbedding;\r\n\r\n    const config = getEmbeddingConfig();\r\n    const isNode = typeof process !== \"undefined\" && process.versions?.node;\r\n  \r\n    if (config.provider === EmbeddingProvider.Custom) {\r\n      return await getRemoteEmbedding(input, {\r\n        model: config.model,\r\n        endpoint: settings.CUSTOM_EMBEDDING_ENDPOINT,\r\n        apiKey: settings.CUSTOM_EMBEDDING_API_KEY,\r\n        dimensions: config.dimensions,\r\n      });\r\n    }\r\n\r\n    // Determine which embedding path to use\r\n    if (config.provider === EmbeddingProvider.OpenAI) {\r\n        return await getRemoteEmbedding(input, {\r\n            model: config.model,\r\n            endpoint: settings.OPENAI_API_URL || \"https://api.openai.com/v1\",\r\n            apiKey: settings.OPENAI_API_KEY,\r\n            dimensions: config.dimensions,\r\n        });\r\n    }\r\n\r\n    if (config.provider === EmbeddingProvider.Ollama) {\r\n        return await getRemoteEmbedding(input, {\r\n            model: config.model,\r\n            endpoint:\r\n                runtime.character.modelEndpointOverride ||\r\n                getEndpoint(ModelProviderName.OLLAMA),\r\n            isOllama: true,\r\n            dimensions: config.dimensions,\r\n        });\r\n    }\r\n\r\n    if (config.provider == EmbeddingProvider.GaiaNet) {\r\n        return await getRemoteEmbedding(input, {\r\n            model: config.model,\r\n            endpoint:\r\n                runtime.character.modelEndpointOverride ||\r\n                getEndpoint(ModelProviderName.GAIANET) ||\r\n                settings.SMALL_GAIANET_SERVER_URL ||\r\n                settings.MEDIUM_GAIANET_SERVER_URL ||\r\n                settings.LARGE_GAIANET_SERVER_URL,\r\n            apiKey: settings.GAIANET_API_KEY || runtime.token,\r\n            dimensions: config.dimensions,\r\n        });\r\n    }\r\n\r\n    if (config.provider === EmbeddingProvider.Heurist) {\r\n        return await getRemoteEmbedding(input, {\r\n            model: config.model,\r\n            endpoint: getEndpoint(ModelProviderName.HEURIST),\r\n            apiKey: runtime.token,\r\n            dimensions: config.dimensions,\r\n        });\r\n    }\r\n\r\n    // BGE - try local first if in Node\r\n    if (isNode) {\r\n        try {\r\n            return await getLocalEmbedding(input);\r\n        } catch (error) {\r\n            elizaLogger.warn(\r\n                \"Local embedding failed, falling back to remote\",\r\n                error\r\n            );\r\n        }\r\n    }\r\n\r\n    // Fallback to remote override\r\n    return await getRemoteEmbedding(input, {\r\n        model: config.model,\r\n        endpoint:\r\n            runtime.character.modelEndpointOverride ||\r\n            getEndpoint(runtime.character.modelProvider),\r\n        apiKey: runtime.token,\r\n        dimensions: config.dimensions,\r\n    });\r\n\r\n    async function getLocalEmbedding(input: string): Promise<number[]> {\r\n        elizaLogger.debug(\"DEBUG - Inside getLocalEmbedding function\");\r\n\r\n        try {\r\n            const embeddingManager = LocalEmbeddingModelManager.getInstance();\r\n            return await embeddingManager.generateEmbedding(input);\r\n        } catch (error) {\r\n            elizaLogger.error(\"Local embedding failed:\", error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async function retrieveCachedEmbedding(\r\n        runtime: IAgentRuntime,\r\n        input: string\r\n    ) {\r\n        if (!input) {\r\n            elizaLogger.log(\"No input to retrieve cached embedding for\");\r\n            return null;\r\n        }\r\n\r\n        const similaritySearchResult =\r\n            await runtime.messageManager.getCachedEmbeddings(input);\r\n        if (similaritySearchResult.length > 0) {\r\n            return similaritySearchResult[0].embedding;\r\n        }\r\n        return null;\r\n    }\r\n}\r\n","import { names, uniqueNamesGenerator } from \"unique-names-generator\";\r\nimport type { ActionExample, Evaluator } from \"./types.ts\";\r\nimport { stringArrayFooter } from \"./parsing.ts\";\r\n\r\n/**\r\n * Template used for the evaluation generateText.\r\n */\r\nexport const evaluationTemplate =\r\n    `TASK: Based on the conversation and conditions, determine which evaluation functions are appropriate to call.\r\nExamples:\r\n{{evaluatorExamples}}\r\n\r\nINSTRUCTIONS: You are helping me to decide which appropriate functions to call based on the conversation between {{senderName}} and {{agentName}}.\r\n\r\n{{recentMessages}}\r\n\r\nEvaluator Functions:\r\n{{evaluators}}\r\n\r\nTASK: Based on the most recent conversation, determine which evaluators functions are appropriate to call to call.\r\nInclude the name of evaluators that are relevant and should be called in the array\r\nAvailable evaluator names to include are {{evaluatorNames}}\r\n` + stringArrayFooter;\r\n\r\n/**\r\n * Formats the names of evaluators into a comma-separated list, each enclosed in single quotes.\r\n * @param evaluators - An array of evaluator objects.\r\n * @returns A string that concatenates the names of all evaluators, each enclosed in single quotes and separated by commas.\r\n */\r\nexport function formatEvaluatorNames(evaluators: Evaluator[]) {\r\n    return evaluators\r\n        .map((evaluator: Evaluator) => `'${evaluator.name}'`)\r\n        .join(\",\\n\");\r\n}\r\n\r\n/**\r\n * Formats evaluator details into a string, including both the name and description of each evaluator.\r\n * @param evaluators - An array of evaluator objects.\r\n * @returns A string that concatenates the name and description of each evaluator, separated by a colon and a newline character.\r\n */\r\nexport function formatEvaluators(evaluators: Evaluator[]) {\r\n    return evaluators\r\n        .map(\r\n            (evaluator: Evaluator) =>\r\n                `'${evaluator.name}: ${evaluator.description}'`\r\n        )\r\n        .join(\",\\n\");\r\n}\r\n\r\n/**\r\n * Formats evaluator examples into a readable string, replacing placeholders with generated names.\r\n * @param evaluators - An array of evaluator objects, each containing examples to format.\r\n * @returns A string that presents each evaluator example in a structured format, including context, messages, and outcomes, with placeholders replaced by generated names.\r\n */\r\nexport function formatEvaluatorExamples(evaluators: Evaluator[]) {\r\n    return evaluators\r\n        .map((evaluator) => {\r\n            return evaluator.examples\r\n                .map((example) => {\r\n                    const exampleNames = Array.from({ length: 5 }, () =>\r\n                        uniqueNamesGenerator({ dictionaries: [names] })\r\n                    );\r\n\r\n                    let formattedContext = example.context;\r\n                    let formattedOutcome = example.outcome;\r\n\r\n                    exampleNames.forEach((name, index) => {\r\n                        const placeholder = `{{user${index + 1}}}`;\r\n                        formattedContext = formattedContext.replaceAll(\r\n                            placeholder,\r\n                            name\r\n                        );\r\n                        formattedOutcome = formattedOutcome.replaceAll(\r\n                            placeholder,\r\n                            name\r\n                        );\r\n                    });\r\n\r\n                    const formattedMessages = example.messages\r\n                        .map((message: ActionExample) => {\r\n                            let messageString = `${message.user}: ${message.content.text}`;\r\n                            exampleNames.forEach((name, index) => {\r\n                                const placeholder = `{{user${index + 1}}}`;\r\n                                messageString = messageString.replaceAll(\r\n                                    placeholder,\r\n                                    name\r\n                                );\r\n                            });\r\n                            return (\r\n                                messageString +\r\n                                (message.content.action\r\n                                    ? ` (${message.content.action})`\r\n                                    : \"\")\r\n                            );\r\n                        })\r\n                        .join(\"\\n\");\r\n\r\n                    return `Context:\\n${formattedContext}\\n\\nMessages:\\n${formattedMessages}\\n\\nOutcome:\\n${formattedOutcome}`;\r\n                })\r\n                .join(\"\\n\\n\");\r\n        })\r\n        .join(\"\\n\\n\");\r\n}\r\n\r\n/**\r\n * Generates a string summarizing the descriptions of each evaluator example.\r\n * @param evaluators - An array of evaluator objects, each containing examples.\r\n * @returns A string that summarizes the descriptions for each evaluator example, formatted with the evaluator name, example number, and description.\r\n */\r\nexport function formatEvaluatorExampleDescriptions(evaluators: Evaluator[]) {\r\n    return evaluators\r\n        .map((evaluator) =>\r\n            evaluator.examples\r\n                .map(\r\n                    (_example, index) =>\r\n                        `${evaluator.name} Example ${index + 1}: ${evaluator.description}`\r\n                )\r\n                .join(\"\\n\")\r\n        )\r\n        .join(\"\\n\\n\");\r\n}\r\n","import { createAnthropic } from \"@ai-sdk/anthropic\";\r\nimport { createGoogleGenerativeAI } from \"@ai-sdk/google\";\r\nimport { createMistral } from \"@ai-sdk/mistral\";\r\nimport { createGroq } from \"@ai-sdk/groq\";\r\nimport { createOpenAI } from \"@ai-sdk/openai\";\r\nimport { bedrock } from \"@ai-sdk/amazon-bedrock\";\r\nimport { createMem0 } from \"@mem0/vercel-ai-provider\";\r\nimport {\r\n    generateObject as aiGenerateObject,\r\n    generateText as aiGenerateText,\r\n    type CoreTool,\r\n    type GenerateObjectResult,\r\n    type StepResult as AIStepResult,\r\n} from \"ai\";\r\nimport { Buffer } from \"buffer\";\r\nimport { createOllama } from \"ollama-ai-provider\";\r\nimport OpenAI from \"openai\";\r\nimport { encodingForModel, type TiktokenModel } from \"js-tiktoken\";\r\n// import { AutoTokenizer } from \"@huggingface/transformers\";\r\nimport Together from \"together-ai\";\r\nimport type { ZodSchema } from \"zod\";\r\nimport { elizaLogger } from \"./index.ts\";\r\nimport {\r\n    models,\r\n    getModelSettings,\r\n    getImageModelSettings,\r\n    getEndpoint,\r\n} from \"./models.ts\";\r\nimport {\r\n    parseBooleanFromText,\r\n    parseJsonArrayFromText,\r\n    parseJSONObjectFromText,\r\n    parseShouldRespondFromText,\r\n    parseActionResponseFromText,\r\n} from \"./parsing.ts\";\r\nimport settings from \"./settings.ts\";\r\nimport {\r\n    type Content,\r\n    type IAgentRuntime,\r\n    type IImageDescriptionService,\r\n    type ITextGenerationService,\r\n    ModelClass,\r\n    ModelProviderName,\r\n    ServiceType,\r\n    type ActionResponse,\r\n    // type IVerifiableInferenceAdapter,\r\n    // type VerifiableInferenceOptions,\r\n    // type VerifiableInferenceResult,\r\n    //VerifiableInferenceProvider,\r\n    type TelemetrySettings,\r\n    TokenizerType,\r\n} from \"./types.ts\";\r\nimport { fal } from \"@fal-ai/client\";\r\n\r\nimport BigNumber from \"bignumber.js\";\r\nimport { createPublicClient, http } from \"viem\";\r\nimport fs from \"fs\";\r\nimport os from \"os\";\r\nimport path from \"path\";\r\n\r\ntype Tool = CoreTool<any, any>;\r\ntype StepResult = AIStepResult<any>;\r\n\r\n// Simplify the types to avoid deep recursion\r\ntype GenerationResult = GenerateObjectResult<unknown>;\r\n\r\ninterface ProviderOptions {\r\n    runtime: IAgentRuntime;\r\n    provider: ModelProviderName;\r\n    model: string;\r\n    apiKey: string;\r\n    schema?: ZodSchema;\r\n    schemaName?: string;\r\n    schemaDescription?: string;\r\n    mode?: \"auto\" | \"json\" | \"tool\";\r\n    modelOptions: ModelSettings;\r\n    modelClass: ModelClass;\r\n    context: string;\r\n}\r\n\r\n/**\r\n * Trims the provided text context to a specified token limit using a tokenizer model and type.\r\n *\r\n * The function dynamically determines the truncation method based on the tokenizer settings\r\n * provided by the runtime. If no tokenizer settings are defined, it defaults to using the\r\n * TikToken truncation method with the \"gpt-4o\" model.\r\n *\r\n * @async\r\n * @function trimTokens\r\n * @param {string} context - The text to be tokenized and trimmed.\r\n * @param {number} maxTokens - The maximum number of tokens allowed after truncation.\r\n * @param {IAgentRuntime} runtime - The runtime interface providing tokenizer settings.\r\n *\r\n * @returns {Promise<string>} A promise that resolves to the trimmed text.\r\n *\r\n * @throws {Error} Throws an error if the runtime settings are invalid or missing required fields.\r\n *\r\n * @example\r\n * const trimmedText = await trimTokens(\"This is an example text\", 50, runtime);\r\n * console.log(trimmedText); // Output will be a truncated version of the input text.\r\n */\r\nexport async function trimTokens(\r\n    context: string,\r\n    maxTokens: number,\r\n    runtime: IAgentRuntime\r\n) {\r\n    if (!context) return \"\";\r\n    if (maxTokens <= 0) throw new Error(\"maxTokens must be positive\");\r\n\r\n    const tokenizerModel = runtime.getSetting(\"TOKENIZER_MODEL\");\r\n    const tokenizerType = runtime.getSetting(\"TOKENIZER_TYPE\");\r\n\r\n    if (!tokenizerModel || !tokenizerType) {\r\n        // Default to TikToken truncation using the \"gpt-4o\" model if tokenizer settings are not defined\r\n        return truncateTiktoken(\"gpt-4o\", context, maxTokens);\r\n    }\r\n\r\n    // Choose the truncation method based on tokenizer type\r\n    // if (tokenizerType === TokenizerType.Auto) {\r\n    //     return truncateAuto(tokenizerModel, context, maxTokens);\r\n    // }\r\n\r\n    if (tokenizerType === TokenizerType.TikToken) {\r\n        return truncateTiktoken(\r\n            tokenizerModel as TiktokenModel,\r\n            context,\r\n            maxTokens\r\n        );\r\n    }\r\n\r\n    elizaLogger.warn(`Unsupported tokenizer type: ${tokenizerType}`);\r\n    return truncateTiktoken(\"gpt-4o\", context, maxTokens);\r\n}\r\n\r\n// async function truncateAuto(\r\n//     modelPath: string,\r\n//     context: string,\r\n//     maxTokens: number\r\n// ) {\r\n//     try {\r\n//         const tokenizer = await AutoTokenizer.from_pretrained(modelPath);\r\n//         const tokens = tokenizer.encode(context);\r\n\r\n//         // If already within limits, return unchanged\r\n//         if (tokens.length <= maxTokens) {\r\n//             return context;\r\n//         }\r\n\r\n//         // Keep the most recent tokens by slicing from the end\r\n//         const truncatedTokens = tokens.slice(-maxTokens);\r\n\r\n//         // Decode back to text - js-tiktoken decode() returns a string directly\r\n//         return tokenizer.decode(truncatedTokens);\r\n//     } catch (error) {\r\n//         elizaLogger.error(\"Error in trimTokens:\", error);\r\n//         // Return truncated string if tokenization fails\r\n//         return context.slice(-maxTokens * 4); // Rough estimate of 4 chars per token\r\n//     }\r\n// }\r\n\r\nasync function truncateTiktoken(\r\n    model: TiktokenModel,\r\n    context: string,\r\n    maxTokens: number\r\n) {\r\n    try {\r\n        const encoding = encodingForModel(model);\r\n\r\n        // Encode the text into tokens\r\n        const tokens = encoding.encode(context);\r\n\r\n        // If already within limits, return unchanged\r\n        if (tokens.length <= maxTokens) {\r\n            return context;\r\n        }\r\n\r\n        // Keep the most recent tokens by slicing from the end\r\n        const truncatedTokens = tokens.slice(-maxTokens);\r\n\r\n        // Decode back to text - js-tiktoken decode() returns a string directly\r\n        return encoding.decode(truncatedTokens);\r\n    } catch (error) {\r\n        elizaLogger.error(\"Error in trimTokens:\", error);\r\n        // Return truncated string if tokenization fails\r\n        return context.slice(-maxTokens * 4); // Rough estimate of 4 chars per token\r\n    }\r\n}\r\n\r\n/**\r\n * Get OnChain EternalAI System Prompt\r\n * @returns System Prompt\r\n */\r\nasync function getOnChainEternalAISystemPrompt(\r\n    runtime: IAgentRuntime\r\n): Promise<string> | undefined {\r\n    const agentId = runtime.getSetting(\"ETERNALAI_AGENT_ID\");\r\n    const providerUrl = runtime.getSetting(\"ETERNALAI_RPC_URL\");\r\n    const contractAddress = runtime.getSetting(\r\n        \"ETERNALAI_AGENT_CONTRACT_ADDRESS\"\r\n    );\r\n    if (agentId && providerUrl && contractAddress) {\r\n        // get on-chain system-prompt\r\n        const contractABI = [\r\n            {\r\n                inputs: [\r\n                    {\r\n                        internalType: \"uint256\",\r\n                        name: \"_agentId\",\r\n                        type: \"uint256\",\r\n                    },\r\n                ],\r\n                name: \"getAgentSystemPrompt\",\r\n                outputs: [\r\n                    { internalType: \"bytes[]\", name: \"\", type: \"bytes[]\" },\r\n                ],\r\n                stateMutability: \"view\",\r\n                type: \"function\",\r\n            },\r\n        ];\r\n\r\n        const publicClient = createPublicClient({\r\n            transport: http(providerUrl),\r\n        });\r\n\r\n        try {\r\n            const validAddress: `0x${string}` =\r\n                contractAddress as `0x${string}`;\r\n            const result = await publicClient.readContract({\r\n                address: validAddress,\r\n                abi: contractABI,\r\n                functionName: \"getAgentSystemPrompt\",\r\n                args: [new BigNumber(agentId)],\r\n            });\r\n            if (result) {\r\n                elizaLogger.info(\"on-chain system-prompt response\", result[0]);\r\n                const value = result[0].toString().replace(\"0x\", \"\");\r\n                const content = Buffer.from(value, \"hex\").toString(\"utf-8\");\r\n                elizaLogger.info(\"on-chain system-prompt\", content);\r\n                return await fetchEternalAISystemPrompt(runtime, content);\r\n            } else {\r\n                return undefined;\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(error);\r\n            elizaLogger.error(\"err\", error);\r\n        }\r\n    }\r\n    return undefined;\r\n}\r\n\r\n/**\r\n * Fetch EternalAI System Prompt\r\n * @returns System Prompt\r\n */\r\nasync function fetchEternalAISystemPrompt(\r\n    runtime: IAgentRuntime,\r\n    content: string\r\n): Promise<string> | undefined {\r\n    const IPFS = \"ipfs://\";\r\n    const containsSubstring: boolean = content.includes(IPFS);\r\n    if (containsSubstring) {\r\n        const lightHouse = content.replace(\r\n            IPFS,\r\n            \"https://gateway.lighthouse.storage/ipfs/\"\r\n        );\r\n        elizaLogger.info(\"fetch lightHouse\", lightHouse);\r\n        const responseLH = await fetch(lightHouse, {\r\n            method: \"GET\",\r\n        });\r\n        elizaLogger.info(\"fetch lightHouse resp\", responseLH);\r\n        if (responseLH.ok) {\r\n            const data = await responseLH.text();\r\n            return data;\r\n        } else {\r\n            const gcs = content.replace(\r\n                IPFS,\r\n                \"https://cdn.eternalai.org/upload/\"\r\n            );\r\n            elizaLogger.info(\"fetch gcs\", gcs);\r\n            const responseGCS = await fetch(gcs, {\r\n                method: \"GET\",\r\n            });\r\n            elizaLogger.info(\"fetch lightHouse gcs\", responseGCS);\r\n            if (responseGCS.ok) {\r\n                const data = await responseGCS.text();\r\n                return data;\r\n            } else {\r\n                throw new Error(\"invalid on-chain system prompt\");\r\n            }\r\n        }\r\n    } else {\r\n        return content;\r\n    }\r\n}\r\n\r\n/**\r\n * Gets the Cloudflare Gateway base URL for a specific provider if enabled\r\n * @param runtime The runtime environment\r\n * @param provider The model provider name\r\n * @returns The Cloudflare Gateway base URL if enabled, undefined otherwise\r\n */\r\nfunction getCloudflareGatewayBaseURL(\r\n    runtime: IAgentRuntime,\r\n    provider: string\r\n): string | undefined {\r\n    const isCloudflareEnabled =\r\n        runtime.getSetting(\"CLOUDFLARE_GW_ENABLED\") === \"true\";\r\n    const cloudflareAccountId = runtime.getSetting(\"CLOUDFLARE_AI_ACCOUNT_ID\");\r\n    const cloudflareGatewayId = runtime.getSetting(\"CLOUDFLARE_AI_GATEWAY_ID\");\r\n\r\n    elizaLogger.debug(\"Cloudflare Gateway Configuration:\", {\r\n        isEnabled: isCloudflareEnabled,\r\n        hasAccountId: !!cloudflareAccountId,\r\n        hasGatewayId: !!cloudflareGatewayId,\r\n        provider: provider,\r\n    });\r\n\r\n    if (!isCloudflareEnabled) {\r\n        elizaLogger.debug(\"Cloudflare Gateway is not enabled\");\r\n        return undefined;\r\n    }\r\n\r\n    if (!cloudflareAccountId) {\r\n        elizaLogger.warn(\r\n            \"Cloudflare Gateway is enabled but CLOUDFLARE_AI_ACCOUNT_ID is not set\"\r\n        );\r\n        return undefined;\r\n    }\r\n\r\n    if (!cloudflareGatewayId) {\r\n        elizaLogger.warn(\r\n            \"Cloudflare Gateway is enabled but CLOUDFLARE_AI_GATEWAY_ID is not set\"\r\n        );\r\n        return undefined;\r\n    }\r\n\r\n    const baseURL = `https://gateway.ai.cloudflare.com/v1/${cloudflareAccountId}/${cloudflareGatewayId}/${provider.toLowerCase()}`;\r\n    elizaLogger.info(\"Using Cloudflare Gateway:\", {\r\n        provider,\r\n        baseURL,\r\n        accountId: cloudflareAccountId,\r\n        gatewayId: cloudflareGatewayId,\r\n    });\r\n\r\n    return baseURL;\r\n}\r\n\r\n/**\r\n * Send a message to the model for a text generateText - receive a string back and parse how you'd like\r\n * @param opts - The options for the generateText request.\r\n * @param opts.context The context of the message to be completed.\r\n * @param opts.stop A list of strings to stop the generateText at.\r\n * @param opts.model The model to use for generateText.\r\n * @param opts.frequency_penalty The frequency penalty to apply to the generateText.\r\n * @param opts.presence_penalty The presence penalty to apply to the generateText.\r\n * @param opts.temperature The temperature to apply to the generateText.\r\n * @param opts.max_context_length The maximum length of the context to apply to the generateText.\r\n * @returns The completed message.\r\n */\r\n\r\nexport async function generateText({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n    tools = {},\r\n    onStepFinish,\r\n    maxSteps = 1,\r\n    stop,\r\n    customSystemPrompt,\r\n}: // verifiableInference = process.env.VERIFIABLE_INFERENCE_ENABLED === \"true\",\r\n// verifiableInferenceOptions,\r\n{\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n    tools?: Record<string, Tool>;\r\n    onStepFinish?: (event: StepResult) => Promise<void> | void;\r\n    maxSteps?: number;\r\n    stop?: string[];\r\n    customSystemPrompt?: string;\r\n    // verifiableInference?: boolean;\r\n    // verifiableInferenceAdapter?: IVerifiableInferenceAdapter;\r\n    // verifiableInferenceOptions?: VerifiableInferenceOptions;\r\n}): Promise<string> {\r\n    if (!context) {\r\n        console.error(\"generateText context is empty\");\r\n        return \"\";\r\n    }\r\n\r\n    elizaLogger.log(\"Generating text...\");\r\n\r\n    elizaLogger.info(\"Generating text with options:\", {\r\n        modelProvider: runtime.modelProvider,\r\n        model: modelClass,\r\n        // verifiableInference,\r\n    });\r\n    elizaLogger.log(\"Using provider:\", runtime.modelProvider);\r\n    // If verifiable inference is requested and adapter is provided, use it\r\n    // if (verifiableInference && runtime.verifiableInferenceAdapter) {\r\n    //     elizaLogger.log(\r\n    //         \"Using verifiable inference adapter:\",\r\n    //         runtime.verifiableInferenceAdapter\r\n    //     );\r\n    //     try {\r\n    //         const result: VerifiableInferenceResult =\r\n    //             await runtime.verifiableInferenceAdapter.generateText(\r\n    //                 context,\r\n    //                 modelClass,\r\n    //                 verifiableInferenceOptions\r\n    //             );\r\n    //         elizaLogger.log(\"Verifiable inference result:\", result);\r\n    //         // Verify the proof\r\n    //         const isValid =\r\n    //             await runtime.verifiableInferenceAdapter.verifyProof(result);\r\n    //         if (!isValid) {\r\n    //             throw new Error(\"Failed to verify inference proof\");\r\n    //         }\r\n\r\n    //         return result.text;\r\n    //     } catch (error) {\r\n    //         elizaLogger.error(\"Error in verifiable inference:\", error);\r\n    //         throw error;\r\n    //     }\r\n    // }\r\n\r\n    const provider = runtime.modelProvider;\r\n    elizaLogger.debug(\"Provider settings:\", {\r\n        provider,\r\n        hasRuntime: !!runtime,\r\n        runtimeSettings: {\r\n            CLOUDFLARE_GW_ENABLED: runtime.getSetting(\"CLOUDFLARE_GW_ENABLED\"),\r\n            CLOUDFLARE_AI_ACCOUNT_ID: runtime.getSetting(\r\n                \"CLOUDFLARE_AI_ACCOUNT_ID\"\r\n            ),\r\n            CLOUDFLARE_AI_GATEWAY_ID: runtime.getSetting(\r\n                \"CLOUDFLARE_AI_GATEWAY_ID\"\r\n            ),\r\n        },\r\n    });\r\n\r\n    const endpoint =\r\n        runtime.character.modelEndpointOverride || getEndpoint(provider);\r\n    const modelSettings = getModelSettings(runtime.modelProvider, modelClass);\r\n    let model = modelSettings.name;\r\n\r\n    // allow character.json settings => secrets to override models\r\n    // FIXME: add MODEL_MEDIUM support\r\n    switch (provider) {\r\n        // if runtime.getSetting(\"LLAMACLOUD_MODEL_LARGE\") is true and modelProvider is LLAMACLOUD, then use the large model\r\n        case ModelProviderName.LLAMACLOUD:\r\n            {\r\n                switch (modelClass) {\r\n                    case ModelClass.LARGE:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"LLAMACLOUD_MODEL_LARGE\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                    case ModelClass.SMALL:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"LLAMACLOUD_MODEL_SMALL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n            break;\r\n        case ModelProviderName.TOGETHER:\r\n            {\r\n                switch (modelClass) {\r\n                    case ModelClass.LARGE:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"TOGETHER_MODEL_LARGE\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                    case ModelClass.SMALL:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"TOGETHER_MODEL_SMALL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n            break;\r\n        case ModelProviderName.OPENROUTER:\r\n            {\r\n                switch (modelClass) {\r\n                    case ModelClass.LARGE:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"LARGE_OPENROUTER_MODEL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                    case ModelClass.SMALL:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"SMALL_OPENROUTER_MODEL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n            break;\r\n        case ModelProviderName.AIMLAPI:\r\n            {\r\n                switch (modelClass) {\r\n                    case ModelClass.LARGE:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"LARGE_AIMLAPI_MODEL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                    case ModelClass.SMALL:\r\n                        {\r\n                            model =\r\n                                runtime.getSetting(\"SMALL_AIMLAPI_MODEL\") ||\r\n                                model;\r\n                        }\r\n                        break;\r\n                }\r\n            }\r\n            break;\r\n    }\r\n\r\n    elizaLogger.info(\"Selected model:\", model);\r\n\r\n    const modelConfiguration = runtime.character?.settings?.modelConfig;\r\n    const temperature =\r\n        modelConfiguration?.temperature || modelSettings.temperature;\r\n    const frequency_penalty =\r\n        modelConfiguration?.frequency_penalty ||\r\n        modelSettings.frequency_penalty;\r\n    const presence_penalty =\r\n        modelConfiguration?.presence_penalty || modelSettings.presence_penalty;\r\n    const max_context_length =\r\n        modelConfiguration?.maxInputTokens || modelSettings.maxInputTokens;\r\n    const max_response_length =\r\n        modelConfiguration?.maxOutputTokens || modelSettings.maxOutputTokens;\r\n    const experimental_telemetry =\r\n        modelConfiguration?.experimental_telemetry ||\r\n        modelSettings.experimental_telemetry;\r\n\r\n    const apiKey = runtime.token;\r\n\r\n    try {\r\n        elizaLogger.debug(\r\n            `Trimming context to max length of ${max_context_length} tokens.`\r\n        );\r\n\r\n        context = await trimTokens(context, max_context_length, runtime);\r\n\r\n        let response: string;\r\n\r\n        const _stop = stop || modelSettings.stop;\r\n        elizaLogger.debug(\r\n            `Using provider: ${provider}, model: ${model}, temperature: ${temperature}, max response length: ${max_response_length}`\r\n        );\r\n\r\n        switch (provider) {\r\n            // OPENAI & LLAMACLOUD shared same structure.\r\n            case ModelProviderName.OPENAI:\r\n            case ModelProviderName.ALI_BAILIAN:\r\n            case ModelProviderName.VOLENGINE:\r\n            case ModelProviderName.LLAMACLOUD:\r\n            case ModelProviderName.NANOGPT:\r\n            case ModelProviderName.HYPERBOLIC:\r\n            case ModelProviderName.TOGETHER:\r\n            case ModelProviderName.NINETEEN_AI:\r\n            case ModelProviderName.AKASH_CHAT_API:\r\n            case ModelProviderName.LMSTUDIO:\r\n            case ModelProviderName.NEARAI:\r\n            case ModelProviderName.KLUSTERAI: {\r\n                elizaLogger.debug(\r\n                    \"Initializing OpenAI model with Cloudflare check\"\r\n                );\r\n                const baseURL =\r\n                    getCloudflareGatewayBaseURL(runtime, \"openai\") || endpoint;\r\n\r\n                //elizaLogger.debug(\"OpenAI baseURL result:\", { baseURL });\r\n                const openai = createOpenAI({\r\n                    apiKey,\r\n                    baseURL,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: openaiResponse } = await aiGenerateText({\r\n                    model: openai.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = openaiResponse;\r\n                console.log(\"Received response from OpenAI model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.ETERNALAI: {\r\n                elizaLogger.debug(\"Initializing EternalAI model.\");\r\n                const openai = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                let system_prompt =\r\n                    runtime.character.system ??\r\n                    settings.SYSTEM_PROMPT ??\r\n                    undefined;\r\n                try {\r\n                    const on_chain_system_prompt =\r\n                        await getOnChainEternalAISystemPrompt(runtime);\r\n                    if (!on_chain_system_prompt) {\r\n                        elizaLogger.error(\r\n                            new Error(\"invalid on_chain_system_prompt\")\r\n                        );\r\n                    } else {\r\n                        system_prompt = on_chain_system_prompt;\r\n                        elizaLogger.info(\r\n                            \"new on-chain system prompt\",\r\n                            system_prompt\r\n                        );\r\n                    }\r\n                } catch (e) {\r\n                    elizaLogger.error(e);\r\n                }\r\n\r\n                // Prepare the request with chain_id\r\n                const chain_id = runtime.getSetting(\"ETERNALAI_CHAIN_ID\") || \"45762\";\r\n                \r\n                // Add chain_id to context as a special marker for EternalAI\r\n                const contextWithChainId = `[chain_id: ${chain_id}]\\n${context}`;\r\n\r\n                const { text: openaiResponse } = await aiGenerateText({\r\n                    model: openai.languageModel(model),\r\n                    prompt: contextWithChainId,\r\n                    system: system_prompt,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                });\r\n\r\n                response = openaiResponse;\r\n                elizaLogger.debug(\"Received response from EternalAI model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.GOOGLE: {\r\n                const google = createGoogleGenerativeAI({\r\n                    apiKey,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: googleResponse } = await aiGenerateText({\r\n                    model: google(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = googleResponse;\r\n                elizaLogger.debug(\"Received response from Google model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.MISTRAL: {\r\n                const mistral = createMistral();\r\n\r\n                const { text: mistralResponse } = await aiGenerateText({\r\n                    model: mistral(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                });\r\n\r\n                response = mistralResponse;\r\n                elizaLogger.debug(\"Received response from Mistral model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.ANTHROPIC: {\r\n                elizaLogger.debug(\r\n                    \"Initializing Anthropic model with Cloudflare check\"\r\n                );\r\n                const baseURL =\r\n                    getCloudflareGatewayBaseURL(runtime, \"anthropic\") ||\r\n                    \"https://api.anthropic.com/v1\";\r\n                elizaLogger.debug(\"Anthropic baseURL result:\", { baseURL });\r\n\r\n                const anthropic = createAnthropic({\r\n                    apiKey,\r\n                    baseURL,\r\n                    fetch: runtime.fetch,\r\n                });\r\n                const { text: anthropicResponse } = await aiGenerateText({\r\n                    model: anthropic.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = anthropicResponse;\r\n                elizaLogger.debug(\"Received response from Anthropic model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.CLAUDE_VERTEX: {\r\n                elizaLogger.debug(\"Initializing Claude Vertex model.\");\r\n\r\n                const anthropic = createAnthropic({\r\n                    apiKey,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: anthropicResponse } = await aiGenerateText({\r\n                    model: anthropic.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = anthropicResponse;\r\n                elizaLogger.debug(\r\n                    \"Received response from Claude Vertex model.\"\r\n                );\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.GROK: {\r\n                elizaLogger.debug(\"Initializing Grok model.\");\r\n                const grok = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: grokResponse } = await aiGenerateText({\r\n                    model: grok.languageModel(model, {\r\n                        parallelToolCalls: false,\r\n                    }),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = grokResponse;\r\n                elizaLogger.debug(\"Received response from Grok model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.MEM0: {\r\n                elizaLogger.debug(\r\n                    \"Initializing Mem0 model with Cloudflare check\"\r\n                );\r\n                const baseURL = endpoint || getCloudflareGatewayBaseURL(runtime, \"openai\");\r\n\r\n                const mem0 = createMem0({\r\n                    provider: runtime.getSetting(\"MEM0_PROVIDER\") || \"openai\",\r\n                    apiKey: runtime.getSetting(\"MEM0_PROVIDER_API_KEY\"),\r\n                    fetch: runtime.fetch,\r\n                    mem0ApiKey: runtime.getSetting(\"MEM0_API_KEY\"),\r\n                    mem0Config: {\r\n                        user_id: runtime.getSetting(\"MEM0_USER_ID\") || \"eliza-os-user\"\r\n                    }\r\n                });\r\n\r\n                const { text: mem0Response } = await aiGenerateText({\r\n                    model: mem0.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = mem0Response;\r\n                elizaLogger.debug(\"Received response from Mem0 Provider.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.GROQ: {\r\n                elizaLogger.debug(\r\n                    \"Initializing Groq model with Cloudflare check\"\r\n                );\r\n                const baseURL = getCloudflareGatewayBaseURL(runtime, \"groq\");\r\n                elizaLogger.debug(\"Groq baseURL result:\", { baseURL });\r\n                const groq = createGroq({\r\n                    apiKey,\r\n                    fetch: runtime.fetch,\r\n                    baseURL,\r\n                });\r\n\r\n                const { text: groqResponse } = await aiGenerateText({\r\n                    model: groq.languageModel(model),\r\n                    prompt: context,\r\n                    temperature,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry,\r\n                });\r\n\r\n                response = groqResponse;\r\n                elizaLogger.debug(\"Received response from Groq model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.LLAMALOCAL: {\r\n                elizaLogger.debug(\r\n                    \"Using local Llama model for text completion.\"\r\n                );\r\n                const textGenerationService =\r\n                    runtime.getService<ITextGenerationService>(\r\n                        ServiceType.TEXT_GENERATION\r\n                    );\r\n\r\n                if (!textGenerationService) {\r\n                    throw new Error(\"Text generation service not found\");\r\n                }\r\n\r\n                response = await textGenerationService.queueTextCompletion(\r\n                    context,\r\n                    temperature,\r\n                    _stop,\r\n                    frequency_penalty,\r\n                    presence_penalty,\r\n                    max_response_length\r\n                );\r\n                elizaLogger.debug(\"Received response from local Llama model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.REDPILL: {\r\n                elizaLogger.debug(\"Initializing RedPill model.\");\r\n                const serverUrl = getEndpoint(provider);\r\n                const openai = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: serverUrl,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: redpillResponse } = await aiGenerateText({\r\n                    model: openai.languageModel(model),\r\n                    prompt: context,\r\n                    temperature: temperature,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = redpillResponse;\r\n                elizaLogger.debug(\"Received response from redpill model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.OPENROUTER: {\r\n                elizaLogger.debug(\"Initializing OpenRouter model.\");\r\n                const serverUrl = getEndpoint(provider);\r\n                const openrouter = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: serverUrl,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: openrouterResponse } = await aiGenerateText({\r\n                    model: openrouter.languageModel(model),\r\n                    prompt: context,\r\n                    temperature: temperature,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = openrouterResponse;\r\n                elizaLogger.debug(\"Received response from OpenRouter model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.AIMLAPI: {\r\n                elizaLogger.debug(\"Initializing AI/ML API model.\");\r\n\r\n                const serverUrl = getEndpoint(provider);\r\n                const aimlapi = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: serverUrl,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: aimlapiResponse } = await aiGenerateText({\r\n                    model: aimlapi.languageModel(model),\r\n                    prompt: context,\r\n                    temperature: temperature,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = aimlapiResponse;\r\n                elizaLogger.debug(\"Received response from AI/ML API model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.OLLAMA:\r\n                {\r\n                    elizaLogger.debug(\"Initializing Ollama model.\");\r\n\r\n                    const ollamaProvider = createOllama({\r\n                        baseURL: getEndpoint(provider) + \"/api\",\r\n                        fetch: runtime.fetch,\r\n                    });\r\n                    const ollama = ollamaProvider(model);\r\n\r\n                    elizaLogger.debug(\"****** MODEL\\n\", model);\r\n\r\n                    const { text: ollamaResponse } = await aiGenerateText({\r\n                        model: ollama,\r\n                        prompt: context,\r\n                        tools: tools,\r\n                        onStepFinish: onStepFinish,\r\n                        temperature: temperature,\r\n                        maxSteps: maxSteps,\r\n                        maxTokens: max_response_length,\r\n                        frequencyPenalty: frequency_penalty,\r\n                        presencePenalty: presence_penalty,\r\n                        experimental_telemetry: experimental_telemetry,\r\n                    });\r\n\r\n                    response = ollamaResponse.replace(\r\n                        /<think>[\\s\\S]*?<\\/think>\\s*\\n*/g,\r\n                        \"\"\r\n                    );\r\n                }\r\n                elizaLogger.debug(\"Received response from Ollama model.\");\r\n                break;\r\n\r\n            case ModelProviderName.HEURIST: {\r\n                elizaLogger.debug(\"Initializing Heurist model.\");\r\n                const heurist = createOpenAI({\r\n                    apiKey: apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: heuristResponse } = await aiGenerateText({\r\n                    model: heurist.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        customSystemPrompt ??\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    maxSteps: maxSteps,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = heuristResponse;\r\n                elizaLogger.debug(\"Received response from Heurist model.\");\r\n                break;\r\n            }\r\n            case ModelProviderName.GAIANET: {\r\n                elizaLogger.debug(\"Initializing GAIANET model.\");\r\n\r\n                var baseURL = getEndpoint(provider);\r\n                if (!baseURL) {\r\n                    switch (modelClass) {\r\n                        case ModelClass.SMALL:\r\n                            baseURL =\r\n                                settings.SMALL_GAIANET_SERVER_URL ||\r\n                                \"https://llama3b.gaia.domains/v1\";\r\n                            break;\r\n                        case ModelClass.MEDIUM:\r\n                            baseURL =\r\n                                settings.MEDIUM_GAIANET_SERVER_URL ||\r\n                                \"https://llama8b.gaia.domains/v1\";\r\n                            break;\r\n                        case ModelClass.LARGE:\r\n                            baseURL =\r\n                                settings.LARGE_GAIANET_SERVER_URL ||\r\n                                \"https://qwen72b.gaia.domains/v1\";\r\n                            break;\r\n                    }\r\n                }\r\n\r\n                elizaLogger.debug(\"Using GAIANET model with baseURL:\", baseURL);\r\n\r\n                const openai = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: openaiResponse } = await aiGenerateText({\r\n                    model: openai.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = openaiResponse;\r\n                elizaLogger.debug(\"Received response from GAIANET model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.ATOMA: {\r\n                elizaLogger.debug(\"Initializing Atoma model.\");\r\n                const atoma = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: atomaResponse } = await aiGenerateText({\r\n                    model: atoma.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = atomaResponse;\r\n                elizaLogger.debug(\"Received response from Atoma model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.GALADRIEL: {\r\n                elizaLogger.debug(\"Initializing Galadriel model.\");\r\n                const headers = {};\r\n                const fineTuneApiKey = runtime.getSetting(\r\n                    \"GALADRIEL_FINE_TUNE_API_KEY\"\r\n                );\r\n                if (fineTuneApiKey) {\r\n                    headers[\"Fine-Tune-Authentication\"] = fineTuneApiKey;\r\n                }\r\n                const galadriel = createOpenAI({\r\n                    headers,\r\n                    apiKey: apiKey,\r\n                    baseURL: endpoint,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: galadrielResponse } = await aiGenerateText({\r\n                    model: galadriel.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = galadrielResponse;\r\n                elizaLogger.debug(\"Received response from Galadriel model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.INFERA: {\r\n                elizaLogger.debug(\"Initializing Infera model.\");\r\n\r\n                const apiKey = settings.INFERA_API_KEY || runtime.token;\r\n\r\n                const infera = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: endpoint,\r\n                    headers: {\r\n                        api_key: apiKey,\r\n                        \"Content-Type\": \"application/json\",\r\n                    },\r\n                });\r\n\r\n                const { text: inferaResponse } = await aiGenerateText({\r\n                    model: infera.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                });\r\n                response = inferaResponse;\r\n                elizaLogger.debug(\"Received response from Infera model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.VENICE: {\r\n                elizaLogger.debug(\"Initializing Venice model.\");\r\n                \r\n                const bypass = parseBooleanFromText(\r\n                    runtime.getSetting(\"BYPASS_VENICE_SYSTEM_PROMPT\")\r\n                )\r\n                    ? async (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {\r\n                        const options: RequestInit = { ...init };\r\n                        if (options?.body) {\r\n                            const body = JSON.parse(options.body as string);\r\n                            body.venice_parameters = {\r\n                                include_venice_system_prompt: false\r\n                            };\r\n                            options.body = JSON.stringify(body);\r\n                        }\r\n                        return runtime.fetch(input, options);\r\n                    }\r\n                    : undefined;\r\n\r\n                const veniceConfig = {\r\n                    apiKey: apiKey,\r\n                    baseURL: endpoint,\r\n                    ...(bypass ? { fetch: bypass } : {})\r\n                };\r\n\r\n                const venice = createOpenAI(veniceConfig);\r\n\r\n                const { text: veniceResponse } = await aiGenerateText({\r\n                    model: venice.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    temperature: temperature,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                });\r\n            \r\n                //rferrari: remove all text from <think> to </think>\\n\\n\r\n                response = veniceResponse\r\n                    .replace(/<think>[\\s\\S]*?<\\/think>\\s*\\n*/g, '');\r\n                elizaLogger.debug(\"Received response from Venice model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.NVIDIA: {\r\n                elizaLogger.debug(\"Initializing NVIDIA model.\");\r\n                const nvidia = createOpenAI({\r\n                    apiKey: apiKey,\r\n                    baseURL: endpoint,\r\n                });\r\n\r\n                const { text: nvidiaResponse } = await aiGenerateText({\r\n                    model: nvidia.languageModel(model),\r\n                    prompt: context,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    temperature: temperature,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                });\r\n\r\n                response = nvidiaResponse;\r\n                elizaLogger.debug(\"Received response from NVIDIA model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.DEEPSEEK: {\r\n                elizaLogger.debug(\"Initializing Deepseek model.\");\r\n                const serverUrl = models[provider].endpoint;\r\n                const deepseek = createOpenAI({\r\n                    apiKey,\r\n                    baseURL: serverUrl,\r\n                    fetch: runtime.fetch,\r\n                });\r\n\r\n                const { text: deepseekResponse } = await aiGenerateText({\r\n                    model: deepseek.languageModel(model),\r\n                    prompt: context,\r\n                    temperature: temperature,\r\n                    system:\r\n                        runtime.character.system ??\r\n                        settings.SYSTEM_PROMPT ??\r\n                        undefined,\r\n                    tools: tools,\r\n                    onStepFinish: onStepFinish,\r\n                    maxSteps: maxSteps,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                });\r\n\r\n                response = deepseekResponse;\r\n                elizaLogger.debug(\"Received response from Deepseek model.\");\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.LIVEPEER: {\r\n                elizaLogger.debug(\"Initializing Livepeer model.\");\r\n\r\n                if (!endpoint) {\r\n                    throw new Error(\"Livepeer Gateway URL is not defined\");\r\n                }\r\n\r\n                const requestBody = {\r\n                    model: model,\r\n                    messages: [\r\n                        {\r\n                            role: \"system\",\r\n                            content:\r\n                                runtime.character.system ??\r\n                                settings.SYSTEM_PROMPT ??\r\n                                \"You are a helpful assistant\",\r\n                        },\r\n                        {\r\n                            role: \"user\",\r\n                            content: context,\r\n                        },\r\n                    ],\r\n                    max_tokens: max_response_length,\r\n                    stream: false,\r\n                };\r\n\r\n                const fetchResponse = await runtime.fetch(endpoint + \"/llm\", {\r\n                    method: \"POST\",\r\n                    headers: {\r\n                        accept: \"text/event-stream\",\r\n                        \"Content-Type\": \"application/json\",\r\n                        Authorization: \"Bearer eliza-app-llm\",\r\n                    },\r\n                    body: JSON.stringify(requestBody),\r\n                });\r\n\r\n                if (!fetchResponse.ok) {\r\n                    const errorText = await fetchResponse.text();\r\n                    throw new Error(\r\n                        `Livepeer request failed (${fetchResponse.status}): ${errorText}`\r\n                    );\r\n                }\r\n\r\n                const json = await fetchResponse.json();\r\n\r\n                if (!json?.choices?.[0]?.message?.content) {\r\n                    throw new Error(\"Invalid response format from Livepeer\");\r\n                }\r\n\r\n                response = json.choices[0].message.content.replace(\r\n                    /<\\|start_header_id\\|>assistant<\\|end_header_id\\|>\\n\\n/,\r\n                    \"\"\r\n                );\r\n                elizaLogger.debug(\r\n                    \"Successfully received response from Livepeer model\"\r\n                );\r\n                break;\r\n            }\r\n\r\n            case ModelProviderName.SECRETAI:\r\n                {\r\n                    elizaLogger.debug(\"Initializing SecretAI model.\");\r\n\r\n                    const secretAiProvider = createOllama({\r\n                        baseURL: getEndpoint(provider) + \"/api\",\r\n                        fetch: runtime.fetch,\r\n                        headers: {\r\n                            \"Content-Type\": \"application/json\",\r\n                            Authorization: `Bearer ${apiKey}`,\r\n                        },\r\n                    });\r\n                    const secretAi = secretAiProvider(model);\r\n\r\n                    const { text: secretAiResponse } = await aiGenerateText({\r\n                        model: secretAi,\r\n                        prompt: context,\r\n                        tools: tools,\r\n                        onStepFinish: onStepFinish,\r\n                        temperature: temperature,\r\n                        maxSteps: maxSteps,\r\n                        maxTokens: max_response_length,\r\n                    });\r\n\r\n                    response = secretAiResponse;\r\n                }\r\n                break;\r\n\r\n            case ModelProviderName.BEDROCK: {\r\n                elizaLogger.debug(\"Initializing Bedrock model.\");\r\n\r\n                const { text: bedrockResponse } = await aiGenerateText({\r\n                    model: bedrock(model),\r\n                    maxSteps: maxSteps,\r\n                    temperature: temperature,\r\n                    maxTokens: max_response_length,\r\n                    frequencyPenalty: frequency_penalty,\r\n                    presencePenalty: presence_penalty,\r\n                    experimental_telemetry: experimental_telemetry,\r\n                    prompt: context\r\n                });\r\n\r\n                response = bedrockResponse;\r\n                elizaLogger.debug(\"Received response from Bedrock model.\");\r\n                break;\r\n            }\r\n\r\n            default: {\r\n                const errorMessage = `Unsupported provider: ${provider}`;\r\n                elizaLogger.error(errorMessage);\r\n                throw new Error(errorMessage);\r\n            }\r\n        }\r\n\r\n        return response;\r\n    } catch (error) {\r\n        elizaLogger.error(\"Error in generateText:\", error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Sends a message to the model to determine if it should respond to the given context.\r\n * @param opts - The options for the generateText request\r\n * @param opts.context The context to evaluate for response\r\n * @param opts.stop A list of strings to stop the generateText at\r\n * @param opts.model The model to use for generateText\r\n * @param opts.frequency_penalty The frequency penalty to apply (0.0 to 2.0)\r\n * @param opts.presence_penalty The presence penalty to apply (0.0 to 2.0)\r\n * @param opts.temperature The temperature to control randomness (0.0 to 2.0)\r\n * @param opts.serverUrl The URL of the API server\r\n * @param opts.max_context_length Maximum allowed context length in tokens\r\n * @param opts.max_response_length Maximum allowed response length in tokens\r\n * @returns Promise resolving to \"RESPOND\", \"IGNORE\", \"STOP\" or null\r\n */\r\nexport async function generateShouldRespond({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<\"RESPOND\" | \"IGNORE\" | \"STOP\" | null> {\r\n    let retryDelay = 1000;\r\n    while (true) {\r\n        try {\r\n            elizaLogger.debug(\r\n                \"Attempting to generate text with context:\",\r\n                context\r\n            );\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n\r\n            elizaLogger.debug(\"Received response from generateText:\", response);\r\n            const parsedResponse = parseShouldRespondFromText(response.trim());\r\n            if (parsedResponse) {\r\n                elizaLogger.debug(\"Parsed response:\", parsedResponse);\r\n                return parsedResponse;\r\n            } else {\r\n                elizaLogger.debug(\"generateShouldRespond no response\");\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateShouldRespond:\", error);\r\n            if (\r\n                error instanceof TypeError &&\r\n                error.message.includes(\"queueTextCompletion\")\r\n            ) {\r\n                elizaLogger.error(\r\n                    \"TypeError: Cannot read properties of null (reading 'queueTextCompletion')\"\r\n                );\r\n            }\r\n        }\r\n\r\n        elizaLogger.log(`Retrying in ${retryDelay}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n\r\n/**\r\n * Splits content into chunks of specified size with optional overlapping bleed sections\r\n * @param content - The text content to split into chunks\r\n * @param chunkSize - The maximum size of each chunk in tokens\r\n * @param bleed - Number of characters to overlap between chunks (default: 100)\r\n * @returns Promise resolving to array of text chunks with bleed sections\r\n */\r\nexport async function splitChunks(\r\n    content: string,\r\n    chunkSize = 1500, // in tokens\r\n    bleed = 100 // in tokens\r\n): Promise<string[]> {\r\n    elizaLogger.debug(`[splitChunks] Starting text split`);\r\n\r\n    // Validate parameters\r\n    if (chunkSize <= 0) {\r\n        elizaLogger.warn(\r\n            `Invalid chunkSize (${chunkSize}), using default 1500`\r\n        );\r\n        chunkSize = 1500;\r\n    }\r\n\r\n    if (bleed >= chunkSize) {\r\n        elizaLogger.warn(\r\n            `Bleed (${bleed}) >= chunkSize (${chunkSize}), adjusting bleed to 1/4 of chunkSize`\r\n        );\r\n        bleed = Math.floor(chunkSize / 4);\r\n    }\r\n\r\n    if (bleed < 0) {\r\n        elizaLogger.warn(`Invalid bleed (${bleed}), using default 100`);\r\n        bleed = 100;\r\n    }\r\n\r\n    const chunks = splitText(content, chunkSize, bleed);\r\n\r\n    elizaLogger.debug(`[splitChunks] Split complete:`, {\r\n        numberOfChunks: chunks.length,\r\n        averageChunkSize:\r\n            chunks.reduce((acc, chunk) => acc + chunk.length, 0) /\r\n            chunks.length,\r\n    });\r\n\r\n    return chunks;\r\n}\r\n\r\nfunction containsPartialUrl(text: string): boolean {\r\n    // Check for common URL patterns or fragments\r\n    return /https?:\\/\\/[^\\s]*$/.test(text) || // URL at the end\r\n        /^[^\\s]*\\.[a-z]{2,}\\//.test(text) || // Domain/path at beginning\r\n        /\\b[a-z0-9]+(\\.com|\\.org|\\.io|\\.eth)\\b/.test(text); // Common TLDs\r\n}\r\n\r\n\r\nfunction estimateTokensFromEnglishLength(stringLength) {\r\n    return Math.round(stringLength / 4); // Rough estimate: 1 token ≈ 4 characters in English\r\n}\r\n\r\nfunction estimateEnglishLengthFromTokens(tokenCount) {\r\n    return tokenCount * 4; // Reverse estimate: 1 token ≈ 4 characters in English\r\n}\r\n\r\n/// The splitText tries to respect the chunkSize, but to maintain the semantic meaning of the text (eg. URLs) we can go over the chunkSize by 50%\r\nexport function splitText(content: string, chunkSize: number, bleed: number): string[] {\r\n    // try to split by double newlines\r\n    const paragraphs = content.split(/\\n\\s*\\n/);\r\n\r\n    // Convert chunk size and bleed from tokens to approximate character length\r\n    const chunkCharSize = estimateEnglishLengthFromTokens(chunkSize);\r\n\r\n    // If content is smaller than estimated chunk size, return it as a single chunk\r\n    if (content.length <= chunkCharSize) {\r\n        return [content];\r\n    }\r\n\r\n    const chunks: string[] = [];\r\n    let currentChunk = \"\";\r\n\r\n    for (const paragraph of paragraphs) {\r\n        const trimmedParagraph = paragraph.trim();\r\n\r\n        if (trimmedParagraph.length === 0) continue;\r\n\r\n        // if this paragraph fits in the current chunk, add it\r\n        if (currentChunk.length + trimmedParagraph.length <= chunkSize) {\r\n            currentChunk += (currentChunk.length > 0 ? \"\\n\\n\" : \"\") + trimmedParagraph;\r\n            continue;\r\n        }\r\n\r\n        // if current chunk has content, flush it first\r\n        if (currentChunk.length > 0) {\r\n            // Check if current chunk ends with a partial URL or next paragraph starts with one\r\n            if (containsPartialUrl(currentChunk.trim()) || containsPartialUrl(trimmedParagraph)) {\r\n                // Try to combine them if they're not too large together\r\n                if (currentChunk.length + trimmedParagraph.length <= chunkSize * 1.5) {\r\n                    currentChunk += \"\\n\\n\" + trimmedParagraph;\r\n                    continue;\r\n                }\r\n            }\r\n\r\n            chunks.push(currentChunk.trim());\r\n            currentChunk = \"\";\r\n        }\r\n\r\n        // exceeds chunk size, split by sentences\r\n        if (trimmedParagraph.length > chunkSize) {\r\n            // sentence regex requires space/quote after punctuation to avoid splitting eg URLs, IPs, etc\r\n            const sentenceRegex = /[^.!?]+(?:[.!?](?:[\"']|\\s|$))+/g;\r\n            const sentences = trimmedParagraph.match(sentenceRegex) || [trimmedParagraph];\r\n\r\n            for (const sentence of sentences) {\r\n                const trimmedSentence = sentence.trim();\r\n\r\n                if (trimmedSentence.length === 0) continue;\r\n\r\n                // If sentence fits in current chunk, add it\r\n                if (currentChunk.length + trimmedSentence.length <= chunkSize) {\r\n                    currentChunk += (currentChunk.length > 0 ? \" \" : \"\") + trimmedSentence;\r\n                } else {\r\n                    // content in the current chunk -> flush it\r\n                    if (currentChunk.length > 0) {\r\n                        // Check for URL splits again\r\n                        if (containsPartialUrl(currentChunk) || containsPartialUrl(trimmedSentence)) {\r\n                            // Try to keep sentences with URLs together if possible\r\n                            if (currentChunk.length + trimmedSentence.length <= chunkSize * 1.5) {\r\n                                currentChunk += \" \" + trimmedSentence;\r\n                                continue;\r\n                            }\r\n                        }\r\n\r\n                        chunks.push(currentChunk.trim());\r\n                        currentChunk = \"\";\r\n                    }\r\n\r\n                    // the sentence itself is longer than chunk size, just include it as its own chunk\r\n                    if (trimmedSentence.length > chunkSize) {\r\n                        chunks.push(trimmedSentence);\r\n                    } else {\r\n                        currentChunk = trimmedSentence;\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            // is too large for current chunk but fits in a chunk by itself\r\n            chunks.push(trimmedParagraph);\r\n        }\r\n    }\r\n\r\n    // add the last chunk if it has content\r\n    if (currentChunk.trim().length > 0) {\r\n        chunks.push(currentChunk.trim());\r\n    }\r\n\r\n    // If no chunks were created like the content is short just return content\r\n    return chunks.length > 0 ? chunks : [content];\r\n}\r\n\r\n/**\r\n * Sends a message to the model and parses the response as a boolean value\r\n * @param opts - The options for the generateText request\r\n * @param opts.context The context to evaluate for the boolean response\r\n * @param opts.stop A list of strings to stop the generateText at\r\n * @param opts.model The model to use for generateText\r\n * @param opts.frequency_penalty The frequency penalty to apply (0.0 to 2.0)\r\n * @param opts.presence_penalty The presence penalty to apply (0.0 to 2.0)\r\n * @param opts.temperature The temperature to control randomness (0.0 to 2.0)\r\n * @param opts.serverUrl The URL of the API server\r\n * @param opts.max_context_length Maximum allowed context length in tokens\r\n * @param opts.max_response_length Maximum allowed response length in tokens\r\n * @returns Promise resolving to a boolean value parsed from the model's response\r\n */\r\nexport async function generateTrueOrFalse({\r\n    runtime,\r\n    context = \"\",\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<boolean> {\r\n    let retryDelay = 1000;\r\n    const modelSettings = getModelSettings(runtime.modelProvider, modelClass);\r\n    const stop = Array.from(\r\n        new Set([...(modelSettings.stop || []), [\"\\n\"]])\r\n    ) as string[];\r\n\r\n    while (true) {\r\n        try {\r\n            const response = await generateText({\r\n                stop,\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n\r\n            const parsedResponse = parseBooleanFromText(response.trim());\r\n            if (parsedResponse !== null) {\r\n                return parsedResponse;\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateTrueOrFalse:\", error);\r\n        }\r\n\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n\r\n/**\r\n * Send a message to the model and parse the response as a string array\r\n * @param opts - The options for the generateText request\r\n * @param opts.context The context/prompt to send to the model\r\n * @param opts.stop Array of strings that will stop the model's generation if encountered\r\n * @param opts.model The language model to use\r\n * @param opts.frequency_penalty The frequency penalty to apply (0.0 to 2.0)\r\n * @param opts.presence_penalty The presence penalty to apply (0.0 to 2.0)\r\n * @param opts.temperature The temperature to control randomness (0.0 to 2.0)\r\n * @param opts.serverUrl The URL of the API server\r\n * @param opts.token The API token for authentication\r\n * @param opts.max_context_length Maximum allowed context length in tokens\r\n * @param opts.max_response_length Maximum allowed response length in tokens\r\n * @returns Promise resolving to an array of strings parsed from the model's response\r\n */\r\nexport async function generateTextArray({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<string[]> {\r\n    if (!context) {\r\n        elizaLogger.error(\"generateTextArray context is empty\");\r\n        return [];\r\n    }\r\n    let retryDelay = 1000;\r\n\r\n    while (true) {\r\n        try {\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n\r\n            const parsedResponse = parseJsonArrayFromText(response);\r\n            if (parsedResponse) {\r\n                return parsedResponse;\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateTextArray:\", error);\r\n        }\r\n\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n\r\nexport async function generateObjectDeprecated({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<any> {\r\n    if (!context) {\r\n        elizaLogger.error(\"generateObjectDeprecated context is empty\");\r\n        return null;\r\n    }\r\n    let retryDelay = 1000;\r\n\r\n    while (true) {\r\n        try {\r\n            // this is slightly different than generateObjectArray, in that we parse object, not object array\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n            const parsedResponse = parseJSONObjectFromText(response);\r\n            if (parsedResponse) {\r\n                return parsedResponse;\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateObject:\", error);\r\n        }\r\n\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n\r\nexport async function generateObjectArray({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<any[]> {\r\n    if (!context) {\r\n        elizaLogger.error(\"generateObjectArray context is empty\");\r\n        return [];\r\n    }\r\n    let retryDelay = 1000;\r\n\r\n    while (true) {\r\n        try {\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n\r\n            const parsedResponse = parseJsonArrayFromText(response);\r\n            if (parsedResponse) {\r\n                return parsedResponse;\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateTextArray:\", error);\r\n        }\r\n\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n\r\n/**\r\n * Send a message to the model for generateText.\r\n * @param opts - The options for the generateText request.\r\n * @param opts.context The context of the message to be completed.\r\n * @param opts.stop A list of strings to stop the generateText at.\r\n * @param opts.model The model to use for generateText.\r\n * @param opts.frequency_penalty The frequency penalty to apply to the generateText.\r\n * @param opts.presence_penalty The presence penalty to apply to the generateText.\r\n * @param opts.temperature The temperature to apply to the generateText.\r\n * @param opts.max_context_length The maximum length of the context to apply to the generateText.\r\n * @returns The completed message.\r\n */\r\nexport async function generateMessageResponse({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<Content> {\r\n    const modelSettings = getModelSettings(runtime.modelProvider, modelClass);\r\n    const max_context_length = modelSettings.maxInputTokens;\r\n\r\n    context = await trimTokens(context, max_context_length, runtime);\r\n    elizaLogger.debug(\"Context:\", context);\r\n    let retryLength = 1000; // exponential backoff\r\n    while (true) {\r\n        try {\r\n            elizaLogger.log(\"Generating message response..\");\r\n\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n\r\n            // try parsing the response as JSON, if null then try again\r\n            const parsedContent = parseJSONObjectFromText(response) as Content;\r\n            if (!parsedContent) {\r\n                elizaLogger.debug(\"parsedContent is null, retrying\");\r\n                continue;\r\n            }\r\n\r\n            return parsedContent;\r\n        } catch (error) {\r\n            elizaLogger.error(\"ERROR:\", error);\r\n            // wait for 2 seconds\r\n            retryLength *= 2;\r\n            await new Promise((resolve) => setTimeout(resolve, retryLength));\r\n            elizaLogger.debug(\"Retrying...\");\r\n        }\r\n    }\r\n}\r\n\r\nexport const generateImage = async (\r\n    data: {\r\n        prompt: string;\r\n        width: number;\r\n        height: number;\r\n        count?: number;\r\n        negativePrompt?: string;\r\n        numIterations?: number;\r\n        guidanceScale?: number;\r\n        seed?: number;\r\n        modelId?: string;\r\n        jobId?: string;\r\n        stylePreset?: string;\r\n        hideWatermark?: boolean;\r\n        safeMode?: boolean;\r\n        cfgScale?: number;\r\n    },\r\n    runtime: IAgentRuntime\r\n): Promise<{\r\n    success: boolean;\r\n    data?: string[];\r\n    error?: any;\r\n}> => {\r\n    const modelSettings = getImageModelSettings(runtime.imageModelProvider);\r\n    if (!modelSettings) {\r\n        elizaLogger.warn(\r\n            \"No model settings found for the image model provider.\"\r\n        );\r\n        return { success: false, error: \"No model settings available\" };\r\n    }\r\n    const model = modelSettings.name;\r\n    elizaLogger.info(\"Generating image with options:\", {\r\n        imageModelProvider: model,\r\n    });\r\n\r\n    const apiKey =\r\n        runtime.imageModelProvider === runtime.modelProvider\r\n            ? runtime.token\r\n            : (() => {\r\n                  // First try to match the specific provider\r\n                  switch (runtime.imageModelProvider) {\r\n                      case ModelProviderName.HEURIST:\r\n                          return runtime.getSetting(\"HEURIST_API_KEY\");\r\n                      case ModelProviderName.TOGETHER:\r\n                          return runtime.getSetting(\"TOGETHER_API_KEY\");\r\n                      case ModelProviderName.FAL:\r\n                          return runtime.getSetting(\"FAL_API_KEY\");\r\n                      case ModelProviderName.OPENAI:\r\n                          return runtime.getSetting(\"OPENAI_API_KEY\");\r\n                      case ModelProviderName.VENICE:\r\n                          return runtime.getSetting(\"VENICE_API_KEY\");\r\n                      case ModelProviderName.LIVEPEER:\r\n                          return runtime.getSetting(\"LIVEPEER_GATEWAY_URL\");\r\n                      case ModelProviderName.SECRETAI:\r\n                          return runtime.getSetting(\"SECRET_AI_API_KEY\");\r\n                      case ModelProviderName.NEARAI:\r\n                          try {\r\n                              // Read auth config from ~/.nearai/config.json if it exists\r\n                              const config = JSON.parse(\r\n                                  fs.readFileSync(\r\n                                      path.join(\r\n                                          os.homedir(),\r\n                                          \".nearai/config.json\"\r\n                                      ),\r\n                                      \"utf8\"\r\n                                  )\r\n                              );\r\n                              return JSON.stringify(config?.auth);\r\n                          } catch (e) {\r\n                              elizaLogger.warn(\r\n                                  `Error loading NEAR AI config. The environment variable NEARAI_API_KEY will be used. ${e}`\r\n                              );\r\n                          }\r\n                          return runtime.getSetting(\"NEARAI_API_KEY\");\r\n                      default:\r\n                          // If no specific match, try the fallback chain\r\n                          return (\r\n                              runtime.getSetting(\"HEURIST_API_KEY\") ??\r\n                              runtime.getSetting(\"NINETEEN_AI_API_KEY\") ??\r\n                              runtime.getSetting(\"TOGETHER_API_KEY\") ??\r\n                              runtime.getSetting(\"FAL_API_KEY\") ??\r\n                              runtime.getSetting(\"OPENAI_API_KEY\") ??\r\n                              runtime.getSetting(\"VENICE_API_KEY\") ??\r\n                              runtime.getSetting(\"LIVEPEER_GATEWAY_URL\")\r\n                          );\r\n                  }\r\n              })();\r\n    try {\r\n        if (runtime.imageModelProvider === ModelProviderName.HEURIST) {\r\n            const response = await fetch(\r\n                \"http://sequencer.heurist.xyz/submit_job\",\r\n                {\r\n                    method: \"POST\",\r\n                    headers: {\r\n                        Authorization: `Bearer ${apiKey}`,\r\n                        \"Content-Type\": \"application/json\",\r\n                    },\r\n                    body: JSON.stringify({\r\n                        job_id: data.jobId || crypto.randomUUID(),\r\n                        model_input: {\r\n                            SD: {\r\n                                prompt: data.prompt,\r\n                                neg_prompt: data.negativePrompt,\r\n                                num_iterations: data.numIterations || 20,\r\n                                width: data.width || 512,\r\n                                height: data.height || 512,\r\n                                guidance_scale: data.guidanceScale || 3,\r\n                                seed: data.seed || -1,\r\n                            },\r\n                        },\r\n                        model_id: model,\r\n                        deadline: 60,\r\n                        priority: 1,\r\n                    }),\r\n                }\r\n            );\r\n\r\n            if (!response.ok) {\r\n                throw new Error(\r\n                    `Heurist image generation failed: ${response.statusText}`\r\n                );\r\n            }\r\n\r\n            const imageURL = await response.json();\r\n            return { success: true, data: [imageURL] };\r\n        } else if (\r\n            runtime.imageModelProvider === ModelProviderName.TOGETHER ||\r\n            // for backwards compat\r\n            runtime.imageModelProvider === ModelProviderName.LLAMACLOUD\r\n        ) {\r\n            const together = new Together({ apiKey: apiKey as string });\r\n            const response = await together.images.create({\r\n                model: model,\r\n                prompt: data.prompt,\r\n                width: data.width,\r\n                height: data.height,\r\n                steps: modelSettings?.steps ?? 4,\r\n                n: data.count,\r\n            });\r\n\r\n            // Add type assertion to handle the response properly\r\n            const togetherResponse =\r\n                response as unknown as TogetherAIImageResponse;\r\n\r\n            if (\r\n                !togetherResponse.data ||\r\n                !Array.isArray(togetherResponse.data)\r\n            ) {\r\n                throw new Error(\"Invalid response format from Together AI\");\r\n            }\r\n\r\n            // Rest of the code remains the same...\r\n            const base64s = await Promise.all(\r\n                togetherResponse.data.map(async (image) => {\r\n                    if (!image.url) {\r\n                        elizaLogger.error(\"Missing URL in image data:\", image);\r\n                        throw new Error(\"Missing URL in Together AI response\");\r\n                    }\r\n\r\n                    // Fetch the image from the URL\r\n                    const imageResponse = await fetch(image.url);\r\n                    if (!imageResponse.ok) {\r\n                        throw new Error(\r\n                            `Failed to fetch image: ${imageResponse.statusText}`\r\n                        );\r\n                    }\r\n\r\n                    // Convert to blob and then to base64\r\n                    const blob = await imageResponse.blob();\r\n                    const arrayBuffer = await blob.arrayBuffer();\r\n                    const base64 = Buffer.from(arrayBuffer).toString(\"base64\");\r\n\r\n                    // Return with proper MIME type\r\n                    return `data:image/jpeg;base64,${base64}`;\r\n                })\r\n            );\r\n\r\n            if (base64s.length === 0) {\r\n                throw new Error(\"No images generated by Together AI\");\r\n            }\r\n\r\n            elizaLogger.debug(`Generated ${base64s.length} images`);\r\n            return { success: true, data: base64s };\r\n        } else if (runtime.imageModelProvider === ModelProviderName.FAL) {\r\n            fal.config({\r\n                credentials: apiKey as string,\r\n            });\r\n\r\n            // Prepare the input parameters according to their schema\r\n            const input = {\r\n                prompt: data.prompt,\r\n                image_size: \"square\" as const,\r\n                num_inference_steps: modelSettings?.steps ?? 50,\r\n                guidance_scale: data.guidanceScale || 3.5,\r\n                num_images: data.count,\r\n                enable_safety_checker:\r\n                    runtime.getSetting(\"FAL_AI_ENABLE_SAFETY_CHECKER\") ===\r\n                    \"true\",\r\n                safety_tolerance: Number(\r\n                    runtime.getSetting(\"FAL_AI_SAFETY_TOLERANCE\") || \"2\"\r\n                ),\r\n                output_format: \"png\" as const,\r\n                seed: data.seed ?? 6252023,\r\n                ...(runtime.getSetting(\"FAL_AI_LORA_PATH\")\r\n                    ? {\r\n                        loras: [\r\n                            {\r\n                                path: runtime.getSetting(\"FAL_AI_LORA_PATH\"),\r\n                                scale: 1,\r\n                            },\r\n                        ],\r\n                    }\r\n                    : {}),\r\n            };\r\n\r\n            // Subscribe to the model\r\n            const result = await fal.subscribe(model, {\r\n                input,\r\n                logs: true,\r\n                onQueueUpdate: (update) => {\r\n                    if (update.status === \"IN_PROGRESS\") {\r\n                        elizaLogger.info(update.logs.map((log) => log.message));\r\n                    }\r\n                },\r\n            });\r\n            // Convert the returned image URLs to base64 to match existing functionality\r\n            const base64Promises = result.data.images.map(async (image) => {\r\n                const response = await fetch(image.url);\r\n                const blob = await response.blob();\r\n                const buffer = await blob.arrayBuffer();\r\n                const base64 = Buffer.from(buffer).toString(\"base64\");\r\n                return `data:${image.content_type};base64,${base64}`;\r\n            });\r\n\r\n            const base64s = await Promise.all(base64Promises);\r\n            return { success: true, data: base64s };\r\n        } else if (runtime.imageModelProvider === ModelProviderName.VENICE) {\r\n            const response = await fetch(\r\n                \"https://api.venice.ai/api/v1/image/generate\",\r\n                {\r\n                    method: \"POST\",\r\n                    headers: {\r\n                        Authorization: `Bearer ${apiKey}`,\r\n                        \"Content-Type\": \"application/json\",\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model: model,\r\n                        prompt: data.prompt,\r\n                        cfg_scale: data.guidanceScale,\r\n                        negative_prompt: data.negativePrompt,\r\n                        width: data.width,\r\n                        height: data.height,\r\n                        steps: data.numIterations,\r\n                        safe_mode: data.safeMode,\r\n                        seed: data.seed,\r\n                        style_preset: data.stylePreset,\r\n                        hide_watermark: data.hideWatermark,\r\n                    }),\r\n                }\r\n            );\r\n\r\n            const result = await response.json();\r\n\r\n            if (!result.images || !Array.isArray(result.images)) {\r\n                throw new Error(\"Invalid response format from Venice AI\");\r\n            }\r\n\r\n            const base64s = result.images.map((base64String) => {\r\n                if (!base64String) {\r\n                    throw new Error(\r\n                        \"Empty base64 string in Venice AI response\"\r\n                    );\r\n                }\r\n                return `data:image/png;base64,${base64String}`;\r\n            });\r\n\r\n            return { success: true, data: base64s };\r\n        } else if (\r\n            runtime.imageModelProvider === ModelProviderName.NINETEEN_AI\r\n        ) {\r\n            const response = await fetch(\r\n                \"https://api.nineteen.ai/v1/text-to-image\",\r\n                {\r\n                    method: \"POST\",\r\n                    headers: {\r\n                        Authorization: `Bearer ${apiKey}`,\r\n                        \"Content-Type\": \"application/json\",\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model: model,\r\n                        prompt: data.prompt,\r\n                        negative_prompt: data.negativePrompt,\r\n                        width: data.width,\r\n                        height: data.height,\r\n                        steps: data.numIterations,\r\n                        cfg_scale: data.guidanceScale || 3,\r\n                    }),\r\n                }\r\n            );\r\n\r\n            const result = await response.json();\r\n\r\n            if (!result.images || !Array.isArray(result.images)) {\r\n                throw new Error(\"Invalid response format from Nineteen AI\");\r\n            }\r\n\r\n            const base64s = result.images.map((base64String) => {\r\n                if (!base64String) {\r\n                    throw new Error(\r\n                        \"Empty base64 string in Nineteen AI response\"\r\n                    );\r\n                }\r\n                return `data:image/png;base64,${base64String}`;\r\n            });\r\n\r\n            return { success: true, data: base64s };\r\n        } else if (runtime.imageModelProvider === ModelProviderName.LIVEPEER) {\r\n            if (!apiKey) {\r\n                throw new Error(\"Livepeer Gateway is not defined\");\r\n            }\r\n            try {\r\n                const baseUrl = new URL(apiKey);\r\n                if (!baseUrl.protocol.startsWith(\"http\")) {\r\n                    throw new Error(\"Invalid Livepeer Gateway URL protocol\");\r\n                }\r\n\r\n                const response = await fetch(\r\n                    `${baseUrl.toString()}text-to-image`,\r\n                    {\r\n                        method: \"POST\",\r\n                        headers: {\r\n                            \"Content-Type\": \"application/json\",\r\n                            Authorization: \"Bearer eliza-app-img\",\r\n                        },\r\n                        body: JSON.stringify({\r\n                            model_id:\r\n                                data.modelId || \"ByteDance/SDXL-Lightning\",\r\n                            prompt: data.prompt,\r\n                            width: data.width || 1024,\r\n                            height: data.height || 1024,\r\n                        }),\r\n                    }\r\n                );\r\n                const result = await response.json();\r\n                if (!result.images?.length) {\r\n                    throw new Error(\"No images generated\");\r\n                }\r\n                const base64Images = await Promise.all(\r\n                    result.images.map(async (image) => {\r\n                        console.log(\"imageUrl console log\", image.url);\r\n                        let imageUrl;\r\n                        if (image.url.includes(\"http\")) {\r\n                            imageUrl = image.url;\r\n                        } else {\r\n                            imageUrl = `${apiKey}${image.url}`;\r\n                        }\r\n                        const imageResponse = await fetch(imageUrl);\r\n                        if (!imageResponse.ok) {\r\n                            throw new Error(\r\n                                `Failed to fetch image: ${imageResponse.statusText}`\r\n                            );\r\n                        }\r\n                        const blob = await imageResponse.blob();\r\n                        const arrayBuffer = await blob.arrayBuffer();\r\n                        const base64 =\r\n                            Buffer.from(arrayBuffer).toString(\"base64\");\r\n                        return `data:image/jpeg;base64,${base64}`;\r\n                    })\r\n                );\r\n                return {\r\n                    success: true,\r\n                    data: base64Images,\r\n                };\r\n            } catch (error) {\r\n                console.error(error);\r\n                return { success: false, error: error };\r\n            }\r\n        } else if (runtime.imageModelProvider === ModelProviderName.NEARAI) {\r\n            let targetSize = `${data.width}x${data.height}`;\r\n            if (\r\n                targetSize !== \"1024x1024\" &&\r\n                targetSize !== \"1792x1024\" &&\r\n                targetSize !== \"1024x1792\" &&\r\n                targetSize !== \"512x512\" &&\r\n                targetSize !== \"256x256\"\r\n            ) {\r\n                targetSize = \"1024x1024\";\r\n            }\r\n            // NEAR AI uses OpenAI compatible API\r\n            const openai = new OpenAI({\r\n                baseURL: getEndpoint(ModelProviderName.NEARAI),\r\n                apiKey,\r\n            });\r\n            const response = await openai.images.generate({\r\n                model,\r\n                prompt: data.prompt,\r\n                size: targetSize as \"1024x1024\" | \"1792x1024\" | \"1024x1792\" | \"512x512\" | \"256x256\",\r\n                n: data.count,\r\n                response_format: \"b64_json\",\r\n            });\r\n            const base64s = response.data.map(\r\n                (image) => `data:image/png;base64,${image.b64_json}`\r\n            );\r\n            return { success: true, data: base64s };\r\n        } else {\r\n            let targetSize = `${data.width}x${data.height}`;\r\n            if (\r\n                targetSize !== \"1024x1024\" &&\r\n                targetSize !== \"1792x1024\" &&\r\n                targetSize !== \"1024x1792\"\r\n            ) {\r\n                targetSize = \"1024x1024\";\r\n            }\r\n            const openaiApiKey = runtime.getSetting(\"OPENAI_API_KEY\") as string;\r\n            if (!openaiApiKey) {\r\n                throw new Error(\"OPENAI_API_KEY is not set\");\r\n            }\r\n            const openai = new OpenAI({\r\n                apiKey: openaiApiKey as string,\r\n            });\r\n            const response = await openai.images.generate({\r\n                model,\r\n                prompt: data.prompt,\r\n                size: targetSize as \"1024x1024\" | \"1792x1024\" | \"1024x1792\",\r\n                n: data.count,\r\n                response_format: \"b64_json\",\r\n            });\r\n            const base64s = response.data.map(\r\n                (image) => `data:image/png;base64,${image.b64_json}`\r\n            );\r\n            return { success: true, data: base64s };\r\n        }\r\n    } catch (error) {\r\n        console.error(error);\r\n        return { success: false, error: error };\r\n    }\r\n};\r\n\r\nexport const generateCaption = async (\r\n    data: { imageUrl: string },\r\n    runtime: IAgentRuntime\r\n): Promise<{\r\n    title: string;\r\n    description: string;\r\n}> => {\r\n    const { imageUrl } = data;\r\n    const imageDescriptionService =\r\n        runtime.getService<IImageDescriptionService>(\r\n            ServiceType.IMAGE_DESCRIPTION\r\n        );\r\n\r\n    if (!imageDescriptionService) {\r\n        throw new Error(\"Image description service not found\");\r\n    }\r\n\r\n    const resp = await imageDescriptionService.describeImage(imageUrl);\r\n    return {\r\n        title: resp.title.trim(),\r\n        description: resp.description.trim(),\r\n    };\r\n};\r\n\r\n/**\r\n * Configuration options for generating objects with a model.\r\n */\r\nexport interface GenerationOptions {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n    schema?: ZodSchema;\r\n    schemaName?: string;\r\n    schemaDescription?: string;\r\n    stop?: string[];\r\n    mode?: \"auto\" | \"json\" | \"tool\";\r\n    experimental_providerMetadata?: Record<string, unknown>;\r\n    // verifiableInference?: boolean;\r\n    // verifiableInferenceAdapter?: IVerifiableInferenceAdapter;\r\n    // verifiableInferenceOptions?: VerifiableInferenceOptions;\r\n}\r\n\r\n/**\r\n * Base settings for model generation.\r\n */\r\ninterface ModelSettings {\r\n    prompt: string;\r\n    temperature: number;\r\n    maxTokens: number;\r\n    frequencyPenalty: number;\r\n    presencePenalty: number;\r\n    stop?: string[];\r\n    experimental_telemetry?: TelemetrySettings;\r\n}\r\n\r\n/**\r\n * Generates structured objects from a prompt using specified AI models and configuration options.\r\n *\r\n * @param {GenerationOptions} options - Configuration options for generating objects.\r\n * @returns {Promise<any[]>} - A promise that resolves to an array of generated objects.\r\n * @throws {Error} - Throws an error if the provider is unsupported or if generation fails.\r\n */\r\nexport const generateObject = async ({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    stop,\r\n    mode = \"json\",\r\n}: // verifiableInference = false,\r\n// verifiableInferenceAdapter,\r\n// verifiableInferenceOptions,\r\nGenerationOptions): Promise<GenerateObjectResult<unknown>> => {\r\n    if (!context) {\r\n        const errorMessage = \"generateObject context is empty\";\r\n        console.error(errorMessage);\r\n        throw new Error(errorMessage);\r\n    }\r\n\r\n    const provider = runtime.modelProvider;\r\n    const modelSettings = getModelSettings(runtime.modelProvider, modelClass);\r\n    const model = modelSettings.name;\r\n    const temperature = modelSettings.temperature;\r\n    const frequency_penalty = modelSettings.frequency_penalty;\r\n    const presence_penalty = modelSettings.presence_penalty;\r\n    const max_context_length = modelSettings.maxInputTokens;\r\n    const max_response_length = modelSettings.maxOutputTokens;\r\n    const experimental_telemetry = modelSettings.experimental_telemetry;\r\n    const apiKey = runtime.token;\r\n\r\n    try {\r\n        context = await trimTokens(context, max_context_length, runtime);\r\n\r\n        const modelOptions: ModelSettings = {\r\n            prompt: context,\r\n            temperature,\r\n            maxTokens: max_response_length,\r\n            frequencyPenalty: frequency_penalty,\r\n            presencePenalty: presence_penalty,\r\n            stop: stop || modelSettings.stop,\r\n            experimental_telemetry: experimental_telemetry,\r\n        };\r\n\r\n        const response = await handleProvider({\r\n            provider,\r\n            model,\r\n            apiKey,\r\n            schema,\r\n            schemaName,\r\n            schemaDescription,\r\n            mode,\r\n            modelOptions,\r\n            runtime,\r\n            context,\r\n            modelClass,\r\n            // verifiableInference,\r\n            // verifiableInferenceAdapter,\r\n            // verifiableInferenceOptions,\r\n        });\r\n\r\n        return response;\r\n    } catch (error) {\r\n        console.error(\"Error in generateObject:\", error);\r\n        throw error;\r\n    }\r\n};\r\n\r\n/**\r\n * Handles AI generation based on the specified provider.\r\n *\r\n * @param {ProviderOptions} options - Configuration options specific to the provider.\r\n * @returns {Promise<any[]>} - A promise that resolves to an array of generated objects.\r\n */\r\nexport async function handleProvider(\r\n    options: ProviderOptions\r\n): Promise<GenerationResult> {\r\n    const {\r\n        provider,\r\n        runtime,\r\n        context,\r\n        modelClass,\r\n        //verifiableInference,\r\n        //verifiableInferenceAdapter,\r\n        //verifiableInferenceOptions,\r\n    } = options;\r\n    switch (provider) {\r\n        case ModelProviderName.OPENAI:\r\n        case ModelProviderName.ETERNALAI:\r\n        case ModelProviderName.ALI_BAILIAN:\r\n        case ModelProviderName.VOLENGINE:\r\n        case ModelProviderName.LLAMACLOUD:\r\n        case ModelProviderName.TOGETHER:\r\n        case ModelProviderName.NANOGPT:\r\n        case ModelProviderName.AKASH_CHAT_API:\r\n        case ModelProviderName.LMSTUDIO:\r\n        case ModelProviderName.KLUSTERAI:\r\n            return await handleOpenAI(options);\r\n        case ModelProviderName.ANTHROPIC:\r\n        case ModelProviderName.CLAUDE_VERTEX:\r\n            return await handleAnthropic(options);\r\n        case ModelProviderName.GROK:\r\n            return await handleGrok(options);\r\n        case ModelProviderName.GROQ:\r\n            return await handleGroq(options);\r\n        case ModelProviderName.LLAMALOCAL:\r\n            return await generateObjectDeprecated({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n        case ModelProviderName.GOOGLE:\r\n            return await handleGoogle(options);\r\n        case ModelProviderName.MISTRAL:\r\n            return await handleMistral(options);\r\n        case ModelProviderName.REDPILL:\r\n            return await handleRedPill(options);\r\n        case ModelProviderName.OPENROUTER:\r\n            return await handleOpenRouter(options);\r\n        case ModelProviderName.AIMLAPI:\r\n            return await handleAIMLAPI(options);\r\n        case ModelProviderName.OLLAMA:\r\n            return await handleOllama(options);\r\n        case ModelProviderName.DEEPSEEK:\r\n            return await handleDeepSeek(options);\r\n        case ModelProviderName.LIVEPEER:\r\n            return await handleLivepeer(options);\r\n        case ModelProviderName.SECRETAI:\r\n            return await handleSecretAi(options);\r\n        case ModelProviderName.NEARAI:\r\n            return await handleNearAi(options);\r\n        case ModelProviderName.BEDROCK:\r\n            return await handleBedrock(options);\r\n        default: {\r\n            const errorMessage = `Unsupported provider: ${provider}`;\r\n            elizaLogger.error(errorMessage);\r\n            throw new Error(errorMessage);\r\n        }\r\n    }\r\n}\r\n/**\r\n * Handles object generation for OpenAI.\r\n *\r\n * @param {ProviderOptions} options - Options specific to OpenAI.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleOpenAI({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    provider,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerateObjectResult<unknown>> {\r\n    const endpoint = runtime.character.modelEndpointOverride || getEndpoint(provider);\r\n    const baseURL = getCloudflareGatewayBaseURL(runtime, \"openai\") || endpoint;\r\n    const openai = createOpenAI({\r\n        apiKey,\r\n        baseURL,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: openai.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Anthropic models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Anthropic.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleAnthropic({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"auto\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    elizaLogger.debug(\"Handling Anthropic request with Cloudflare check\");\r\n    if (mode === \"json\") {\r\n        elizaLogger.warn(\"Anthropic mode is set to json, changing to auto\");\r\n        mode = \"auto\";\r\n    }\r\n    const baseURL = getCloudflareGatewayBaseURL(runtime, \"anthropic\");\r\n    elizaLogger.debug(\"Anthropic handleAnthropic baseURL:\", { baseURL });\r\n\r\n    const anthropic = createAnthropic({\r\n        apiKey,\r\n        baseURL,\r\n        fetch: runtime.fetch\r\n    });\r\n    return await aiGenerateObject({\r\n        model: anthropic.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Grok models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Grok.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleGrok({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const grok = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.grok.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: grok.languageModel(model, { parallelToolCalls: false }),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Groq models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Groq.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleGroq({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    elizaLogger.debug(\"Handling Groq request with Cloudflare check\");\r\n    const baseURL = getCloudflareGatewayBaseURL(runtime, \"groq\");\r\n    elizaLogger.debug(\"Groq handleGroq baseURL:\", { baseURL });\r\n\r\n    const groq = createGroq({\r\n        apiKey,\r\n        baseURL,\r\n        fetch: runtime.fetch\r\n    });\r\n    return await aiGenerateObject({\r\n        model: groq.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Google models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Google.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleGoogle({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerateObjectResult<unknown>> {\r\n    const google = createGoogleGenerativeAI({\r\n        apiKey,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: google(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Mistral models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Mistral.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleMistral({\r\n    model,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode,\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const mistral = createMistral({ fetch: runtime.fetch });\r\n    return aiGenerateObject({\r\n        model: mistral(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Redpill models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Redpill.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleRedPill({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const redPill = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.redpill.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: redPill.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for OpenRouter models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to OpenRouter.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleOpenRouter({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const openRouter = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.openrouter.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: openRouter.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for AI/ML API models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to AI/ML API.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleAIMLAPI({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const aimlapi = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.aimlapi.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: aimlapi.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Ollama models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Ollama.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleOllama({\r\n    model,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    provider,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const ollamaProvider = createOllama({\r\n        baseURL: getEndpoint(provider) + \"/api\",\r\n        fetch: runtime.fetch\r\n    });\r\n    const ollama = ollamaProvider(model);\r\n    return aiGenerateObject({\r\n        model: ollama,\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for DeepSeek models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to DeepSeek.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleDeepSeek({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode,\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const openai = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.deepseek.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: openai.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Amazon Bedrock models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Amazon Bedrock.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleBedrock({\r\n    model,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode,\r\n    modelOptions,\r\n    provider,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const bedrockClient = bedrock(model);\r\n    return aiGenerateObject({\r\n        model: bedrockClient,\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\nasync function handleLivepeer({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode,\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    console.log(\"Livepeer provider api key:\", apiKey);\r\n    if (!apiKey) {\r\n        throw new Error(\r\n            \"Livepeer provider requires LIVEPEER_GATEWAY_URL to be configured\"\r\n        );\r\n    }\r\n\r\n    const livepeerClient = createOpenAI({\r\n        apiKey,\r\n        baseURL: apiKey,\r\n        fetch: runtime.fetch\r\n    });\r\n    return aiGenerateObject({\r\n        model: livepeerClient.languageModel(model),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for Secret AI models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to Secret AI.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleSecretAi({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    provider,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const secretAiProvider = createOllama({\r\n        baseURL: getEndpoint(provider) + \"/api\",\r\n        headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${apiKey}`,\r\n        },\r\n        fetch: runtime.fetch\r\n    });\r\n    const secretAi = secretAiProvider(model);\r\n    return aiGenerateObject({\r\n        model: secretAi,\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n/**\r\n * Handles object generation for NEAR AI models.\r\n *\r\n * @param {ProviderOptions} options - Options specific to NEAR AI.\r\n * @returns {Promise<GenerateObjectResult<unknown>>} - A promise that resolves to generated objects.\r\n */\r\nasync function handleNearAi({\r\n    model,\r\n    apiKey,\r\n    schema,\r\n    schemaName,\r\n    schemaDescription,\r\n    mode = \"json\",\r\n    modelOptions,\r\n    runtime,\r\n}: ProviderOptions): Promise<GenerationResult> {\r\n    const nearai = createOpenAI({\r\n        apiKey,\r\n        baseURL: models.nearai.endpoint,\r\n        fetch: runtime.fetch\r\n    });\r\n    const settings = schema ? { structuredOutputs: true } : undefined;\r\n    return aiGenerateObject({\r\n        model: nearai.languageModel(model, settings),\r\n        schema,\r\n        schemaName,\r\n        schemaDescription,\r\n        mode,\r\n        ...modelOptions,\r\n    });\r\n}\r\n\r\n// Add type definition for Together AI response\r\ninterface TogetherAIImageResponse {\r\n    data: Array<{\r\n        url: string;\r\n        content_type?: string;\r\n        image_type?: string;\r\n    }>;\r\n}\r\n\r\n// doesn't belong here\r\nexport async function generateTweetActions({\r\n    runtime,\r\n    context,\r\n    modelClass,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    context: string;\r\n    modelClass: ModelClass;\r\n}): Promise<ActionResponse | null> {\r\n    let retryDelay = 1000;\r\n    while (true) {\r\n        try {\r\n            const response = await generateText({\r\n                runtime,\r\n                context,\r\n                modelClass,\r\n            });\r\n            elizaLogger.debug(\r\n                \"Received response from generateText for tweet actions:\",\r\n                response\r\n            );\r\n            const { actions } = parseActionResponseFromText(response.trim());\r\n            if (actions) {\r\n                elizaLogger.debug(\"Parsed tweet actions:\", actions);\r\n                return actions;\r\n            } else {\r\n                elizaLogger.debug(\"generateTweetActions no valid response\");\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(\"Error in generateTweetActions:\", error);\r\n            if (\r\n                error instanceof TypeError &&\r\n                error.message.includes(\"queueTextCompletion\")\r\n            ) {\r\n                elizaLogger.error(\r\n                    \"TypeError: Cannot read properties of null (reading 'queueTextCompletion')\"\r\n                );\r\n            }\r\n        }\r\n        elizaLogger.log(`Retrying in ${retryDelay}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, retryDelay));\r\n        retryDelay *= 2;\r\n    }\r\n}\r\n","import type {\r\n    IAgentRuntime,\r\n    Goal,\r\n    Objective,\r\n    UUID,\r\n} from \"./types.ts\";\r\n\r\nexport const getGoals = async ({\r\n    runtime,\r\n    roomId,\r\n    userId,\r\n    onlyInProgress = true,\r\n    count = 5,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    roomId: UUID;\r\n    userId?: UUID;\r\n    onlyInProgress?: boolean;\r\n    count?: number;\r\n}) => {\r\n    return runtime.databaseAdapter.getGoals({\r\n        agentId: runtime.agentId,\r\n        roomId,\r\n        userId,\r\n        onlyInProgress,\r\n        count,\r\n    });\r\n};\r\n\r\nexport const formatGoalsAsString = ({ goals }: { goals: Goal[] }) => {\r\n    const goalStrings = goals.map((goal: Goal) => {\r\n        const header = `Goal: ${goal.name}\\nid: ${goal.id}`;\r\n        const objectives =\r\n            \"Objectives:\\n\" +\r\n            goal.objectives\r\n                .map((objective: Objective) => {\r\n                    return `- ${objective.completed ? \"[x]\" : \"[ ]\"} ${objective.description} ${objective.completed ? \" (DONE)\" : \" (IN PROGRESS)\"}`;\r\n                })\r\n                .join(\"\\n\");\r\n        return `${header}\\n${objectives}`;\r\n    });\r\n    return goalStrings.join(\"\\n\");\r\n};\r\n\r\nexport const updateGoal = async ({\r\n    runtime,\r\n    goal,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    goal: Goal;\r\n}) => {\r\n    return runtime.databaseAdapter.updateGoal(goal);\r\n};\r\n\r\nexport const createGoal = async ({\r\n    runtime,\r\n    goal,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    goal: Goal;\r\n}) => {\r\n    return runtime.databaseAdapter.createGoal(goal);\r\n};\r\n","import { embed, getEmbeddingZeroVector } from \"./embedding.ts\";\r\nimport elizaLogger from \"./logger.ts\";\r\nimport type {\r\n    IAgentRuntime,\r\n    IMemoryManager,\r\n    Memory,\r\n    UUID,\r\n} from \"./types.ts\";\r\n\r\nconst defaultMatchThreshold = 0.1;\r\nconst defaultMatchCount = 10;\r\n\r\n/**\r\n * Manage memories in the database.\r\n */\r\nexport class MemoryManager implements IMemoryManager {\r\n    /**\r\n     * The AgentRuntime instance associated with this manager.\r\n     */\r\n    runtime: IAgentRuntime;\r\n\r\n    /**\r\n     * The name of the database table this manager operates on.\r\n     */\r\n    tableName: string;\r\n\r\n    /**\r\n     * Constructs a new MemoryManager instance.\r\n     * @param opts Options for the manager.\r\n     * @param opts.tableName The name of the table this manager will operate on.\r\n     * @param opts.runtime The AgentRuntime instance associated with this manager.\r\n     */\r\n    constructor(opts: { tableName: string; runtime: IAgentRuntime }) {\r\n        this.runtime = opts.runtime;\r\n        this.tableName = opts.tableName;\r\n    }\r\n\r\n    /**\r\n     * Adds an embedding vector to a memory object. If the memory already has an embedding, it is returned as is.\r\n     * @param memory The memory object to add an embedding to.\r\n     * @returns A Promise resolving to the memory object, potentially updated with an embedding vector.\r\n     */\r\n    /**\r\n     * Adds an embedding vector to a memory object if one doesn't already exist.\r\n     * The embedding is generated from the memory's text content using the runtime's\r\n     * embedding model. If the memory has no text content, an error is thrown.\r\n     *\r\n     * @param memory The memory object to add an embedding to\r\n     * @returns The memory object with an embedding vector added\r\n     * @throws Error if the memory content is empty\r\n     */\r\n    async addEmbeddingToMemory(memory: Memory): Promise<Memory> {\r\n        // Return early if embedding already exists\r\n        if (memory.embedding) {\r\n            return memory;\r\n        }\r\n\r\n        const memoryText = memory.content.text;\r\n\r\n        // Validate memory has text content\r\n        if (!memoryText) {\r\n            throw new Error(\r\n                \"Cannot generate embedding: Memory content is empty\"\r\n            );\r\n        }\r\n\r\n        try {\r\n            // Generate embedding from text content\r\n            memory.embedding = await embed(this.runtime, memoryText);\r\n        } catch (error) {\r\n            elizaLogger.error(\"Failed to generate embedding:\", error);\r\n            // Fallback to zero vector if embedding fails\r\n            memory.embedding = getEmbeddingZeroVector().slice();\r\n        }\r\n\r\n        return memory;\r\n    }\r\n\r\n    /**\r\n     * Retrieves a list of memories by user IDs, with optional deduplication.\r\n     * @param opts Options including user IDs, count, and uniqueness.\r\n     * @param opts.roomId The room ID to retrieve memories for.\r\n     * @param opts.count The number of memories to retrieve.\r\n     * @param opts.unique Whether to retrieve unique memories only.\r\n     * @returns A Promise resolving to an array of Memory objects.\r\n     */\r\n    async getMemories({\r\n        roomId,\r\n        count = 10,\r\n        unique = true,\r\n        start,\r\n        end,\r\n    }: {\r\n        roomId: UUID;\r\n        count?: number;\r\n        unique?: boolean;\r\n        start?: number;\r\n        end?: number;\r\n    }): Promise<Memory[]> {\r\n        return await this.runtime.databaseAdapter.getMemories({\r\n            roomId,\r\n            count,\r\n            unique,\r\n            tableName: this.tableName,\r\n            agentId: this.runtime.agentId,\r\n            start,\r\n            end,\r\n        });\r\n    }\r\n\r\n    async getCachedEmbeddings(content: string): Promise<\r\n        {\r\n            embedding: number[];\r\n            levenshtein_score: number;\r\n        }[]\r\n    > {\r\n        return await this.runtime.databaseAdapter.getCachedEmbeddings({\r\n            query_table_name: this.tableName,\r\n            query_threshold: 2,\r\n            query_input: content,\r\n            query_field_name: \"content\",\r\n            query_field_sub_name: \"text\",\r\n            query_match_count: 10,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Searches for memories similar to a given embedding vector.\r\n     * @param embedding The embedding vector to search with.\r\n     * @param opts Options including match threshold, count, user IDs, and uniqueness.\r\n     * @param opts.match_threshold The similarity threshold for matching memories.\r\n     * @param opts.count The maximum number of memories to retrieve.\r\n     * @param opts.roomId The room ID to retrieve memories for.\r\n     * @param opts.unique Whether to retrieve unique memories only.\r\n     * @returns A Promise resolving to an array of Memory objects that match the embedding.\r\n     */\r\n    async searchMemoriesByEmbedding(\r\n        embedding: number[],\r\n        opts: {\r\n            match_threshold?: number;\r\n            count?: number;\r\n            roomId: UUID;\r\n            unique?: boolean;\r\n        }\r\n    ): Promise<Memory[]> {\r\n        const {\r\n            match_threshold = defaultMatchThreshold,\r\n            count = defaultMatchCount,\r\n            roomId,\r\n            unique,\r\n        } = opts;\r\n\r\n        const result = await this.runtime.databaseAdapter.searchMemories({\r\n            tableName: this.tableName,\r\n            roomId,\r\n            agentId: this.runtime.agentId,\r\n            embedding: embedding,\r\n            match_threshold: match_threshold,\r\n            match_count: count,\r\n            unique: !!unique,\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Creates a new memory in the database, with an option to check for similarity before insertion.\r\n     * @param memory The memory object to create.\r\n     * @param unique Whether to check for similarity before insertion.\r\n     * @returns A Promise that resolves when the operation completes.\r\n     */\r\n    async createMemory(memory: Memory, unique = false): Promise<void> {\r\n        // TODO: check memory.agentId == this.runtime.agentId\r\n\r\n        const existingMessage =\r\n            await this.runtime.databaseAdapter.getMemoryById(memory.id);\r\n\r\n        if (existingMessage) {\r\n            elizaLogger.debug(\"Memory already exists, skipping\");\r\n            return;\r\n        }\r\n\r\n        elizaLogger.log(\"Creating Memory\", memory.id, memory.content.text);\r\n\r\n        await this.runtime.databaseAdapter.createMemory(\r\n            memory,\r\n            this.tableName,\r\n            unique\r\n        );\r\n    }\r\n\r\n    async getMemoriesByRoomIds(params: { roomIds: UUID[], limit?: number; }): Promise<Memory[]> {\r\n        return await this.runtime.databaseAdapter.getMemoriesByRoomIds({\r\n            tableName: this.tableName,\r\n            agentId: this.runtime.agentId,\r\n            roomIds: params.roomIds,\r\n            limit: params.limit\r\n        });\r\n    }\r\n\r\n    async getMemoriesByIds(ids: UUID[]): Promise<Memory[]> {\r\n        return this.runtime.databaseAdapter.getMemoriesByIds(ids);\r\n    }\r\n\r\n    async getMemoryById(id: UUID): Promise<Memory | null> {\r\n        const result = await this.runtime.databaseAdapter.getMemoryById(id);\r\n        if (result && result.agentId !== this.runtime.agentId) return null;\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Removes a memory from the database by its ID.\r\n     * @param memoryId The ID of the memory to remove.\r\n     * @returns A Promise that resolves when the operation completes.\r\n     */\r\n    async removeMemory(memoryId: UUID): Promise<void> {\r\n        await this.runtime.databaseAdapter.removeMemory(\r\n            memoryId,\r\n            this.tableName\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Removes all memories associated with a set of user IDs.\r\n     * @param roomId The room ID to remove memories for.\r\n     * @returns A Promise that resolves when the operation completes.\r\n     */\r\n    async removeAllMemories(roomId: UUID): Promise<void> {\r\n        await this.runtime.databaseAdapter.removeAllMemories(\r\n            roomId,\r\n            this.tableName\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Counts the number of memories associated with a set of user IDs, with an option for uniqueness.\r\n     * @param roomId The room ID to count memories for.\r\n     * @param unique Whether to count unique memories only.\r\n     * @returns A Promise resolving to the count of memories.\r\n     */\r\n    async countMemories(roomId: UUID, unique = true): Promise<number> {\r\n        return await this.runtime.databaseAdapter.countMemories(\r\n            roomId,\r\n            unique,\r\n            this.tableName\r\n        );\r\n    }\r\n}\r\n","import type {\r\n    IAgentRuntime,\r\n    Actor,\r\n    Content,\r\n    Memory,\r\n    UUID,\r\n} from \"./types.ts\";\r\n\r\n/**\r\n * Get details for a list of actors.\r\n */\r\nexport async function getActorDetails({\r\n    runtime,\r\n    roomId,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    roomId: UUID;\r\n}) {\r\n    const participantIds =\r\n        await runtime.databaseAdapter.getParticipantsForRoom(roomId);\r\n    const actors = await Promise.all(\r\n        participantIds.map(async (userId) => {\r\n            const account =\r\n                await runtime.databaseAdapter.getAccountById(userId);\r\n            if (account) {\r\n                return {\r\n                    id: account.id,\r\n                    name: account.name,\r\n                    username: account.username,\r\n                    details: account.details,\r\n                };\r\n            }\r\n            return null;\r\n        })\r\n    );\r\n\r\n    return actors.filter((actor): actor is Actor => actor !== null);\r\n}\r\n\r\n/**\r\n * Format actors into a string\r\n * @param actors - list of actors\r\n * @returns string\r\n */\r\nexport function formatActors({ actors }: { actors: Actor[] }) {\r\n    const actorStrings = actors.map((actor: Actor) => {\r\n        const header = `${actor.name}${actor.details?.tagline ? \": \" + actor.details?.tagline : \"\"}${actor.details?.summary ? \"\\n\" + actor.details?.summary : \"\"}`;\r\n        return header;\r\n    });\r\n    const finalActorStrings = actorStrings.join(\"\\n\");\r\n    return finalActorStrings;\r\n}\r\n\r\n/**\r\n * Format messages into a string\r\n * @param messages - list of messages\r\n * @param actors - list of actors\r\n * @returns string\r\n */\r\nexport const formatMessages = ({\r\n    messages,\r\n    actors,\r\n}: {\r\n    messages: Memory[];\r\n    actors: Actor[];\r\n}) => {\r\n    const messageStrings = messages\r\n        .reverse()\r\n        .filter((message: Memory) => message.userId)\r\n        .map((message: Memory) => {\r\n            const messageContent = (message.content as Content).text;\r\n            const messageAction = (message.content as Content).action;\r\n            const formattedName =\r\n                actors.find((actor: Actor) => actor.id === message.userId)\r\n                    ?.name || \"Unknown User\";\r\n\r\n            const attachments = (message.content as Content).attachments;\r\n\r\n            const attachmentString =\r\n                attachments && attachments.length > 0\r\n                    ? ` (Attachments: ${attachments.map((media) => `[${media.id} - ${media.title} (${media.url})]`).join(\", \")})`\r\n                    : \"\";\r\n\r\n            const timestamp = formatTimestamp(message.createdAt);\r\n\r\n            const shortId = message.userId.slice(-5);\r\n\r\n            return `(${timestamp}) [${shortId}] ${formattedName}: ${messageContent}${attachmentString}${messageAction && messageAction !== \"null\" ? ` (${messageAction})` : \"\"}`;\r\n        })\r\n        .join(\"\\n\");\r\n    return messageStrings;\r\n};\r\n\r\nexport const formatTimestamp = (messageDate: number) => {\r\n    const now = new Date();\r\n    const diff = now.getTime() - messageDate;\r\n\r\n    const absDiff = Math.abs(diff);\r\n    const seconds = Math.floor(absDiff / 1000);\r\n    const minutes = Math.floor(seconds / 60);\r\n    const hours = Math.floor(minutes / 60);\r\n    const days = Math.floor(hours / 24);\r\n\r\n    if (absDiff < 60000) {\r\n        return \"just now\";\r\n    } else if (minutes < 60) {\r\n        return `${minutes} minute${minutes !== 1 ? \"s\" : \"\"} ago`;\r\n    } else if (hours < 24) {\r\n        return `${hours} hour${hours !== 1 ? \"s\" : \"\"} ago`;\r\n    } else {\r\n        return `${days} day${days !== 1 ? \"s\" : \"\"} ago`;\r\n    }\r\n};\r\n","import { formatTimestamp } from \"./messages.ts\";\r\nimport type { Actor, Memory } from \"./types.ts\";\r\n\r\nexport const formatPosts = ({\r\n    messages,\r\n    actors,\r\n    conversationHeader = true,\r\n}: {\r\n    messages: Memory[];\r\n    actors: Actor[];\r\n    conversationHeader?: boolean;\r\n}) => {\r\n    // Group messages by roomId\r\n    const groupedMessages: { [roomId: string]: Memory[] } = {};\r\n    messages.forEach((message) => {\r\n        if (message.roomId) {\r\n            if (!groupedMessages[message.roomId]) {\r\n                groupedMessages[message.roomId] = [];\r\n            }\r\n            groupedMessages[message.roomId].push(message);\r\n        }\r\n    });\r\n\r\n    // Sort messages within each roomId by createdAt (oldest to newest)\r\n    Object.values(groupedMessages).forEach((roomMessages) => {\r\n        roomMessages.sort((a, b) => a.createdAt - b.createdAt);\r\n    });\r\n\r\n    // Sort rooms by the newest message's createdAt\r\n    const sortedRooms = Object.entries(groupedMessages).sort(\r\n        ([, messagesA], [, messagesB]) =>\r\n            messagesB[messagesB.length - 1].createdAt -\r\n            messagesA[messagesA.length - 1].createdAt\r\n    );\r\n\r\n    const formattedPosts = sortedRooms.map(([roomId, roomMessages]) => {\r\n        const messageStrings = roomMessages\r\n            .filter((message: Memory) => message.userId)\r\n            .map((message: Memory) => {\r\n                const actor = actors.find(\r\n                    (actor: Actor) => actor.id === message.userId\r\n                );\r\n                const userName = actor?.name || \"Unknown User\";\r\n                const displayName = actor?.username || \"unknown\";\r\n\r\n                return `Name: ${userName} (@${displayName})\r\nID: ${message.id}${message.content.inReplyTo ? `\\nIn reply to: ${message.content.inReplyTo}` : \"\"}\r\nDate: ${formatTimestamp(message.createdAt)}\r\nText:\r\n${message.content.text}`;\r\n            });\r\n\r\n        const header = conversationHeader\r\n            ? `Conversation: ${roomId.slice(-5)}\\n`\r\n            : \"\";\r\n        return `${header}${messageStrings.join(\"\\n\\n\")}`;\r\n    });\r\n\r\n    return formattedPosts.join(\"\\n\\n\");\r\n};\r\n","import type { IAgentRuntime, State, Memory } from \"./types.ts\";\r\n\r\n/**\r\n * Formats provider outputs into a string which can be injected into the context.\r\n * @param runtime The AgentRuntime object.\r\n * @param message The incoming message object.\r\n * @param state The current state object.\r\n * @returns A string that concatenates the outputs of each provider.\r\n */\r\nexport async function getProviders(\r\n    runtime: IAgentRuntime,\r\n    message: Memory,\r\n    state?: State\r\n) {\r\n    const providerResults = (\r\n        await Promise.all(\r\n            runtime.providers.map(async (provider) => {\r\n                return await provider.get(runtime, message, state);\r\n            })\r\n        )\r\n    ).filter((result) => result != null && result !== \"\");\r\n\r\n    return providerResults.join(\"\\n\");\r\n}\r\n","import type { IAgentRuntime, Relationship, UUID } from \"./types.ts\";\r\n\r\nexport async function createRelationship({\r\n    runtime,\r\n    userA,\r\n    userB,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    userA: UUID;\r\n    userB: UUID;\r\n}): Promise<boolean> {\r\n    return runtime.databaseAdapter.createRelationship({\r\n        userA,\r\n        userB,\r\n    });\r\n}\r\n\r\nexport async function getRelationship({\r\n    runtime,\r\n    userA,\r\n    userB,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    userA: UUID;\r\n    userB: UUID;\r\n}) {\r\n    return runtime.databaseAdapter.getRelationship({\r\n        userA,\r\n        userB,\r\n    });\r\n}\r\n\r\nexport async function getRelationships({\r\n    runtime,\r\n    userId,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    userId: UUID;\r\n}) {\r\n    return runtime.databaseAdapter.getRelationships({ userId });\r\n}\r\n\r\nexport async function formatRelationships({\r\n    runtime,\r\n    userId,\r\n}: {\r\n    runtime: IAgentRuntime;\r\n    userId: UUID;\r\n}) {\r\n    const relationships = await getRelationships({ runtime, userId });\r\n\r\n    const formattedRelationships = relationships.map(\r\n        (relationship: Relationship) => {\r\n            const { userA, userB } = relationship;\r\n\r\n            if (userA === userId) {\r\n                return userB;\r\n            }\r\n\r\n            return userA;\r\n        }\r\n    );\r\n\r\n    return formattedRelationships;\r\n}\r\n","import { readFile } from \"fs/promises\";\r\nimport { join } from \"path\";\r\nimport { names, uniqueNamesGenerator } from \"unique-names-generator\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nimport {\r\n    composeActionExamples,\r\n    formatActionNames,\r\n    formatActions,\r\n} from \"./actions.ts\";\r\nimport { addHeader, composeContext } from \"./context.ts\";\r\nimport {\r\n    evaluationTemplate,\r\n    formatEvaluatorExamples,\r\n    formatEvaluatorNames,\r\n    formatEvaluators,\r\n} from \"./evaluators.ts\";\r\nimport { generateText } from \"./generation.ts\";\r\nimport { formatGoalsAsString, getGoals } from \"./goals.ts\";\r\nimport { elizaLogger } from \"./index.ts\";\r\nimport knowledge from \"./knowledge.ts\";\r\nimport { MemoryManager } from \"./memory.ts\";\r\nimport { formatActors, formatMessages, getActorDetails } from \"./messages.ts\";\r\nimport { parseJsonArrayFromText } from \"./parsing.ts\";\r\nimport { formatPosts } from \"./posts.ts\";\r\nimport { getProviders } from \"./providers.ts\";\r\nimport { RAGKnowledgeManager } from \"./ragknowledge.ts\";\r\nimport settings from \"./settings.ts\";\r\nimport {\r\n    type Character,\r\n    type Goal,\r\n    type HandlerCallback,\r\n    type IAgentRuntime,\r\n    type ICacheManager,\r\n    type IDatabaseAdapter,\r\n    type IMemoryManager,\r\n    type IRAGKnowledgeManager,\r\n    // type IVerifiableInferenceAdapter,\r\n    type KnowledgeItem,\r\n    // RAGKnowledgeItem,\r\n    //Media,\r\n    ModelClass,\r\n    ModelProviderName,\r\n    type Plugin,\r\n    type Provider,\r\n    type Adapter,\r\n    type Service,\r\n    type ServiceType,\r\n    type State,\r\n    type UUID,\r\n    type Action,\r\n    type Actor,\r\n    type Evaluator,\r\n    type Memory,\r\n    type DirectoryItem,\r\n    type ClientInstance,\r\n} from \"./types.ts\";\r\nimport { stringToUuid } from \"./uuid.ts\";\r\nimport { glob } from \"glob\";\r\nimport { existsSync } from \"fs\";\r\n/**\r\n * Represents the runtime environment for an agent, handling message processing,\r\n * action registration, and interaction with external services like OpenAI and Supabase.\r\n */\r\n\r\nfunction isDirectoryItem(item: any): item is DirectoryItem {\r\n    return (\r\n        typeof item === \"object\" &&\r\n        item !== null &&\r\n        \"directory\" in item &&\r\n        typeof item.directory === \"string\"\r\n    );\r\n}\r\n\r\nexport class AgentRuntime implements IAgentRuntime {\r\n    /**\r\n     * Default count for recent messages to be kept in memory.\r\n     * @private\r\n     */\r\n    readonly #conversationLength = 32 as number;\r\n    /**\r\n     * The ID of the agent\r\n     */\r\n    agentId: UUID;\r\n    /**\r\n     * The base URL of the server where the agent's requests are processed.\r\n     */\r\n    serverUrl = \"http://localhost:7998\";\r\n\r\n    /**\r\n     * The database adapter used for interacting with the database.\r\n     */\r\n    databaseAdapter: IDatabaseAdapter;\r\n\r\n    /**\r\n     * Authentication token used for securing requests.\r\n     */\r\n    token: string | null;\r\n\r\n    /**\r\n     * Custom actions that the agent can perform.\r\n     */\r\n    actions: Action[] = [];\r\n\r\n    /**\r\n     * Evaluators used to assess and guide the agent's responses.\r\n     */\r\n    evaluators: Evaluator[] = [];\r\n\r\n    /**\r\n     * Context providers used to provide context for message generation.\r\n     */\r\n    providers: Provider[] = [];\r\n\r\n    /**\r\n     * Database adapters used to interact with the database.\r\n     */\r\n    adapters: Adapter[] = [];\r\n\r\n    plugins: Plugin[] = [];\r\n\r\n    /**\r\n     * The model to use for generateText.\r\n     */\r\n    modelProvider: ModelProviderName;\r\n\r\n    /**\r\n     * The model to use for generateImage.\r\n     */\r\n    imageModelProvider: ModelProviderName;\r\n\r\n    /**\r\n     * The model to use for describing images.\r\n     */\r\n    imageVisionModelProvider: ModelProviderName;\r\n\r\n    /**\r\n     * Fetch function to use\r\n     * Some environments may not have access to the global fetch function and need a custom fetch override.\r\n     */\r\n    fetch = fetch;\r\n\r\n    /**\r\n     * The character to use for the agent\r\n     */\r\n    character: Character;\r\n\r\n    /**\r\n     * Store messages that are sent and received by the agent.\r\n     */\r\n    messageManager: IMemoryManager;\r\n\r\n    /**\r\n     * Store and recall descriptions of users based on conversations.\r\n     */\r\n    descriptionManager: IMemoryManager;\r\n\r\n    /**\r\n     * Manage the creation and recall of static information (documents, historical game lore, etc)\r\n     */\r\n    loreManager: IMemoryManager;\r\n\r\n    /**\r\n     * Hold large documents that can be referenced\r\n     */\r\n    documentsManager: IMemoryManager;\r\n\r\n    /**\r\n     * Searchable document fragments\r\n     */\r\n    knowledgeManager: IMemoryManager;\r\n\r\n    ragKnowledgeManager: IRAGKnowledgeManager;\r\n\r\n    private readonly knowledgeRoot: string;\r\n\r\n    services: Map<ServiceType, Service> = new Map();\r\n    memoryManagers: Map<string, IMemoryManager> = new Map();\r\n    cacheManager: ICacheManager;\r\n    clients: ClientInstance[] = [];\r\n\r\n    // verifiableInferenceAdapter?: IVerifiableInferenceAdapter;\r\n\r\n    registerMemoryManager(manager: IMemoryManager): void {\r\n        if (!manager.tableName) {\r\n            throw new Error(\"Memory manager must have a tableName\");\r\n        }\r\n\r\n        if (this.memoryManagers.has(manager.tableName)) {\r\n            elizaLogger.warn(\r\n                `Memory manager ${manager.tableName} is already registered. Skipping registration.`,\r\n            );\r\n            return;\r\n        }\r\n\r\n        this.memoryManagers.set(manager.tableName, manager);\r\n    }\r\n\r\n    getMemoryManager(tableName: string): IMemoryManager | null {\r\n        return this.memoryManagers.get(tableName) || null;\r\n    }\r\n\r\n    getService<T extends Service>(service: ServiceType): T | null {\r\n        const serviceInstance = this.services.get(service);\r\n        if (!serviceInstance) {\r\n            elizaLogger.error(`Service ${service} not found`);\r\n            return null;\r\n        }\r\n        return serviceInstance as T;\r\n    }\r\n\r\n    async registerService(service: Service): Promise<void> {\r\n        const serviceType = service.serviceType;\r\n        elizaLogger.log(`${this.character.name}(${this.agentId}) - Registering service:`, serviceType);\r\n\r\n        if (this.services.has(serviceType)) {\r\n            elizaLogger.warn(\r\n                `${this.character.name}(${this.agentId}) - Service ${serviceType} is already registered. Skipping registration.`\r\n            );\r\n            return;\r\n        }\r\n\r\n        // Add the service to the services map\r\n        this.services.set(serviceType, service);\r\n        elizaLogger.success(`${this.character.name}(${this.agentId}) - Service ${serviceType} registered successfully`);\r\n    }\r\n\r\n    /**\r\n     * Creates an instance of AgentRuntime.\r\n     * @param opts - The options for configuring the AgentRuntime.\r\n     * @param opts.conversationLength - The number of messages to hold in the recent message cache.\r\n     * @param opts.token - The JWT token, can be a JWT token if outside worker, or an OpenAI token if inside worker.\r\n     * @param opts.serverUrl - The URL of the worker.\r\n     * @param opts.actions - Optional custom actions.\r\n     * @param opts.evaluators - Optional custom evaluators.\r\n     * @param opts.services - Optional custom services.\r\n     * @param opts.memoryManagers - Optional custom memory managers.\r\n     * @param opts.providers - Optional context providers.\r\n     * @param opts.model - The model to use for generateText.\r\n     * @param opts.embeddingModel - The model to use for embedding.\r\n     * @param opts.agentId - Optional ID of the agent.\r\n     * @param opts.databaseAdapter - The database adapter used for interacting with the database.\r\n     * @param opts.fetch - Custom fetch function to use for making requests.\r\n     */\r\n\r\n    constructor(opts: {\r\n        conversationLength?: number; // number of messages to hold in the recent message cache\r\n        agentId?: UUID; // ID of the agent\r\n        character?: Character; // The character to use for the agent\r\n        token: string; // JWT token, can be a JWT token if outside worker, or an OpenAI token if inside worker\r\n        serverUrl?: string; // The URL of the worker\r\n        actions?: Action[]; // Optional custom actions\r\n        evaluators?: Evaluator[]; // Optional custom evaluators\r\n        plugins?: Plugin[];\r\n        providers?: Provider[];\r\n        modelProvider: ModelProviderName;\r\n\r\n        services?: Service[]; // Map of service name to service instance\r\n        managers?: IMemoryManager[]; // Map of table name to memory manager\r\n        databaseAdapter?: IDatabaseAdapter; // The database adapter used for interacting with the database\r\n        fetch?: typeof fetch | unknown;\r\n        speechModelPath?: string;\r\n        cacheManager?: ICacheManager;\r\n        logging?: boolean;\r\n        // verifiableInferenceAdapter?: IVerifiableInferenceAdapter;\r\n    }) {\r\n        // use the character id if it exists, otherwise use the agentId if it is passed in, otherwise use the character name\r\n        this.agentId =\r\n            opts.character?.id ??\r\n            opts?.agentId ??\r\n            stringToUuid(opts.character?.name ?? uuidv4());\r\n        this.character = opts.character;\r\n\r\n        if(!this.character) {\r\n            throw new Error(\"Character input is required\");\r\n        }\r\n\r\n        elizaLogger.info(`${this.character.name}(${this.agentId}) - Initializing AgentRuntime with options:`, {\r\n            character: opts.character?.name,\r\n            modelProvider: opts.modelProvider,\r\n            characterModelProvider: opts.character?.modelProvider,\r\n        });\r\n\r\n        elizaLogger.debug(\r\n            `[AgentRuntime] Process working directory: ${process.cwd()}`,\r\n        );\r\n\r\n        // Define the root path once\r\n        this.knowledgeRoot = join(\r\n            process.cwd(),\r\n            \"..\",\r\n            \"characters\",\r\n            \"knowledge\",\r\n        );\r\n\r\n        elizaLogger.debug(\r\n            `[AgentRuntime] Process knowledgeRoot: ${this.knowledgeRoot}`,\r\n        );\r\n\r\n        this.#conversationLength =\r\n            opts.conversationLength ?? this.#conversationLength;\r\n\r\n        this.databaseAdapter = opts.databaseAdapter;\r\n\r\n        elizaLogger.success(`Agent ID: ${this.agentId}`);\r\n\r\n        this.fetch = (opts.fetch as typeof fetch) ?? this.fetch;\r\n\r\n        this.cacheManager = opts.cacheManager;\r\n\r\n        this.messageManager = new MemoryManager({\r\n            runtime: this,\r\n            tableName: \"messages\",\r\n        });\r\n\r\n        this.descriptionManager = new MemoryManager({\r\n            runtime: this,\r\n            tableName: \"descriptions\",\r\n        });\r\n\r\n        this.loreManager = new MemoryManager({\r\n            runtime: this,\r\n            tableName: \"lore\",\r\n        });\r\n\r\n        this.documentsManager = new MemoryManager({\r\n            runtime: this,\r\n            tableName: \"documents\",\r\n        });\r\n\r\n        this.knowledgeManager = new MemoryManager({\r\n            runtime: this,\r\n            tableName: \"fragments\",\r\n        });\r\n\r\n        this.ragKnowledgeManager = new RAGKnowledgeManager({\r\n            runtime: this,\r\n            tableName: \"knowledge\",\r\n            knowledgeRoot: this.knowledgeRoot,\r\n        });\r\n\r\n        (opts.managers ?? []).forEach((manager: IMemoryManager) => {\r\n            this.registerMemoryManager(manager);\r\n        });\r\n\r\n        (opts.services ?? []).forEach((service: Service) => {\r\n            this.registerService(service);\r\n        });\r\n\r\n        this.serverUrl = opts.serverUrl ?? this.serverUrl;\r\n\r\n        elizaLogger.info(`${this.character.name}(${this.agentId}) - Setting Model Provider:`, {\r\n            characterModelProvider: this.character.modelProvider,\r\n            optsModelProvider: opts.modelProvider,\r\n            currentModelProvider: this.modelProvider,\r\n            finalSelection:\r\n                this.character.modelProvider ??\r\n                opts.modelProvider ??\r\n                this.modelProvider,\r\n        });\r\n\r\n        this.modelProvider =\r\n            this.character.modelProvider ??\r\n            opts.modelProvider ??\r\n            this.modelProvider;\r\n\r\n        this.imageModelProvider =\r\n            this.character.imageModelProvider ?? this.modelProvider;\r\n\r\n        this.imageVisionModelProvider =\r\n            this.character.imageVisionModelProvider ?? this.modelProvider;\r\n\r\n        elizaLogger.info(\r\n          `${this.character.name}(${this.agentId}) - Selected model provider:`,\r\n          this.modelProvider\r\n        );\r\n\r\n        elizaLogger.info(\r\n          `${this.character.name}(${this.agentId}) - Selected image model provider:`,\r\n          this.imageModelProvider\r\n        );\r\n\r\n        elizaLogger.info(\r\n            `${this.character.name}(${this.agentId}) - Selected image vision model provider:`,\r\n            this.imageVisionModelProvider\r\n        );\r\n\r\n        // Validate model provider\r\n        if (!Object.values(ModelProviderName).includes(this.modelProvider)) {\r\n            elizaLogger.error(\"Invalid model provider:\", this.modelProvider);\r\n            elizaLogger.error(\r\n                \"Available providers:\",\r\n                Object.values(ModelProviderName),\r\n            );\r\n            throw new Error(`Invalid model provider: ${this.modelProvider}`);\r\n        }\r\n\r\n        if (!this.serverUrl) {\r\n            elizaLogger.warn(\"No serverUrl provided, defaulting to localhost\");\r\n        }\r\n\r\n        this.token = opts.token;\r\n\r\n        this.plugins = [\r\n            ...(opts.character?.plugins ?? []),\r\n            ...(opts.plugins ?? []),\r\n        ];\r\n\r\n        this.plugins.forEach((plugin) => {\r\n            plugin.actions?.forEach((action) => {\r\n                this.registerAction(action);\r\n            });\r\n\r\n            plugin.evaluators?.forEach((evaluator) => {\r\n                this.registerEvaluator(evaluator);\r\n            });\r\n\r\n            plugin.services?.forEach((service) => {\r\n                this.registerService(service);\r\n            });\r\n\r\n            plugin.providers?.forEach((provider) => {\r\n                this.registerContextProvider(provider);\r\n            });\r\n\r\n            plugin.adapters?.forEach((adapter) => {\r\n                this.registerAdapter(adapter);\r\n            });\r\n        });\r\n\r\n        (opts.actions ?? []).forEach((action) => {\r\n            this.registerAction(action);\r\n        });\r\n\r\n        (opts.providers ?? []).forEach((provider) => {\r\n            this.registerContextProvider(provider);\r\n        });\r\n\r\n        (opts.evaluators ?? []).forEach((evaluator: Evaluator) => {\r\n            this.registerEvaluator(evaluator);\r\n        });\r\n\r\n        // this.verifiableInferenceAdapter = opts.verifiableInferenceAdapter;\r\n    }\r\n\r\n    private async initializeDatabase() {\r\n        // By convention, we create a user and room using the agent id.\r\n        // Memories related to it are considered global context for the agent.\r\n        this.ensureRoomExists(this.agentId);\r\n        this.ensureUserExists(\r\n            this.agentId,\r\n            this.character.username || this.character.name,\r\n            this.character.name,\r\n        ).then(() => {\r\n            // postgres needs the user to exist before you can add a participant\r\n            this.ensureParticipantExists(this.agentId, this.agentId);\r\n        });\r\n    }\r\n\r\n    async initialize() {\r\n        this.initializeDatabase();\r\n\r\n        for (const [serviceType, service] of this.services.entries()) {\r\n            try {\r\n                await service.initialize(this);\r\n                this.services.set(serviceType, service);\r\n                elizaLogger.success(\r\n                    `${this.character.name}(${this.agentId}) - Service ${serviceType} initialized successfully`\r\n                );\r\n            } catch (error) {\r\n                elizaLogger.error(\r\n                    `${this.character.name}(${this.agentId}) - Failed to initialize service ${serviceType}:`,\r\n                    error\r\n                );\r\n                throw error;\r\n            }\r\n        }\r\n\r\n        // should already be initialized\r\n        /*\r\n        for (const plugin of this.plugins) {\r\n            if (plugin.services)\r\n                await Promise.all(\r\n                    plugin.services?.map((service) => service.initialize(this)),\r\n                );\r\n        }\r\n        */\r\n\r\n        if (\r\n            this.character &&\r\n            this.character.knowledge &&\r\n            this.character.knowledge.length > 0\r\n        ) {\r\n            elizaLogger.info(\r\n                `[RAG Check] RAG Knowledge enabled: ${this.character.settings.ragKnowledge ? true : false}`,\r\n            );\r\n            elizaLogger.debug(\r\n                `[RAG Check] Knowledge items:`,\r\n                this.character.knowledge,\r\n            );\r\n\r\n            if (this.character.settings.ragKnowledge) {\r\n                // Type guards with logging for each knowledge type\r\n                const [directoryKnowledge, pathKnowledge, stringKnowledge] =\r\n                    this.character.knowledge.reduce(\r\n                        (acc, item) => {\r\n                            if (typeof item === \"object\") {\r\n                                if (isDirectoryItem(item)) {\r\n                                    elizaLogger.debug(\r\n                                        `[RAG Filter] Found directory item: ${JSON.stringify(item)}`,\r\n                                    );\r\n                                    acc[0].push(item);\r\n                                } else if (\"path\" in item) {\r\n                                    elizaLogger.debug(\r\n                                        `[RAG Filter] Found path item: ${JSON.stringify(item)}`,\r\n                                    );\r\n                                    acc[1].push(item);\r\n                                }\r\n                            } else if (typeof item === \"string\") {\r\n                                elizaLogger.debug(\r\n                                    `[RAG Filter] Found string item: ${item.slice(0, 100)}...`,\r\n                                );\r\n                                acc[2].push(item);\r\n                            }\r\n                            return acc;\r\n                        },\r\n                        [[], [], []] as [\r\n                            Array<{ directory: string; shared?: boolean }>,\r\n                            Array<{ path: string; shared?: boolean }>,\r\n                            Array<string>,\r\n                        ],\r\n                    );\r\n\r\n                elizaLogger.info(\r\n                    `[RAG Summary] Found ${directoryKnowledge.length} directories, ${pathKnowledge.length} paths, and ${stringKnowledge.length} strings`,\r\n                );\r\n\r\n                // Process each type of knowledge\r\n                if (directoryKnowledge.length > 0) {\r\n                    elizaLogger.info(\r\n                        `[RAG Process] Processing directory knowledge sources:`,\r\n                    );\r\n                    for (const dir of directoryKnowledge) {\r\n                        elizaLogger.info(\r\n                            `  - Directory: ${dir.directory} (shared: ${!!dir.shared})`,\r\n                        );\r\n                        await this.processCharacterRAGDirectory(dir);\r\n                    }\r\n                }\r\n\r\n                if (pathKnowledge.length > 0) {\r\n                    elizaLogger.info(\r\n                        `[RAG Process] Processing individual file knowledge sources`,\r\n                    );\r\n                    await this.processCharacterRAGKnowledge(pathKnowledge);\r\n                }\r\n\r\n                if (stringKnowledge.length > 0) {\r\n                    elizaLogger.info(\r\n                        `[RAG Process] Processing direct string knowledge`,\r\n                    );\r\n                    await this.processCharacterRAGKnowledge(stringKnowledge);\r\n                }\r\n            } else {\r\n                // Non-RAG mode: only process string knowledge\r\n                const stringKnowledge = this.character.knowledge.filter(\r\n                    (item): item is string => typeof item === \"string\",\r\n                );\r\n                await this.processCharacterKnowledge(stringKnowledge);\r\n            }\r\n\r\n            // After all new knowledge is processed, clean up any deleted files\r\n            elizaLogger.info(\r\n                `[RAG Cleanup] Starting cleanup of deleted knowledge files`,\r\n            );\r\n            await this.ragKnowledgeManager.cleanupDeletedKnowledgeFiles();\r\n            elizaLogger.info(`[RAG Cleanup] Cleanup complete`);\r\n        }\r\n    }\r\n\r\n    async stop() {\r\n        elizaLogger.debug(\"runtime::stop - character\", this.character.name);\r\n        // stop services, they don't have a stop function\r\n        // just initialize\r\n\r\n        // plugins\r\n        // have actions, providers, evaluators (no start/stop)\r\n        // services (just initialized), clients\r\n\r\n        // client have a start\r\n        for (const c of this.clients) {\r\n            elizaLogger.log(\r\n                \"runtime::stop - requesting\",\r\n                c,\r\n                \"client stop for\",\r\n                this.character.name,\r\n            );\r\n            c.stop(this);\r\n        }\r\n        // we don't need to unregister with directClient\r\n        // don't need to worry about knowledge\r\n    }\r\n\r\n    /**\r\n     * Processes character knowledge by creating document memories and fragment memories.\r\n     * This function takes an array of knowledge items, creates a document memory for each item if it doesn't exist,\r\n     * then chunks the content into fragments, embeds each fragment, and creates fragment memories.\r\n     * @param knowledge An array of knowledge items containing id, path, and content.\r\n     */\r\n    private async processCharacterKnowledge(items: string[]) {\r\n        const ids = items.map(i => stringToUuid(i));\r\n        const exists = await this.documentsManager.getMemoriesByIds(ids);\r\n        const toAdd = [];\r\n        for(const i in items) {\r\n          const exist = exists[i];\r\n          if (!exist) {\r\n            toAdd.push([items[i], ids[i]]);\r\n          }\r\n        }\r\n        if (!toAdd.length) return;\r\n        elizaLogger.info('discovered ' + toAdd.length + ' new knowledge items')\r\n        const chunkSize = 512;\r\n        const ps = [];\r\n        for (const a of toAdd) {\r\n            const item = a[0];\r\n            const knowledgeId = a[1];\r\n\r\n            if (item.length > chunkSize) {\r\n              // these are just slower\r\n              elizaLogger.info(\r\n                  this.character.name,\r\n                  \" knowledge item over 512 characters, splitting - \",\r\n                  item.slice(0, 100),\r\n              );\r\n            }\r\n\r\n            ps.push(knowledge.set(this, {\r\n                id: knowledgeId,\r\n                content: {\r\n                    text: item,\r\n                },\r\n            }));\r\n        }\r\n        // wait for it all to be added\r\n        await Promise.all(ps);\r\n        elizaLogger.success(this.character.name, 'knowledge is synchronized');\r\n    }\r\n\r\n    /**\r\n     * Processes character knowledge by creating document memories and fragment memories.\r\n     * This function takes an array of knowledge items, creates a document knowledge for each item if it doesn't exist,\r\n     * then chunks the content into fragments, embeds each fragment, and creates fragment knowledge.\r\n     * An array of knowledge items or objects containing id, path, and content.\r\n     */\r\n    private async processCharacterRAGKnowledge(\r\n        items: (string | { path: string; shared?: boolean })[],\r\n    ) {\r\n        let hasError = false;\r\n\r\n        for (const item of items) {\r\n            if (!item) continue;\r\n\r\n            try {\r\n                // Check if item is marked as shared\r\n                let isShared = false;\r\n                let contentItem = item;\r\n\r\n                // Only treat as shared if explicitly marked\r\n                if (typeof item === \"object\" && \"path\" in item) {\r\n                    isShared = item.shared === true;\r\n                    contentItem = item.path;\r\n                } else {\r\n                    contentItem = item;\r\n                }\r\n\r\n                // const knowledgeId = stringToUuid(contentItem);\r\n                const knowledgeId = this.ragKnowledgeManager.generateScopedId(\r\n                    contentItem,\r\n                    isShared,\r\n                );\r\n                const fileExtension = contentItem\r\n                    .split(\".\")\r\n                    .pop()\r\n                    ?.toLowerCase();\r\n\r\n                // Check if it's a file or direct knowledge\r\n                if (\r\n                    fileExtension &&\r\n                    [\"md\", \"txt\", \"pdf\"].includes(fileExtension)\r\n                ) {\r\n                    try {\r\n                        const filePath = join(this.knowledgeRoot, contentItem);\r\n                        // Get existing knowledge first with more detailed logging\r\n                        elizaLogger.debug(\"[RAG Query]\", {\r\n                            knowledgeId,\r\n                            agentId: this.agentId,\r\n                            relativePath: contentItem,\r\n                            fullPath: filePath,\r\n                            isShared,\r\n                            knowledgeRoot: this.knowledgeRoot,\r\n                        });\r\n\r\n                        // Get existing knowledge first\r\n                        const existingKnowledge =\r\n                            await this.ragKnowledgeManager.getKnowledge({\r\n                                id: knowledgeId,\r\n                                agentId: this.agentId, // Keep agentId as it's used in OR query\r\n                            });\r\n\r\n                        elizaLogger.debug(\"[RAG Query Result]\", {\r\n                            relativePath: contentItem,\r\n                            fullPath: filePath,\r\n                            knowledgeId,\r\n                            isShared,\r\n                            exists: existingKnowledge.length > 0,\r\n                            knowledgeCount: existingKnowledge.length,\r\n                            firstResult: existingKnowledge[0]\r\n                                ? {\r\n                                      id: existingKnowledge[0].id,\r\n                                      agentId: existingKnowledge[0].agentId,\r\n                                      contentLength:\r\n                                          existingKnowledge[0].content.text\r\n                                              .length,\r\n                                  }\r\n                                : null,\r\n                            results: existingKnowledge.map((k) => ({\r\n                                id: k.id,\r\n                                agentId: k.agentId,\r\n                                isBaseKnowledge: !k.id.includes(\"chunk\"),\r\n                            })),\r\n                        });\r\n\r\n                        // Read file content\r\n                        const content: string = await readFile(\r\n                            filePath,\r\n                            \"utf8\",\r\n                        );\r\n                        if (!content) {\r\n                            hasError = true;\r\n                            continue;\r\n                        }\r\n\r\n                        if (existingKnowledge.length > 0) {\r\n                            const existingContent =\r\n                                existingKnowledge[0].content.text;\r\n\r\n                            elizaLogger.debug(\"[RAG Compare]\", {\r\n                                path: contentItem,\r\n                                knowledgeId,\r\n                                isShared,\r\n                                existingContentLength: existingContent.length,\r\n                                newContentLength: content.length,\r\n                                contentSample: content.slice(0, 100),\r\n                                existingContentSample: existingContent.slice(\r\n                                    0,\r\n                                    100,\r\n                                ),\r\n                                matches: existingContent === content,\r\n                            });\r\n\r\n                            if (existingContent === content) {\r\n                                elizaLogger.info(\r\n                                    `${isShared ? \"Shared knowledge\" : \"Knowledge\"} ${contentItem} unchanged, skipping`,\r\n                                );\r\n                                continue;\r\n                            }\r\n\r\n                            // Content changed, remove old knowledge before adding new\r\n                            elizaLogger.info(\r\n                                `${isShared ? \"Shared knowledge\" : \"Knowledge\"} ${contentItem} changed, updating...`,\r\n                            );\r\n                            await this.ragKnowledgeManager.removeKnowledge(\r\n                                knowledgeId,\r\n                            );\r\n                            await this.ragKnowledgeManager.removeKnowledge(\r\n                                `${knowledgeId}-chunk-*` as UUID,\r\n                            );\r\n                        }\r\n\r\n                        elizaLogger.info(\r\n                            `Processing ${fileExtension.toUpperCase()} file content for`,\r\n                            this.character.name,\r\n                            \"-\",\r\n                            contentItem,\r\n                        );\r\n\r\n                        await this.ragKnowledgeManager.processFile({\r\n                            path: contentItem,\r\n                            content: content,\r\n                            type: fileExtension as \"pdf\" | \"md\" | \"txt\",\r\n                            isShared: isShared,\r\n                        });\r\n                    } catch (error: any) {\r\n                        hasError = true;\r\n                        elizaLogger.error(\r\n                            `Failed to read knowledge file ${contentItem}. Error details:`,\r\n                            error?.message || error || \"Unknown error\",\r\n                        );\r\n                        continue;\r\n                    }\r\n                } else {\r\n                    // Handle direct knowledge string\r\n                    elizaLogger.info(\r\n                        \"Processing direct knowledge for\",\r\n                        this.character.name,\r\n                        \"-\",\r\n                        contentItem.slice(0, 100),\r\n                    );\r\n\r\n                    const existingKnowledge =\r\n                        await this.ragKnowledgeManager.getKnowledge({\r\n                            id: knowledgeId,\r\n                            agentId: this.agentId,\r\n                        });\r\n\r\n                    if (existingKnowledge.length > 0) {\r\n                        elizaLogger.info(\r\n                            `Direct knowledge ${knowledgeId} already exists, skipping`,\r\n                        );\r\n                        continue;\r\n                    }\r\n\r\n                    await this.ragKnowledgeManager.createKnowledge({\r\n                        id: knowledgeId,\r\n                        agentId: this.agentId,\r\n                        content: {\r\n                            text: contentItem,\r\n                            metadata: {\r\n                                type: \"direct\",\r\n                            },\r\n                        },\r\n                    });\r\n                }\r\n            } catch (error: any) {\r\n                hasError = true;\r\n                elizaLogger.error(\r\n                    `Error processing knowledge item ${item}:`,\r\n                    error?.message || error || \"Unknown error\",\r\n                );\r\n                continue;\r\n            }\r\n        }\r\n\r\n        if (hasError) {\r\n            elizaLogger.warn(\r\n                \"Some knowledge items failed to process, but continuing with available knowledge\",\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes directory-based RAG knowledge by recursively loading and processing files.\r\n     * @param dirConfig The directory configuration containing path and shared flag\r\n     */\r\n    private async processCharacterRAGDirectory(dirConfig: {\r\n        directory: string;\r\n        shared?: boolean;\r\n    }) {\r\n        if (!dirConfig.directory) {\r\n            elizaLogger.error(\"[RAG Directory] No directory specified\");\r\n            return;\r\n        }\r\n\r\n        // Sanitize directory path to prevent traversal attacks\r\n        const sanitizedDir = dirConfig.directory.replace(/\\.\\./g, \"\");\r\n        const dirPath = join(this.knowledgeRoot, sanitizedDir);\r\n\r\n        try {\r\n            // Check if directory exists\r\n            const dirExists = existsSync(dirPath);\r\n            if (!dirExists) {\r\n                elizaLogger.error(\r\n                    `[RAG Directory] Directory does not exist: ${sanitizedDir}`,\r\n                );\r\n                return;\r\n            }\r\n\r\n            elizaLogger.debug(`[RAG Directory] Searching in: ${dirPath}`);\r\n            // Use glob to find all matching files in directory\r\n            const files = await glob(\"**/*.{md,txt,pdf}\", {\r\n                cwd: dirPath,\r\n                nodir: true,\r\n                absolute: false,\r\n            });\r\n\r\n            if (files.length === 0) {\r\n                elizaLogger.warn(\r\n                    `No matching files found in directory: ${dirConfig.directory}`,\r\n                );\r\n                return;\r\n            }\r\n\r\n            elizaLogger.info(\r\n                `[RAG Directory] Found ${files.length} files in ${dirConfig.directory}`,\r\n            );\r\n\r\n            // Process files in batches to avoid memory issues\r\n            const BATCH_SIZE = 5;\r\n            for (let i = 0; i < files.length; i += BATCH_SIZE) {\r\n                const batch = files.slice(i, i + BATCH_SIZE);\r\n\r\n                await Promise.all(\r\n                    batch.map(async (file) => {\r\n                        try {\r\n                            const relativePath = join(sanitizedDir, file);\r\n\r\n                            elizaLogger.debug(\r\n                                `[RAG Directory] Processing file ${i + 1}/${files.length}:`,\r\n                                {\r\n                                    file,\r\n                                    relativePath,\r\n                                    shared: dirConfig.shared,\r\n                                },\r\n                            );\r\n\r\n                            await this.processCharacterRAGKnowledge([\r\n                                {\r\n                                    path: relativePath,\r\n                                    shared: dirConfig.shared,\r\n                                },\r\n                            ]);\r\n                        } catch (error) {\r\n                            elizaLogger.error(\r\n                                `[RAG Directory] Failed to process file: ${file}`,\r\n                                error instanceof Error\r\n                                    ? {\r\n                                          name: error.name,\r\n                                          message: error.message,\r\n                                          stack: error.stack,\r\n                                      }\r\n                                    : error,\r\n                            );\r\n                        }\r\n                    }),\r\n                );\r\n\r\n                elizaLogger.debug(\r\n                    `[RAG Directory] Completed batch ${Math.min(i + BATCH_SIZE, files.length)}/${files.length} files`,\r\n                );\r\n            }\r\n\r\n            elizaLogger.success(\r\n                `[RAG Directory] Successfully processed directory: ${sanitizedDir}`,\r\n            );\r\n        } catch (error) {\r\n            elizaLogger.error(\r\n                `[RAG Directory] Failed to process directory: ${sanitizedDir}`,\r\n                error instanceof Error\r\n                    ? {\r\n                          name: error.name,\r\n                          message: error.message,\r\n                          stack: error.stack,\r\n                      }\r\n                    : error,\r\n            );\r\n            throw error; // Re-throw to let caller handle it\r\n        }\r\n    }\r\n\r\n    getSetting(key: string) {\r\n        // check if the key is in the character.settings.secrets object\r\n        if (this.character.settings?.secrets?.[key]) {\r\n            return this.character.settings.secrets[key];\r\n        }\r\n        // if not, check if it's in the settings object\r\n        if (this.character.settings?.[key]) {\r\n            return this.character.settings[key];\r\n        }\r\n\r\n        // if not, check if it's in the settings object\r\n        if (settings[key]) {\r\n            return settings[key];\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Get the number of messages that are kept in the conversation buffer.\r\n     * @returns The number of recent messages to be kept in memory.\r\n     */\r\n    getConversationLength() {\r\n        return this.#conversationLength;\r\n    }\r\n\r\n    /**\r\n     * Register an action for the agent to perform.\r\n     * @param action The action to register.\r\n     */\r\n    registerAction(action: Action) {\r\n        elizaLogger.success(`${this.character.name}(${this.agentId}) - Registering action: ${action.name}`);\r\n        this.actions.push(action);\r\n    }\r\n\r\n    /**\r\n     * Register an evaluator to assess and guide the agent's responses.\r\n     * @param evaluator The evaluator to register.\r\n     */\r\n    registerEvaluator(evaluator: Evaluator) {\r\n        this.evaluators.push(evaluator);\r\n    }\r\n\r\n    /**\r\n     * Register a context provider to provide context for message generation.\r\n     * @param provider The context provider to register.\r\n     */\r\n    registerContextProvider(provider: Provider) {\r\n        this.providers.push(provider);\r\n    }\r\n\r\n    /**\r\n     * Register an adapter for the agent to use.\r\n     * @param adapter The adapter to register.\r\n     */\r\n    registerAdapter(adapter: Adapter) {\r\n        this.adapters.push(adapter);\r\n    }\r\n\r\n    /**\r\n     * Process the actions of a message.\r\n     * @param message The message to process.\r\n     * @param content The content of the message to process actions from.\r\n     */\r\n    async processActions(\r\n        message: Memory,\r\n        responses: Memory[],\r\n        state?: State,\r\n        callback?: HandlerCallback,\r\n    ): Promise<void> {\r\n        for (const response of responses) {\r\n            if (!response.content?.action) {\r\n                elizaLogger.warn(\"No action found in the response content.\");\r\n                continue;\r\n            }\r\n\r\n            const normalizedAction = response.content.action\r\n                .toLowerCase()\r\n                .replace(\"_\", \"\");\r\n\r\n            elizaLogger.success(`Normalized action: ${normalizedAction}`);\r\n\r\n            let action = this.actions.find(\r\n                (a: { name: string }) =>\r\n                    a.name\r\n                        .toLowerCase()\r\n                        .replace(\"_\", \"\")\r\n                        .includes(normalizedAction) ||\r\n                    normalizedAction.includes(\r\n                        a.name.toLowerCase().replace(\"_\", \"\"),\r\n                    ),\r\n            );\r\n\r\n            if (!action) {\r\n                elizaLogger.info(\"Attempting to find action in similes.\");\r\n                for (const _action of this.actions) {\r\n                    const simileAction = _action.similes.find(\r\n                        (simile) =>\r\n                            simile\r\n                                .toLowerCase()\r\n                                .replace(\"_\", \"\")\r\n                                .includes(normalizedAction) ||\r\n                            normalizedAction.includes(\r\n                                simile.toLowerCase().replace(\"_\", \"\"),\r\n                            ),\r\n                    );\r\n                    if (simileAction) {\r\n                        action = _action;\r\n                        elizaLogger.success(\r\n                            `Action found in similes: ${action.name}`,\r\n                        );\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (!action) {\r\n                elizaLogger.error(\r\n                    \"No action found for\",\r\n                    response.content.action,\r\n                );\r\n                continue;\r\n            }\r\n\r\n            if (!action.handler) {\r\n                elizaLogger.error(`Action ${action.name} has no handler.`);\r\n                continue;\r\n            }\r\n\r\n            try {\r\n                elizaLogger.info(\r\n                    `Executing handler for action: ${action.name}`,\r\n                );\r\n                await action.handler(this, message, state, {}, callback);\r\n            } catch (error) {\r\n                elizaLogger.error(error);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Evaluate the message and state using the registered evaluators.\r\n     * @param message The message to evaluate.\r\n     * @param state The state of the agent.\r\n     * @param didRespond Whether the agent responded to the message.~\r\n     * @param callback The handler callback\r\n     * @returns The results of the evaluation.\r\n     */\r\n    async evaluate(\r\n        message: Memory,\r\n        state: State,\r\n        didRespond?: boolean,\r\n        callback?: HandlerCallback,\r\n    ) {\r\n        const evaluatorPromises = this.evaluators.map(\r\n            async (evaluator: Evaluator) => {\r\n                elizaLogger.log(\"Evaluating\", evaluator.name);\r\n                if (!evaluator.handler) {\r\n                    return null;\r\n                }\r\n                if (!didRespond && !evaluator.alwaysRun) {\r\n                    return null;\r\n                }\r\n                const result = await evaluator.validate(this, message, state);\r\n                if (result) {\r\n                    return evaluator;\r\n                }\r\n                return null;\r\n            },\r\n        );\r\n\r\n        const resolvedEvaluators = await Promise.all(evaluatorPromises);\r\n        const evaluatorsData = resolvedEvaluators.filter(\r\n            (evaluator): evaluator is Evaluator => evaluator !== null,\r\n        );\r\n\r\n        // if there are no evaluators this frame, return\r\n        if (!evaluatorsData || evaluatorsData.length === 0) {\r\n            return [];\r\n        }\r\n\r\n        const context = composeContext({\r\n            state: {\r\n                ...state,\r\n                evaluators: formatEvaluators(evaluatorsData),\r\n                evaluatorNames: formatEvaluatorNames(evaluatorsData),\r\n            },\r\n            template:\r\n                this.character.templates?.evaluationTemplate ||\r\n                evaluationTemplate,\r\n        });\r\n\r\n        const result = await generateText({\r\n            runtime: this,\r\n            context,\r\n            modelClass: ModelClass.SMALL,\r\n            // verifiableInferenceAdapter: this.verifiableInferenceAdapter,\r\n        });\r\n\r\n        const evaluators = parseJsonArrayFromText(\r\n            result,\r\n        ) as unknown as string[];\r\n\r\n        for (const evaluator of this.evaluators) {\r\n            if (!evaluators?.includes(evaluator.name)) continue;\r\n\r\n            if (evaluator.handler)\r\n                await evaluator.handler(this, message, state, {}, callback);\r\n        }\r\n\r\n        return evaluators;\r\n    }\r\n\r\n    /**\r\n     * Ensure the existence of a participant in the room. If the participant does not exist, they are added to the room.\r\n     * @param userId - The user ID to ensure the existence of.\r\n     * @throws An error if the participant cannot be added.\r\n     */\r\n    async ensureParticipantExists(userId: UUID, roomId: UUID) {\r\n        const participants =\r\n            await this.databaseAdapter.getParticipantsForAccount(userId);\r\n\r\n        if (participants?.length === 0) {\r\n            await this.databaseAdapter.addParticipant(userId, roomId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Ensure the existence of a user in the database. If the user does not exist, they are added to the database.\r\n     * @param userId - The user ID to ensure the existence of.\r\n     * @param userName - The user name to ensure the existence of.\r\n     * @returns\r\n     */\r\n\r\n    async ensureUserExists(\r\n        userId: UUID,\r\n        userName: string | null,\r\n        name: string | null,\r\n        email?: string | null,\r\n        source?: string | null,\r\n    ) {\r\n        const account = await this.databaseAdapter.getAccountById(userId);\r\n        if (!account) {\r\n            await this.databaseAdapter.createAccount({\r\n                id: userId,\r\n                name: name || this.character.name || \"Unknown User\",\r\n                username: userName || this.character.username || \"Unknown\",\r\n                // TODO: We might not need these account pieces\r\n                email: email || this.character.email || userId,\r\n                // When invoke ensureUserExists and saving account.details\r\n                // Performing a complete JSON.stringify on character will cause a TypeError: Converting circular structure to JSON error in some more complex plugins.\r\n                details: this.character ? Object.assign({}, this.character, {\r\n                    source,\r\n                    plugins: this.character?.plugins?.map((plugin) => plugin.name),\r\n                }) : { summary: \"\" },\r\n            });\r\n            elizaLogger.success(`User ${userName} created successfully.`);\r\n        }\r\n    }\r\n\r\n    async ensureParticipantInRoom(userId: UUID, roomId: UUID) {\r\n        const participants =\r\n            await this.databaseAdapter.getParticipantsForRoom(roomId);\r\n        if (!participants.includes(userId)) {\r\n            await this.databaseAdapter.addParticipant(userId, roomId);\r\n            if (userId === this.agentId) {\r\n                elizaLogger.log(\r\n                    `Agent ${this.character.name} linked to room ${roomId} successfully.`,\r\n                );\r\n            } else {\r\n                elizaLogger.log(\r\n                    `User ${userId} linked to room ${roomId} successfully.`,\r\n                );\r\n            }\r\n        }\r\n    }\r\n\r\n    async ensureConnection(\r\n        userId: UUID,\r\n        roomId: UUID,\r\n        userName?: string,\r\n        userScreenName?: string,\r\n        source?: string,\r\n    ) {\r\n        await Promise.all([\r\n            this.ensureUserExists(\r\n                this.agentId,\r\n                this.character.username ?? \"Agent\",\r\n                this.character.name ?? \"Agent\",\r\n                source,\r\n            ),\r\n            this.ensureUserExists(\r\n                userId,\r\n                userName ?? \"User\" + userId,\r\n                userScreenName ?? \"User\" + userId,\r\n                source,\r\n            ),\r\n            this.ensureRoomExists(roomId),\r\n        ]);\r\n\r\n        await Promise.all([\r\n            this.ensureParticipantInRoom(userId, roomId),\r\n            this.ensureParticipantInRoom(this.agentId, roomId),\r\n        ]);\r\n    }\r\n\r\n    /**\r\n     * Ensure the existence of a room between the agent and a user. If no room exists, a new room is created and the user\r\n     * and agent are added as participants. The room ID is returned.\r\n     * @param userId - The user ID to create a room with.\r\n     * @returns The room ID of the room between the agent and the user.\r\n     * @throws An error if the room cannot be created.\r\n     */\r\n    async ensureRoomExists(roomId: UUID) {\r\n        const room = await this.databaseAdapter.getRoom(roomId);\r\n        if (!room) {\r\n            await this.databaseAdapter.createRoom(roomId);\r\n            elizaLogger.log(`Room ${roomId} created successfully.`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Compose the state of the agent into an object that can be passed or used for response generation.\r\n     * @param message The message to compose the state from.\r\n     * @returns The state of the agent.\r\n     */\r\n    async composeState(\r\n        message: Memory,\r\n        additionalKeys: { [key: string]: unknown } = {},\r\n    ) {\r\n        const { userId, roomId } = message;\r\n\r\n        const conversationLength = this.getConversationLength();\r\n\r\n        const [actorsData, recentMessagesData, goalsData]: [\r\n            Actor[],\r\n            Memory[],\r\n            Goal[],\r\n        ] = await Promise.all([\r\n            getActorDetails({ runtime: this, roomId }),\r\n            this.messageManager.getMemories({\r\n                roomId,\r\n                count: conversationLength,\r\n                unique: false,\r\n            }),\r\n            getGoals({\r\n                runtime: this,\r\n                count: 10,\r\n                onlyInProgress: false,\r\n                roomId,\r\n            }),\r\n        ]);\r\n\r\n        const goals = formatGoalsAsString({ goals: goalsData });\r\n\r\n        const actors = formatActors({ actors: actorsData ?? [] });\r\n\r\n        const recentMessages = formatMessages({\r\n            messages: recentMessagesData,\r\n            actors: actorsData,\r\n        });\r\n\r\n        const recentPosts = formatPosts({\r\n            messages: recentMessagesData,\r\n            actors: actorsData,\r\n            conversationHeader: false,\r\n        });\r\n\r\n        // const lore = formatLore(loreData);\r\n\r\n        const senderName = actorsData?.find(\r\n            (actor: Actor) => actor.id === userId,\r\n        )?.name;\r\n\r\n        // TODO: We may wish to consolidate and just accept character.name here instead of the actor name\r\n        const agentName =\r\n            actorsData?.find((actor: Actor) => actor.id === this.agentId)\r\n                ?.name || this.character.name;\r\n\r\n        let allAttachments = message.content.attachments || [];\r\n\r\n        if (recentMessagesData && Array.isArray(recentMessagesData)) {\r\n            const lastMessageWithAttachment = recentMessagesData.find(\r\n                (msg) =>\r\n                    msg.content.attachments &&\r\n                    msg.content.attachments.length > 0,\r\n            );\r\n\r\n            if (lastMessageWithAttachment) {\r\n                const lastMessageTime =\r\n                    lastMessageWithAttachment?.createdAt ?? Date.now();\r\n                const oneHourBeforeLastMessage =\r\n                    lastMessageTime - 60 * 60 * 1000; // 1 hour before last message\r\n\r\n                allAttachments = recentMessagesData.reverse().flatMap((msg) => {\r\n                    const msgTime = msg.createdAt ?? Date.now();\r\n                    const isWithinTime = msgTime >= oneHourBeforeLastMessage;\r\n                    const attachments = msg.content.attachments || [];\r\n                    if (!isWithinTime) {\r\n                        attachments.forEach((attachment) => {\r\n                            attachment.text = \"[Hidden]\";\r\n                        });\r\n                    }\r\n                    return attachments;\r\n                });\r\n            }\r\n        }\r\n\r\n        const formattedAttachments = allAttachments\r\n            .map(\r\n                (attachment) =>\r\n                    `ID: ${attachment.id}\r\nName: ${attachment.title}\r\nURL: ${attachment.url}\r\nType: ${attachment.source}\r\nDescription: ${attachment.description}\r\nText: ${attachment.text}\r\n  `,\r\n            )\r\n            .join(\"\\n\");\r\n\r\n        // randomly get 3 bits of lore and join them into a paragraph, divided by \\n\r\n        let lore = \"\";\r\n        // Assuming this.lore is an array of lore bits\r\n        if (this.character.lore && this.character.lore.length > 0) {\r\n            const shuffledLore = [...this.character.lore].sort(\r\n                () => Math.random() - 0.5,\r\n            );\r\n            const selectedLore = shuffledLore.slice(0, 10);\r\n            lore = selectedLore.join(\"\\n\");\r\n        }\r\n\r\n        const formattedCharacterPostExamples = this.character.postExamples\r\n            .sort(() => 0.5 - Math.random())\r\n            .map((post) => {\r\n                const messageString = `${post}`;\r\n                return messageString;\r\n            })\r\n            .slice(0, 50)\r\n            .join(\"\\n\");\r\n\r\n        const formattedCharacterMessageExamples = this.character.messageExamples\r\n            .sort(() => 0.5 - Math.random())\r\n            .slice(0, 5)\r\n            .map((example) => {\r\n                const exampleNames = Array.from({ length: 5 }, () =>\r\n                    uniqueNamesGenerator({ dictionaries: [names] }),\r\n                );\r\n\r\n                return example\r\n                    .map((message) => {\r\n                        let messageString = `${message.user}: ${message.content.text}`;\r\n                        exampleNames.forEach((name, index) => {\r\n                            const placeholder = `{{user${index + 1}}}`;\r\n                            messageString = messageString.replaceAll(\r\n                                placeholder,\r\n                                name,\r\n                            );\r\n                        });\r\n                        return messageString;\r\n                    })\r\n                    .join(\"\\n\");\r\n            })\r\n            .join(\"\\n\\n\");\r\n\r\n        const getRecentInteractions = async (\r\n            userA: UUID,\r\n            userB: UUID,\r\n        ): Promise<Memory[]> => {\r\n            // Find all rooms where userA and userB are participants\r\n            const rooms = await this.databaseAdapter.getRoomsForParticipants([\r\n                userA,\r\n                userB,\r\n            ]);\r\n\r\n            // Check the existing memories in the database\r\n            return this.messageManager.getMemoriesByRoomIds({\r\n                // filter out the current room id from rooms\r\n                roomIds: rooms.filter((room) => room !== roomId),\r\n                limit: 20,\r\n            });\r\n        };\r\n\r\n        const recentInteractions =\r\n            userId !== this.agentId\r\n                ? await getRecentInteractions(userId, this.agentId)\r\n                : [];\r\n\r\n        const getRecentMessageInteractions = async (\r\n            recentInteractionsData: Memory[],\r\n        ): Promise<string> => {\r\n            // Format the recent messages\r\n            const formattedInteractions = await Promise.all(\r\n                recentInteractionsData.map(async (message) => {\r\n                    const isSelf = message.userId === this.agentId;\r\n                    let sender: string;\r\n                    if (isSelf) {\r\n                        sender = this.character.name;\r\n                    } else {\r\n                        const accountId =\r\n                            await this.databaseAdapter.getAccountById(\r\n                                message.userId,\r\n                            );\r\n                        sender = accountId?.username || \"unknown\";\r\n                    }\r\n                    return `${sender}: ${message.content.text}`;\r\n                }),\r\n            );\r\n\r\n            return formattedInteractions.join(\"\\n\");\r\n        };\r\n\r\n        const formattedMessageInteractions =\r\n            await getRecentMessageInteractions(recentInteractions);\r\n\r\n        const getRecentPostInteractions = async (\r\n            recentInteractionsData: Memory[],\r\n            actors: Actor[],\r\n        ): Promise<string> => {\r\n            const formattedInteractions = formatPosts({\r\n                messages: recentInteractionsData,\r\n                actors,\r\n                conversationHeader: true,\r\n            });\r\n\r\n            return formattedInteractions;\r\n        };\r\n\r\n        const formattedPostInteractions = await getRecentPostInteractions(\r\n            recentInteractions,\r\n            actorsData,\r\n        );\r\n\r\n        // if bio is a string, use it. if its an array, pick one at random\r\n        let bio = this.character.bio || \"\";\r\n        if (Array.isArray(bio)) {\r\n            // get three random bio strings and join them with \" \"\r\n            bio = bio\r\n                .sort(() => 0.5 - Math.random())\r\n                .slice(0, 3)\r\n                .join(\" \");\r\n        }\r\n\r\n        let knowledgeData = [];\r\n        let formattedKnowledge = \"\";\r\n\r\n        if (this.character.settings?.ragKnowledge) {\r\n            const recentContext = recentMessagesData\r\n                .sort((a, b) => b.createdAt - a.createdAt) // Sort by timestamp descending (newest first)\r\n                .slice(0, 3) // Get the 3 most recent messages\r\n                .reverse() // Reverse to get chronological order\r\n                .map((msg) => msg.content.text)\r\n                .join(\" \");\r\n\r\n            knowledgeData = await this.ragKnowledgeManager.getKnowledge({\r\n                query: message.content.text,\r\n                conversationContext: recentContext,\r\n                limit: 8,\r\n            });\r\n\r\n            formattedKnowledge = formatKnowledge(knowledgeData);\r\n        } else {\r\n            knowledgeData = await knowledge.get(this, message);\r\n\r\n            formattedKnowledge = formatKnowledge(knowledgeData);\r\n        }\r\n\r\n        const initialState = {\r\n            agentId: this.agentId,\r\n            agentName,\r\n            bio,\r\n            lore,\r\n            adjective:\r\n                this.character.adjectives &&\r\n                this.character.adjectives.length > 0\r\n                    ? this.character.adjectives[\r\n                          Math.floor(\r\n                              Math.random() * this.character.adjectives.length,\r\n                          )\r\n                      ]\r\n                    : \"\",\r\n            knowledge: formattedKnowledge,\r\n            knowledgeData: knowledgeData,\r\n            ragKnowledgeData: knowledgeData,\r\n            // Recent interactions between the sender and receiver, formatted as messages\r\n            recentMessageInteractions: formattedMessageInteractions,\r\n            // Recent interactions between the sender and receiver, formatted as posts\r\n            recentPostInteractions: formattedPostInteractions,\r\n            // Raw memory[] array of interactions\r\n            recentInteractionsData: recentInteractions,\r\n            // randomly pick one topic\r\n            topic:\r\n                this.character.topics && this.character.topics.length > 0\r\n                    ? this.character.topics[\r\n                          Math.floor(\r\n                              Math.random() * this.character.topics.length,\r\n                          )\r\n                      ]\r\n                    : null,\r\n            topics:\r\n                this.character.topics && this.character.topics.length > 0\r\n                    ? `${this.character.name} is interested in ` +\r\n                      this.character.topics\r\n                          .sort(() => 0.5 - Math.random())\r\n                          .slice(0, 5)\r\n                          .map((topic, index, array) => {\r\n                              if (index === array.length - 2) {\r\n                                  return topic + \" and \";\r\n                              }\r\n                              // if last topic, don't add a comma\r\n                              if (index === array.length - 1) {\r\n                                  return topic;\r\n                              }\r\n                              return topic + \", \";\r\n                          })\r\n                          .join(\"\")\r\n                    : \"\",\r\n            characterPostExamples:\r\n                formattedCharacterPostExamples &&\r\n                formattedCharacterPostExamples.replaceAll(\"\\n\", \"\").length > 0\r\n                    ? addHeader(\r\n                          `# Example Posts for ${this.character.name}`,\r\n                          formattedCharacterPostExamples,\r\n                      )\r\n                    : \"\",\r\n            characterMessageExamples:\r\n                formattedCharacterMessageExamples &&\r\n                formattedCharacterMessageExamples.replaceAll(\"\\n\", \"\").length >\r\n                    0\r\n                    ? addHeader(\r\n                          `# Example Conversations for ${this.character.name}`,\r\n                          formattedCharacterMessageExamples,\r\n                      )\r\n                    : \"\",\r\n            messageDirections:\r\n                this.character?.style?.all?.length > 0 ||\r\n                this.character?.style?.chat.length > 0\r\n                    ? addHeader(\r\n                          \"# Message Directions for \" + this.character.name,\r\n                          (() => {\r\n                              const all = this.character?.style?.all || [];\r\n                              const chat = this.character?.style?.chat || [];\r\n                              return [...all, ...chat].join(\"\\n\");\r\n                          })(),\r\n                      )\r\n                    : \"\",\r\n\r\n            postDirections:\r\n                this.character?.style?.all?.length > 0 ||\r\n                this.character?.style?.post.length > 0\r\n                    ? addHeader(\r\n                          \"# Post Directions for \" + this.character.name,\r\n                          (() => {\r\n                              const all = this.character?.style?.all || [];\r\n                              const post = this.character?.style?.post || [];\r\n                              return [...all, ...post].join(\"\\n\");\r\n                          })(),\r\n                      )\r\n                    : \"\",\r\n\r\n            //old logic left in for reference\r\n            //food for thought. how could we dynamically decide what parts of the character to add to the prompt other than random? rag? prompt the llm to decide?\r\n            /*\r\n            postDirections:\r\n                this.character?.style?.all?.length > 0 ||\r\n                this.character?.style?.post.length > 0\r\n                    ? addHeader(\r\n                            \"# Post Directions for \" + this.character.name,\r\n                            (() => {\r\n                                const all = this.character?.style?.all || [];\r\n                                const post = this.character?.style?.post || [];\r\n                                const shuffled = [...all, ...post].sort(\r\n                                    () => 0.5 - Math.random()\r\n                                );\r\n                                return shuffled\r\n                                    .slice(0, conversationLength / 2)\r\n                                    .join(\"\\n\");\r\n                            })()\r\n                        )\r\n                    : \"\",*/\r\n            // Agent runtime stuff\r\n            senderName,\r\n            actors:\r\n                actors && actors.length > 0\r\n                    ? addHeader(\"# Actors\", actors)\r\n                    : \"\",\r\n            actorsData,\r\n            roomId,\r\n            goals:\r\n                goals && goals.length > 0\r\n                    ? addHeader(\r\n                          \"# Goals\\n{{agentName}} should prioritize accomplishing the objectives that are in progress.\",\r\n                          goals,\r\n                      )\r\n                    : \"\",\r\n            goalsData,\r\n            recentMessages:\r\n                recentMessages && recentMessages.length > 0\r\n                    ? addHeader(\"# Conversation Messages\", recentMessages)\r\n                    : \"\",\r\n            recentPosts:\r\n                recentPosts && recentPosts.length > 0\r\n                    ? addHeader(\"# Posts in Thread\", recentPosts)\r\n                    : \"\",\r\n            recentMessagesData,\r\n            attachments:\r\n                formattedAttachments && formattedAttachments.length > 0\r\n                    ? addHeader(\"# Attachments\", formattedAttachments)\r\n                    : \"\",\r\n            ...additionalKeys,\r\n        } as State;\r\n\r\n        const actionPromises = this.actions.map(async (action: Action) => {\r\n            const result = await action.validate(this, message, initialState);\r\n            if (result) {\r\n                return action;\r\n            }\r\n            return null;\r\n        });\r\n\r\n        const evaluatorPromises = this.evaluators.map(async (evaluator) => {\r\n            const result = await evaluator.validate(\r\n                this,\r\n                message,\r\n                initialState,\r\n            );\r\n            if (result) {\r\n                return evaluator;\r\n            }\r\n            return null;\r\n        });\r\n\r\n        const [resolvedEvaluators, resolvedActions, providers] =\r\n            await Promise.all([\r\n                Promise.all(evaluatorPromises),\r\n                Promise.all(actionPromises),\r\n                getProviders(this, message, initialState),\r\n            ]);\r\n\r\n        const evaluatorsData = resolvedEvaluators.filter(\r\n            Boolean,\r\n        ) as Evaluator[];\r\n        const actionsData = resolvedActions.filter(Boolean) as Action[];\r\n\r\n        const actionState = {\r\n            actionNames:\r\n                \"Possible response actions: \" + formatActionNames(actionsData),\r\n            actions:\r\n                actionsData.length > 0\r\n                    ? addHeader(\r\n                          \"# Available Actions\",\r\n                          formatActions(actionsData),\r\n                      )\r\n                    : \"\",\r\n            actionExamples:\r\n                actionsData.length > 0\r\n                    ? addHeader(\r\n                          \"# Action Examples\",\r\n                          composeActionExamples(actionsData, 10),\r\n                      )\r\n                    : \"\",\r\n            evaluatorsData,\r\n            evaluators:\r\n                evaluatorsData.length > 0\r\n                    ? formatEvaluators(evaluatorsData)\r\n                    : \"\",\r\n            evaluatorNames:\r\n                evaluatorsData.length > 0\r\n                    ? formatEvaluatorNames(evaluatorsData)\r\n                    : \"\",\r\n            evaluatorExamples:\r\n                evaluatorsData.length > 0\r\n                    ? formatEvaluatorExamples(evaluatorsData)\r\n                    : \"\",\r\n            providers: addHeader(\r\n                `# Additional Information About ${this.character.name} and The World`,\r\n                providers,\r\n            ),\r\n        };\r\n\r\n        return { ...initialState, ...actionState } as State;\r\n    }\r\n\r\n    async updateRecentMessageState(state: State): Promise<State> {\r\n        const conversationLength = this.getConversationLength();\r\n        const recentMessagesData = await this.messageManager.getMemories({\r\n            roomId: state.roomId,\r\n            count: conversationLength,\r\n            unique: false,\r\n        });\r\n\r\n        const recentMessages = formatMessages({\r\n            actors: state.actorsData ?? [],\r\n            messages: recentMessagesData.map((memory: Memory) => {\r\n                const newMemory = { ...memory };\r\n                delete newMemory.embedding;\r\n                return newMemory;\r\n            }),\r\n        });\r\n\r\n        let allAttachments = [];\r\n\r\n        if (recentMessagesData && Array.isArray(recentMessagesData)) {\r\n            const lastMessageWithAttachment = recentMessagesData.find(\r\n                (msg) =>\r\n                    msg.content.attachments &&\r\n                    msg.content.attachments.length > 0,\r\n            );\r\n\r\n            if (lastMessageWithAttachment) {\r\n                const lastMessageTime =\r\n                    lastMessageWithAttachment?.createdAt ?? Date.now();\r\n                const oneHourBeforeLastMessage =\r\n                    lastMessageTime - 60 * 60 * 1000; // 1 hour before last message\r\n\r\n                allAttachments = recentMessagesData\r\n                    .filter((msg) => {\r\n                        const msgTime = msg.createdAt ?? Date.now();\r\n                        return msgTime >= oneHourBeforeLastMessage;\r\n                    })\r\n                    .flatMap((msg) => msg.content.attachments || []);\r\n            }\r\n        }\r\n\r\n        const formattedAttachments = allAttachments\r\n            .map(\r\n                (attachment) =>\r\n                    `ID: ${attachment.id}\r\nName: ${attachment.title}\r\nURL: ${attachment.url}\r\nType: ${attachment.source}\r\nDescription: ${attachment.description}\r\nText: ${attachment.text}\r\n    `,\r\n            )\r\n            .join(\"\\n\");\r\n\r\n        return {\r\n            ...state,\r\n            recentMessages: addHeader(\r\n                \"# Conversation Messages\",\r\n                recentMessages,\r\n            ),\r\n            recentMessagesData,\r\n            attachments: formattedAttachments,\r\n        } as State;\r\n    }\r\n}\r\n\r\nconst formatKnowledge = (knowledge: KnowledgeItem[]) => {\r\n    // Group related content in a more natural way\r\n    return knowledge.map(item => {\r\n        // Get the main content text\r\n        const text = item.content.text;\r\n\r\n        // Clean up formatting but maintain natural text flow\r\n        const cleanedText = text\r\n            .trim()\r\n            .replace(/\\n{3,}/g, '\\n\\n'); // Replace excessive newlines\r\n\r\n        return cleanedText;\r\n    }).join('\\n\\n'); // Separate distinct pieces with double newlines\r\n};\r\n","import { sha1 } from \"js-sha1\";\r\nimport type { UUID } from \"./types.ts\";\r\nimport { z } from \"zod\";\r\n\r\nexport const uuidSchema = z.string().uuid() as z.ZodType<UUID>;\r\n\r\nexport function validateUuid(value: unknown): UUID | null {\r\n    const result = uuidSchema.safeParse(value);\r\n    return result.success ? result.data : null;\r\n}\r\n\r\nexport function stringToUuid(target: string | number): UUID {\r\n    if (typeof target === \"number\") {\r\n        target = (target as number).toString();\r\n    }\r\n\r\n    if (typeof target !== \"string\") {\r\n        throw TypeError(\"Value must be string\");\r\n    }\r\n\r\n    const _uint8ToHex = (ubyte: number): string => {\r\n        const first = ubyte >> 4;\r\n        const second = ubyte - (first << 4);\r\n        const HEX_DIGITS = \"0123456789abcdef\".split(\"\");\r\n        return HEX_DIGITS[first] + HEX_DIGITS[second];\r\n    };\r\n\r\n    const _uint8ArrayToHex = (buf: Uint8Array): string => {\r\n        let out = \"\";\r\n        for (let i = 0; i < buf.length; i++) {\r\n            out += _uint8ToHex(buf[i]);\r\n        }\r\n        return out;\r\n    };\r\n\r\n    const escapedStr = encodeURIComponent(target);\r\n    const buffer = new Uint8Array(escapedStr.length);\r\n    for (let i = 0; i < escapedStr.length; i++) {\r\n        buffer[i] = escapedStr[i].charCodeAt(0);\r\n    }\r\n\r\n    const hash = sha1(buffer);\r\n    const hashBuffer = new Uint8Array(hash.length / 2);\r\n    for (let i = 0; i < hash.length; i += 2) {\r\n        hashBuffer[i / 2] = Number.parseInt(hash.slice(i, i + 2), 16);\r\n    }\r\n\r\n    return (_uint8ArrayToHex(hashBuffer.slice(0, 4)) +\r\n        \"-\" +\r\n        _uint8ArrayToHex(hashBuffer.slice(4, 6)) +\r\n        \"-\" +\r\n        _uint8ToHex(hashBuffer[6] & 0x0f) +\r\n        _uint8ToHex(hashBuffer[7]) +\r\n        \"-\" +\r\n        _uint8ToHex((hashBuffer[8] & 0x3f) | 0x80) +\r\n        _uint8ToHex(hashBuffer[9]) +\r\n        \"-\" +\r\n        _uint8ArrayToHex(hashBuffer.slice(10, 16))) as UUID;\r\n}\r\n","import type { AgentRuntime } from \"./runtime.ts\";\r\nimport { embed, getEmbeddingZeroVector } from \"./embedding.ts\";\r\nimport type { KnowledgeItem, UUID, Memory } from \"./types.ts\";\r\nimport { stringToUuid } from \"./uuid.ts\";\r\nimport { splitChunks } from \"./generation.ts\";\r\nimport elizaLogger from \"./logger.ts\";\r\n\r\nasync function get(\r\n    runtime: AgentRuntime,\r\n    message: Memory\r\n): Promise<KnowledgeItem[]> {\r\n    // Add validation for message\r\n    if (!message?.content?.text) {\r\n        elizaLogger.warn(\"Invalid message for knowledge query:\", {\r\n            message,\r\n            content: message?.content,\r\n            text: message?.content?.text,\r\n        });\r\n        return [];\r\n    }\r\n\r\n    const processed = preprocess(message.content.text);\r\n    elizaLogger.debug(\"Knowledge query:\", {\r\n        original: message.content.text,\r\n        processed,\r\n        length: processed?.length,\r\n    });\r\n\r\n    // Validate processed text\r\n    if (!processed || processed.trim().length === 0) {\r\n        elizaLogger.warn(\"Empty processed text for knowledge query\");\r\n        return [];\r\n    }\r\n\r\n    const embedding = await embed(runtime, processed);\r\n    const fragments = await runtime.knowledgeManager.searchMemoriesByEmbedding(\r\n        embedding,\r\n        {\r\n            roomId: message.agentId,\r\n            count: 5,\r\n            match_threshold: 0.1,\r\n        }\r\n    );\r\n\r\n    const uniqueSources = [\r\n        ...new Set(\r\n            fragments.map((memory) => {\r\n                elizaLogger.log(\r\n                    `Matched fragment: ${memory.content.text} with similarity: ${memory.similarity}`\r\n                );\r\n                return memory.content.source;\r\n            })\r\n        ),\r\n    ];\r\n\r\n    const knowledgeDocuments = await Promise.all(\r\n        uniqueSources.map((source) =>\r\n            runtime.documentsManager.getMemoryById(source as UUID)\r\n        )\r\n    );\r\n\r\n    return knowledgeDocuments\r\n        .filter((memory) => memory !== null)\r\n        .map((memory) => ({ id: memory.id, content: memory.content }));\r\n}\r\n\r\nasync function set(\r\n    runtime: AgentRuntime,\r\n    item: KnowledgeItem,\r\n    chunkSize = 512, // in tokens\r\n    bleed = 20 // in tokens\r\n) {\r\n    // create document\r\n    await runtime.documentsManager.createMemory({\r\n        id: item.id,\r\n        agentId: runtime.agentId,\r\n        roomId: runtime.agentId,\r\n        userId: runtime.agentId,\r\n        createdAt: Date.now(),\r\n        content: item.content,\r\n        embedding: getEmbeddingZeroVector(),\r\n    });\r\n\r\n    // create knowledge\r\n    const preprocessed = preprocess(item.content.text); // normalizes it (lowering case/clean up)\r\n    const fragments = await splitChunks(preprocessed, chunkSize, bleed);\r\n    for (const fragment of fragments) {\r\n        const embedding = await embed(runtime, fragment);\r\n        await runtime.knowledgeManager.createMemory({\r\n            // We namespace the knowledge base uuid to avoid id\r\n            // collision with the document above.\r\n            id: stringToUuid(item.id + fragment),\r\n            roomId: runtime.agentId,\r\n            agentId: runtime.agentId,\r\n            userId: runtime.agentId,\r\n            createdAt: Date.now(),\r\n            content: {\r\n                source: item.id,\r\n                text: fragment,\r\n            },\r\n            embedding,\r\n        });\r\n    }\r\n}\r\n\r\nexport function preprocess(content: string): string {\r\n    elizaLogger.debug(\"Preprocessing text:\", {\r\n        input: content,\r\n        length: content?.length,\r\n    });\r\n\r\n    if (!content || typeof content !== \"string\") {\r\n        elizaLogger.warn(\"Invalid input for preprocessing\");\r\n        return \"\";\r\n    }\r\n\r\n    return (\r\n        content\r\n            // Remove code blocks and their content\r\n            .replace(/```[\\s\\S]*?```/g, \"\")\r\n            // Remove inline code\r\n            .replace(/`.*?`/g, \"\")\r\n            // Convert headers to plain text with emphasis\r\n            .replace(/#{1,6}\\s*(.*)/g, \"$1\")\r\n            // Remove image links but keep alt text\r\n            .replace(/!\\[(.*?)\\]\\(.*?\\)/g, \"$1\")\r\n            // Remove links but keep text\r\n            .replace(/\\[(.*?)\\]\\(.*?\\)/g, \"$1\")\r\n            // Simplify URLs: remove protocol and simplify to domain+path\r\n            .replace(/(https?:\\/\\/)?(www\\.)?([^\\s]+\\.[^\\s]+)/g, \"$3\")\r\n            // Remove Discord mentions specifically\r\n            .replace(/<@[!&]?\\d+>/g, \"\")\r\n            // Remove HTML tags\r\n            .replace(/<[^>]*>/g, \"\")\r\n            // Remove horizontal rules\r\n            .replace(/^\\s*[-*_]{3,}\\s*$/gm, \"\")\r\n            // Remove comments\r\n            .replace(/\\/\\*[\\s\\S]*?\\*\\//g, \"\")\r\n            .replace(/\\/\\/.*/g, \"\")\r\n            // Normalize whitespace\r\n            .replace(/\\s+/g, \" \")\r\n            // Remove multiple newlines\r\n            .replace(/\\n{3,}/g, \"\\n\\n\")\r\n            // Remove special characters except those common in URLs\r\n            .replace(/[^a-zA-Z0-9\\s\\-_./:?=&]/g, \"\")\r\n            .trim()\r\n            .toLowerCase()\r\n    );\r\n}\r\n\r\nexport default {\r\n    get,\r\n    set,\r\n    preprocess,\r\n};\r\n","import { embed } from \"./embedding.ts\";\r\nimport { splitChunks } from \"./generation.ts\";\r\nimport elizaLogger from \"./logger.ts\";\r\nimport {\r\n    type IAgentRuntime,\r\n    type IRAGKnowledgeManager,\r\n    type RAGKnowledgeItem,\r\n    type UUID,\r\n    KnowledgeScope,\r\n} from \"./types.ts\";\r\nimport { stringToUuid } from \"./uuid.ts\";\r\nimport { existsSync } from \"fs\";\r\nimport { join } from \"path\";\r\n\r\n/**\r\n * Manage knowledge in the database.\r\n */\r\nexport class RAGKnowledgeManager implements IRAGKnowledgeManager {\r\n    /**\r\n     * The AgentRuntime instance associated with this manager.\r\n     */\r\n    runtime: IAgentRuntime;\r\n\r\n    /**\r\n     * The name of the database table this manager operates on.\r\n     */\r\n    tableName: string;\r\n\r\n    /**\r\n     * The root directory where RAG knowledge files are located (internal)\r\n     */\r\n    knowledgeRoot: string;\r\n\r\n    /**\r\n     * Constructs a new KnowledgeManager instance.\r\n     * @param opts Options for the manager.\r\n     * @param opts.tableName The name of the table this manager will operate on.\r\n     * @param opts.runtime The AgentRuntime instance associated with this manager.\r\n     */\r\n    constructor(opts: {\r\n        tableName: string;\r\n        runtime: IAgentRuntime;\r\n        knowledgeRoot: string;\r\n    }) {\r\n        this.runtime = opts.runtime;\r\n        this.tableName = opts.tableName;\r\n        this.knowledgeRoot = opts.knowledgeRoot;\r\n    }\r\n\r\n    private readonly defaultRAGMatchThreshold = 0.85;\r\n    private readonly defaultRAGMatchCount = 8;\r\n\r\n    /**\r\n     * Common English stop words to filter out from query analysis\r\n     */\r\n    private readonly stopWords = new Set([\r\n        \"a\",\r\n        \"an\",\r\n        \"and\",\r\n        \"are\",\r\n        \"as\",\r\n        \"at\",\r\n        \"be\",\r\n        \"by\",\r\n        \"does\",\r\n        \"for\",\r\n        \"from\",\r\n        \"had\",\r\n        \"has\",\r\n        \"have\",\r\n        \"he\",\r\n        \"her\",\r\n        \"his\",\r\n        \"how\",\r\n        \"hey\",\r\n        \"i\",\r\n        \"in\",\r\n        \"is\",\r\n        \"it\",\r\n        \"its\",\r\n        \"of\",\r\n        \"on\",\r\n        \"or\",\r\n        \"that\",\r\n        \"the\",\r\n        \"this\",\r\n        \"to\",\r\n        \"was\",\r\n        \"what\",\r\n        \"when\",\r\n        \"where\",\r\n        \"which\",\r\n        \"who\",\r\n        \"will\",\r\n        \"with\",\r\n        \"would\",\r\n        \"there\",\r\n        \"their\",\r\n        \"they\",\r\n        \"your\",\r\n        \"you\",\r\n    ]);\r\n\r\n    /**\r\n     * Filters out stop words and returns meaningful terms\r\n     */\r\n    private getQueryTerms(query: string): string[] {\r\n        return query\r\n            .toLowerCase()\r\n            .split(\" \")\r\n            .filter((term) => term.length > 2) // Filter very short words\r\n            .filter((term) => !this.stopWords.has(term)); // Filter stop words\r\n    }\r\n\r\n    /**\r\n     * Preprocesses text content for better RAG performance.\r\n     * @param content The text content to preprocess.\r\n     * @returns The preprocessed text.\r\n     */\r\n\r\n    private preprocess(content: string): string {\r\n        if (!content || typeof content !== \"string\") {\r\n            elizaLogger.warn(\"Invalid input for preprocessing\");\r\n            return \"\";\r\n        }\r\n\r\n        return (\r\n            content\r\n                .replace(/```[\\s\\S]*?```/g, \"\")\r\n                .replace(/`.*?`/g, \"\")\r\n                .replace(/#{1,6}\\s*(.*)/g, \"$1\")\r\n                .replace(/!\\[(.*?)\\]\\(.*?\\)/g, \"$1\")\r\n                .replace(/\\[(.*?)\\]\\(.*?\\)/g, \"$1\")\r\n                .replace(/(https?:\\/\\/)?(www\\.)?([^\\s]+\\.[^\\s]+)/g, \"$3\")\r\n                .replace(/<@[!&]?\\d+>/g, \"\")\r\n                .replace(/<[^>]*>/g, \"\")\r\n                .replace(/^\\s*[-*_]{3,}\\s*$/gm, \"\")\r\n                .replace(/\\/\\*[\\s\\S]*?\\*\\//g, \"\")\r\n                .replace(/\\/\\/.*/g, \"\")\r\n                .replace(/\\s+/g, \" \")\r\n                .replace(/\\n{3,}/g, \"\\n\\n\")\r\n                // .replace(/[^a-zA-Z0-9\\s\\-_./:?=&]/g, \"\") --this strips out CJK characters\r\n                .trim()\r\n                .toLowerCase()\r\n        );\r\n    }\r\n\r\n    private hasProximityMatch(text: string, terms: string[]): boolean {\r\n        if (!text || !terms.length) {\r\n            return false;\r\n        }\r\n    \r\n        const words = text.toLowerCase().split(\" \").filter(w => w.length > 0);\r\n        \r\n        // Find all positions for each term (not just first occurrence)\r\n        const allPositions = terms.flatMap(term => \r\n            words.reduce((positions, word, idx) => {\r\n                if (word.includes(term)) positions.push(idx);\r\n                return positions;\r\n            }, [] as number[])\r\n        ).sort((a, b) => a - b);\r\n    \r\n        if (allPositions.length < 2) return false;\r\n    \r\n        // Check proximity\r\n        for (let i = 0; i < allPositions.length - 1; i++) {\r\n            if (Math.abs(allPositions[i] - allPositions[i + 1]) <= 5) {\r\n                elizaLogger.debug(\"[Proximity Match]\", {\r\n                    terms,\r\n                    positions: allPositions,\r\n                    matchFound: `${allPositions[i]} - ${allPositions[i + 1]}`\r\n                });\r\n                return true;\r\n            }\r\n        }\r\n    \r\n        return false;\r\n    }\r\n\r\n    async getKnowledge(params: {\r\n        query?: string;\r\n        id?: UUID;\r\n        conversationContext?: string;\r\n        limit?: number;\r\n        agentId?: UUID;\r\n    }): Promise<RAGKnowledgeItem[]> {\r\n        const agentId = params.agentId || this.runtime.agentId;\r\n\r\n        // If id is provided, do direct lookup first\r\n        if (params.id) {\r\n            const directResults =\r\n                await this.runtime.databaseAdapter.getKnowledge({\r\n                    id: params.id,\r\n                    agentId: agentId,\r\n                });\r\n\r\n            if (directResults.length > 0) {\r\n                return directResults;\r\n            }\r\n        }\r\n\r\n        // If no id or no direct results, perform semantic search\r\n        if (params.query) {\r\n            try {\r\n                const processedQuery = this.preprocess(params.query);\r\n\r\n                // Build search text with optional context\r\n                let searchText = processedQuery;\r\n                if (params.conversationContext) {\r\n                    const relevantContext = this.preprocess(\r\n                        params.conversationContext\r\n                    );\r\n                    searchText = `${relevantContext} ${processedQuery}`;\r\n                }\r\n\r\n                const embeddingArray = await embed(this.runtime, searchText);\r\n\r\n                const embedding = new Float32Array(embeddingArray);\r\n\r\n                // Get results with single query\r\n                const results =\r\n                    await this.runtime.databaseAdapter.searchKnowledge({\r\n                        agentId: this.runtime.agentId,\r\n                        embedding: embedding,\r\n                        match_threshold: this.defaultRAGMatchThreshold,\r\n                        match_count:\r\n                            (params.limit || this.defaultRAGMatchCount) * 2,\r\n                        searchText: processedQuery,\r\n                    });\r\n\r\n                // Enhanced reranking with sophisticated scoring\r\n                const rerankedResults = results\r\n                    .map((result) => {\r\n                        let score = result.similarity;\r\n\r\n                        // Check for direct query term matches\r\n                        const queryTerms = this.getQueryTerms(processedQuery);\r\n\r\n                        const matchingTerms = queryTerms.filter((term) =>\r\n                            result.content.text.toLowerCase().includes(term)\r\n                        );\r\n\r\n                        if (matchingTerms.length > 0) {\r\n                            // Much stronger boost for matches\r\n                            score *=\r\n                                1 +\r\n                                (matchingTerms.length / queryTerms.length) * 2; // Double the boost\r\n\r\n                            if (\r\n                                this.hasProximityMatch(\r\n                                    result.content.text,\r\n                                    matchingTerms\r\n                                )\r\n                            ) {\r\n                                score *= 1.5; // Stronger proximity boost\r\n                            }\r\n                        } else {\r\n                            // More aggressive penalty\r\n                            if (!params.conversationContext) {\r\n                                score *= 0.3; // Stronger penalty\r\n                            }\r\n                        }\r\n\r\n                        return {\r\n                            ...result,\r\n                            score,\r\n                            matchedTerms: matchingTerms, // Add for debugging\r\n                        };\r\n                    })\r\n                    .sort((a, b) => b.score - a.score);\r\n\r\n                // Filter and return results\r\n                return rerankedResults\r\n                    .filter(\r\n                        (result) =>\r\n                            result.score >= this.defaultRAGMatchThreshold\r\n                    )\r\n                    .slice(0, params.limit || this.defaultRAGMatchCount);\r\n            } catch (error) {\r\n                console.log(`[RAG Search Error] ${error}`);\r\n                return [];\r\n            }\r\n        }\r\n\r\n        // If neither id nor query provided, return empty array\r\n        return [];\r\n    }\r\n\r\n    async createKnowledge(item: RAGKnowledgeItem): Promise<void> {\r\n        if (!item.content.text) {\r\n            elizaLogger.warn(\"Empty content in knowledge item\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            // Process main document\r\n            const processedContent = this.preprocess(item.content.text);\r\n            const mainEmbeddingArray = await embed(\r\n                this.runtime,\r\n                processedContent\r\n            );\r\n\r\n            const mainEmbedding = new Float32Array(mainEmbeddingArray);\r\n\r\n            // Create main document\r\n            await this.runtime.databaseAdapter.createKnowledge({\r\n                id: item.id,\r\n                agentId: this.runtime.agentId,\r\n                content: {\r\n                    text: item.content.text,\r\n                    metadata: {\r\n                        ...item.content.metadata,\r\n                        isMain: true,\r\n                    },\r\n                },\r\n                embedding: mainEmbedding,\r\n                createdAt: Date.now(),\r\n            });\r\n\r\n            // Generate and store chunks\r\n            const chunks = await splitChunks(processedContent, 512, 20);\r\n\r\n            for (const [index, chunk] of chunks.entries()) {\r\n                const chunkEmbeddingArray = await embed(this.runtime, chunk);\r\n                const chunkEmbedding = new Float32Array(chunkEmbeddingArray);\r\n                const chunkId = `${item.id}-chunk-${index}` as UUID;\r\n\r\n                await this.runtime.databaseAdapter.createKnowledge({\r\n                    id: chunkId,\r\n                    agentId: this.runtime.agentId,\r\n                    content: {\r\n                        text: chunk,\r\n                        metadata: {\r\n                            ...item.content.metadata,\r\n                            isChunk: true,\r\n                            originalId: item.id,\r\n                            chunkIndex: index,\r\n                        },\r\n                    },\r\n                    embedding: chunkEmbedding,\r\n                    createdAt: Date.now(),\r\n                });\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(`Error processing knowledge ${item.id}:`, error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async searchKnowledge(params: {\r\n        agentId: UUID;\r\n        embedding: Float32Array | number[];\r\n        match_threshold?: number;\r\n        match_count?: number;\r\n        searchText?: string;\r\n    }): Promise<RAGKnowledgeItem[]> {\r\n        const {\r\n            match_threshold = this.defaultRAGMatchThreshold,\r\n            match_count = this.defaultRAGMatchCount,\r\n            embedding,\r\n            searchText,\r\n        } = params;\r\n\r\n        const float32Embedding = Array.isArray(embedding)\r\n            ? new Float32Array(embedding)\r\n            : embedding;\r\n\r\n        return await this.runtime.databaseAdapter.searchKnowledge({\r\n            agentId: params.agentId || this.runtime.agentId,\r\n            embedding: float32Embedding,\r\n            match_threshold,\r\n            match_count,\r\n            searchText,\r\n        });\r\n    }\r\n\r\n    async removeKnowledge(id: UUID): Promise<void> {\r\n        await this.runtime.databaseAdapter.removeKnowledge(id);\r\n    }\r\n\r\n    async clearKnowledge(shared?: boolean): Promise<void> {\r\n        await this.runtime.databaseAdapter.clearKnowledge(\r\n            this.runtime.agentId,\r\n            shared ? shared : false\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Lists all knowledge entries for an agent without semantic search or reranking.\r\n     * Used primarily for administrative tasks like cleanup.\r\n     *\r\n     * @param agentId The agent ID to fetch knowledge entries for\r\n     * @returns Array of RAGKnowledgeItem entries\r\n     */\r\n    async listAllKnowledge(agentId: UUID): Promise<RAGKnowledgeItem[]> {\r\n        elizaLogger.debug(\r\n            `[Knowledge List] Fetching all entries for agent: ${agentId}`\r\n        );\r\n\r\n        try {\r\n            // Only pass the required agentId parameter\r\n            const results = await this.runtime.databaseAdapter.getKnowledge({\r\n                agentId: agentId,\r\n            });\r\n\r\n            elizaLogger.debug(\r\n                `[Knowledge List] Found ${results.length} entries`\r\n            );\r\n            return results;\r\n        } catch (error) {\r\n            elizaLogger.error(\r\n                \"[Knowledge List] Error fetching knowledge entries:\",\r\n                error\r\n            );\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    async cleanupDeletedKnowledgeFiles() {\r\n        try {\r\n            elizaLogger.debug(\r\n                \"[Cleanup] Starting knowledge cleanup process, agent: \",\r\n                this.runtime.agentId\r\n            );\r\n\r\n            elizaLogger.debug(\r\n                `[Cleanup] Knowledge root path: ${this.knowledgeRoot}`\r\n            );\r\n\r\n            const existingKnowledge = await this.listAllKnowledge(\r\n                this.runtime.agentId\r\n            );\r\n            // Only process parent documents, ignore chunks\r\n            const parentDocuments = existingKnowledge.filter(\r\n                (item) =>\r\n                    !item.id.includes(\"chunk\") && item.content.metadata?.source // Must have a source path\r\n            );\r\n\r\n            elizaLogger.debug(\r\n                `[Cleanup] Found ${parentDocuments.length} parent documents to check`\r\n            );\r\n\r\n            for (const item of parentDocuments) {\r\n                const relativePath = item.content.metadata?.source;\r\n                const filePath = join(this.knowledgeRoot, relativePath);\r\n\r\n                elizaLogger.debug(\r\n                    `[Cleanup] Checking joined file path: ${filePath}`\r\n                );\r\n\r\n                if (!existsSync(filePath)) {\r\n                    elizaLogger.warn(\r\n                        `[Cleanup] File not found, starting removal process: ${filePath}`\r\n                    );\r\n\r\n                    const idToRemove = item.id;\r\n                    elizaLogger.debug(\r\n                        `[Cleanup] Using ID for removal: ${idToRemove}`\r\n                    );\r\n\r\n                    try {\r\n                        // Just remove the parent document - this will cascade to chunks\r\n                        await this.removeKnowledge(idToRemove);\r\n\r\n                        // // Clean up the cache\r\n                        // const baseCacheKeyWithWildcard = `${this.generateKnowledgeCacheKeyBase(\r\n                        //     idToRemove,\r\n                        //     item.content.metadata?.isShared || false\r\n                        // )}*`;\r\n                        // await this.cacheManager.deleteByPattern({\r\n                        //     keyPattern: baseCacheKeyWithWildcard,\r\n                        // });\r\n\r\n                        elizaLogger.success(\r\n                            `[Cleanup] Successfully removed knowledge for file: ${filePath}`\r\n                        );\r\n                    } catch (deleteError) {\r\n                        elizaLogger.error(\r\n                            `[Cleanup] Error during deletion process for ${filePath}:`,\r\n                            deleteError instanceof Error\r\n                                ? {\r\n                                      message: deleteError.message,\r\n                                      stack: deleteError.stack,\r\n                                      name: deleteError.name,\r\n                                  }\r\n                                : deleteError\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n\r\n            elizaLogger.debug(\"[Cleanup] Finished knowledge cleanup process\");\r\n        } catch (error) {\r\n            elizaLogger.error(\r\n                \"[Cleanup] Error cleaning up deleted knowledge files:\",\r\n                error\r\n            );\r\n        }\r\n    }\r\n\r\n    public generateScopedId(path: string, isShared: boolean): UUID {\r\n        // Prefix the path with scope before generating UUID to ensure different IDs for shared vs private\r\n        const scope = isShared ? KnowledgeScope.SHARED : KnowledgeScope.PRIVATE;\r\n        const scopedPath = `${scope}-${path}`;\r\n        return stringToUuid(scopedPath);\r\n    }\r\n\r\n    async processFile(file: {\r\n        path: string;\r\n        content: string;\r\n        type: \"pdf\" | \"md\" | \"txt\";\r\n        isShared?: boolean;\r\n    }): Promise<void> {\r\n        const timeMarker = (label: string) => {\r\n            const time = (Date.now() - startTime) / 1000;\r\n            elizaLogger.info(`[Timing] ${label}: ${time.toFixed(2)}s`);\r\n        };\r\n\r\n        const startTime = Date.now();\r\n        const content = file.content;\r\n\r\n        try {\r\n            const fileSizeKB = new TextEncoder().encode(content).length / 1024;\r\n            elizaLogger.info(\r\n                `[File Progress] Starting ${file.path} (${fileSizeKB.toFixed(2)} KB)`\r\n            );\r\n\r\n            // Generate scoped ID for the file\r\n            const scopedId = this.generateScopedId(\r\n                file.path,\r\n                file.isShared || false\r\n            );\r\n\r\n            // Step 1: Preprocessing\r\n            //const preprocessStart = Date.now();\r\n            const processedContent = this.preprocess(content);\r\n            timeMarker(\"Preprocessing\");\r\n\r\n            // Step 2: Main document embedding\r\n            const mainEmbeddingArray = await embed(\r\n                this.runtime,\r\n                processedContent\r\n            );\r\n            const mainEmbedding = new Float32Array(mainEmbeddingArray);\r\n            timeMarker(\"Main embedding\");\r\n\r\n            // Step 3: Create main document\r\n            await this.runtime.databaseAdapter.createKnowledge({\r\n                id: scopedId,\r\n                agentId: this.runtime.agentId,\r\n                content: {\r\n                    text: content,\r\n                    metadata: {\r\n                        source: file.path,\r\n                        type: file.type,\r\n                        isShared: file.isShared || false,\r\n                    },\r\n                },\r\n                embedding: mainEmbedding,\r\n                createdAt: Date.now(),\r\n            });\r\n            timeMarker(\"Main document storage\");\r\n\r\n            // Step 4: Generate chunks\r\n            const chunks = await splitChunks(processedContent, 512, 20);\r\n            const totalChunks = chunks.length;\r\n            elizaLogger.info(`Generated ${totalChunks} chunks`);\r\n            timeMarker(\"Chunk generation\");\r\n\r\n            // Step 5: Process chunks with larger batches\r\n            const BATCH_SIZE = 10; // Increased batch size\r\n            let processedChunks = 0;\r\n\r\n            for (let i = 0; i < chunks.length; i += BATCH_SIZE) {\r\n                const batchStart = Date.now();\r\n                const batch = chunks.slice(\r\n                    i,\r\n                    Math.min(i + BATCH_SIZE, chunks.length)\r\n                );\r\n\r\n                // Process embeddings in parallel\r\n                const embeddings = await Promise.all(\r\n                    batch.map((chunk) => embed(this.runtime, chunk))\r\n                );\r\n\r\n                // Batch database operations\r\n                await Promise.all(\r\n                    embeddings.map(async (embeddingArray, index) => {\r\n                        const chunkId =\r\n                            `${scopedId}-chunk-${i + index}` as UUID;\r\n                        const chunkEmbedding = new Float32Array(embeddingArray);\r\n\r\n                        await this.runtime.databaseAdapter.createKnowledge({\r\n                            id: chunkId,\r\n                            agentId: this.runtime.agentId,\r\n                            content: {\r\n                                text: batch[index],\r\n                                metadata: {\r\n                                    source: file.path,\r\n                                    type: file.type,\r\n                                    isShared: file.isShared || false,\r\n                                    isChunk: true,\r\n                                    originalId: scopedId,\r\n                                    chunkIndex: i + index,\r\n                                    originalPath: file.path,\r\n                                },\r\n                            },\r\n                            embedding: chunkEmbedding,\r\n                            createdAt: Date.now(),\r\n                        });\r\n                    })\r\n                );\r\n\r\n                processedChunks += batch.length;\r\n                const batchTime = (Date.now() - batchStart) / 1000;\r\n                elizaLogger.info(\r\n                    `[Batch Progress] ${file.path}: Processed ${processedChunks}/${totalChunks} chunks (${batchTime.toFixed(2)}s for batch)`\r\n                );\r\n            }\r\n\r\n            const totalTime = (Date.now() - startTime) / 1000;\r\n            elizaLogger.info(\r\n                `[Complete] Processed ${file.path} in ${totalTime.toFixed(2)}s`\r\n            );\r\n        } catch (error) {\r\n            if (\r\n                file.isShared &&\r\n                error?.code === \"SQLITE_CONSTRAINT_PRIMARYKEY\"\r\n            ) {\r\n                elizaLogger.info(\r\n                    `Shared knowledge ${file.path} already exists in database, skipping creation`\r\n                );\r\n                return;\r\n            }\r\n            elizaLogger.error(`Error processing file ${file.path}:`, error);\r\n            throw error;\r\n        }\r\n    }\r\n}\r\n","import { z } from \"zod\";\r\nimport { ModelProviderName } from \"./types\";\r\nimport elizaLogger from \"./logger\";\r\n\r\n// TODO: TO COMPLETE\r\nexport const envSchema = z.object({\r\n    // API Keys with specific formats\r\n    OPENAI_API_KEY: z\r\n        .string()\r\n        .startsWith(\"sk-\", \"OpenAI API key must start with 'sk-'\"),\r\n    REDPILL_API_KEY: z.string().min(1, \"REDPILL API key is required\"),\r\n    GROK_API_KEY: z.string().min(1, \"GROK API key is required\"),\r\n    GROQ_API_KEY: z\r\n        .string()\r\n        .startsWith(\"gsk_\", \"GROQ API key must start with 'gsk_'\"),\r\n    OPENROUTER_API_KEY: z.string().min(1, \"OpenRouter API key is required\"),\r\n    AIMLAPI_API_KEY: z.string().min(1, \"AI/ML API key is required\"),\r\n    GOOGLE_GENERATIVE_AI_API_KEY: z\r\n        .string()\r\n        .min(1, \"Gemini API key is required\"),\r\n    ELEVENLABS_XI_API_KEY: z.string().min(1, \"ElevenLabs API key is required\"),\r\n});\r\n\r\n// Type inference\r\nexport type EnvConfig = z.infer<typeof envSchema>;\r\n\r\n// Validation function\r\nexport function validateEnv(): EnvConfig {\r\n    try {\r\n        return envSchema.parse(process.env);\r\n    } catch (error) {\r\n        if (error instanceof z.ZodError) {\r\n            const errorMessages = error.errors\r\n                .map((err) => `${err.path}: ${err.message}`)\r\n                .join(\"\\n\");\r\n            throw new Error(`Environment validation failed:\\n${errorMessages}`);\r\n        }\r\n        throw error;\r\n    }\r\n}\r\n\r\n// Helper schemas for nested types\r\nconst MessageExampleSchema = z.object({\r\n    user: z.string(),\r\n    content: z\r\n        .object({\r\n            text: z.string(),\r\n            action: z.string().optional(),\r\n            source: z.string().optional(),\r\n            url: z.string().optional(),\r\n            inReplyTo: z.string().uuid().optional(),\r\n            attachments: z.array(z.any()).optional(),\r\n        })\r\n        .and(z.record(z.string(), z.unknown())), // For additional properties\r\n});\r\n\r\nconst PluginSchema = z.object({\r\n    name: z.string(),\r\n    description: z.string(),\r\n    actions: z.array(z.any()).optional(),\r\n    providers: z.array(z.any()).optional(),\r\n    evaluators: z.array(z.any()).optional(),\r\n    services: z.array(z.any()).optional(),\r\n    clients: z.array(z.any()).optional(),\r\n});\r\n\r\n// Main Character schema\r\nexport const CharacterSchema = z.object({\r\n    id: z.string().uuid().optional(),\r\n    name: z.string(),\r\n    system: z.string().optional(),\r\n    modelProvider: z.nativeEnum(ModelProviderName),\r\n    modelEndpointOverride: z.string().optional(),\r\n    templates: z.record(z.string()).optional(),\r\n    bio: z.union([z.string(), z.array(z.string())]),\r\n    lore: z.array(z.string()),\r\n    messageExamples: z.array(z.array(MessageExampleSchema)),\r\n    postExamples: z.array(z.string()),\r\n    topics: z.array(z.string()),\r\n    adjectives: z.array(z.string()),\r\n    knowledge: z\r\n        .array(\r\n            z.union([\r\n                z.string(), // Direct knowledge strings\r\n                z.object({\r\n                    // Individual file config\r\n                    path: z.string(),\r\n                    shared: z.boolean().optional(),\r\n                }),\r\n                z.object({\r\n                    // Directory config\r\n                    directory: z.string(),\r\n                    shared: z.boolean().optional(),\r\n                }),\r\n            ])\r\n        )\r\n        .optional(),\r\n    plugins: z.union([z.array(z.string()), z.array(PluginSchema)]),\r\n    settings: z\r\n        .object({\r\n            secrets: z.record(z.string()).optional(),\r\n            voice: z\r\n                .object({\r\n                    model: z.string().optional(),\r\n                    url: z.string().optional(),\r\n                })\r\n                .optional(),\r\n            model: z.string().optional(),\r\n            modelConfig: z.object({\r\n                maxInputTokens: z.number().optional(),\r\n                maxOutputTokens: z.number().optional(),\r\n                temperature: z.number().optional(),\r\n                frequency_penalty: z.number().optional(),\r\n                presence_penalty:z.number().optional()\r\n            })\r\n            .optional(),\r\n            embeddingModel: z.string().optional(),\r\n        })\r\n        .optional(),\r\n    clientConfig: z\r\n        .object({\r\n            discord: z\r\n                .object({\r\n                    shouldIgnoreBotMessages: z.boolean().optional(),\r\n                    shouldIgnoreDirectMessages: z.boolean().optional(),\r\n                })\r\n                .optional(),\r\n            telegram: z\r\n                .object({\r\n                    shouldIgnoreBotMessages: z.boolean().optional(),\r\n                    shouldIgnoreDirectMessages: z.boolean().optional(),\r\n                })\r\n                .optional(),\r\n        })\r\n        .optional(),\r\n    style: z.object({\r\n        all: z.array(z.string()),\r\n        chat: z.array(z.string()),\r\n        post: z.array(z.string()),\r\n    }),\r\n    twitterProfile: z\r\n        .object({\r\n            username: z.string(),\r\n            screenName: z.string(),\r\n            bio: z.string(),\r\n            nicknames: z.array(z.string()).optional(),\r\n        })\r\n        .optional(),\r\n    nft: z\r\n        .object({\r\n            prompt: z.string().optional(),\r\n        })\r\n        .optional(),\r\n    extends: z.array(z.string()).optional(),\r\n});\r\n\r\n// Type inference\r\nexport type CharacterConfig = z.infer<typeof CharacterSchema>;\r\n\r\n// Validation function\r\nexport function validateCharacterConfig(json: unknown): CharacterConfig {\r\n    try {\r\n        return CharacterSchema.parse(json);\r\n    } catch (error) {\r\n        if (error instanceof z.ZodError) {\r\n            const groupedErrors = error.errors.reduce(\r\n                (acc, err) => {\r\n                    const path = err.path.join(\".\");\r\n                    if (!acc[path]) {\r\n                        acc[path] = [];\r\n                    }\r\n                    acc[path].push(err.message);\r\n                    return acc;\r\n                },\r\n                {} as Record<string, string[]>\r\n            );\r\n\r\n            Object.entries(groupedErrors).forEach(([field, messages]) => {\r\n                elizaLogger.error(\r\n                    `Validation errors in ${field}: ${messages.join(\" - \")}`\r\n                );\r\n            });\r\n\r\n            throw new Error(\r\n                \"Character configuration validation failed. Check logs for details.\"\r\n            );\r\n        }\r\n        throw error;\r\n    }\r\n}\r\n","import path from \"path\";\r\nimport fs from \"fs/promises\";\r\nimport type {\r\n    CacheOptions,\r\n    ICacheManager,\r\n    IDatabaseCacheAdapter,\r\n    UUID,\r\n} from \"./types\";\r\n\r\nexport interface ICacheAdapter {\r\n    get(key: string): Promise<string | undefined>;\r\n    set(key: string, value: string): Promise<void>;\r\n    delete(key: string): Promise<void>;\r\n}\r\n\r\nexport class MemoryCacheAdapter implements ICacheAdapter {\r\n    data: Map<string, string>;\r\n\r\n    constructor(initalData?: Map<string, string>) {\r\n        this.data = initalData ?? new Map<string, string>();\r\n    }\r\n\r\n    async get(key: string): Promise<string | undefined> {\r\n        return this.data.get(key);\r\n    }\r\n\r\n    async set(key: string, value: string): Promise<void> {\r\n        this.data.set(key, value);\r\n    }\r\n\r\n    async delete(key: string): Promise<void> {\r\n        this.data.delete(key);\r\n    }\r\n}\r\n\r\nexport class FsCacheAdapter implements ICacheAdapter {\r\n    constructor(private dataDir: string) {}\r\n\r\n    async get(key: string): Promise<string | undefined> {\r\n        try {\r\n            return await fs.readFile(path.join(this.dataDir, key), \"utf8\");\r\n        } catch {\r\n            // console.error(error);\r\n            return undefined;\r\n        }\r\n    }\r\n\r\n    async set(key: string, value: string): Promise<void> {\r\n        try {\r\n            const filePath = path.join(this.dataDir, key);\r\n            // Ensure the directory exists\r\n            await fs.mkdir(path.dirname(filePath), { recursive: true });\r\n            await fs.writeFile(filePath, value, \"utf8\");\r\n        } catch (error) {\r\n            console.error(error);\r\n        }\r\n    }\r\n\r\n    async delete(key: string): Promise<void> {\r\n        try {\r\n            const filePath = path.join(this.dataDir, key);\r\n            await fs.unlink(filePath);\r\n        } catch {\r\n            // console.error(error);\r\n        }\r\n    }\r\n}\r\n\r\nexport class DbCacheAdapter implements ICacheAdapter {\r\n    constructor(\r\n        private db: IDatabaseCacheAdapter,\r\n        private agentId: UUID\r\n    ) {}\r\n\r\n    async get(key: string): Promise<string | undefined> {\r\n        return this.db.getCache({ agentId: this.agentId, key });\r\n    }\r\n\r\n    async set(key: string, value: string): Promise<void> {\r\n        await this.db.setCache({ agentId: this.agentId, key, value });\r\n    }\r\n\r\n    async delete(key: string): Promise<void> {\r\n        await this.db.deleteCache({ agentId: this.agentId, key });\r\n    }\r\n}\r\n\r\nexport class CacheManager<CacheAdapter extends ICacheAdapter = ICacheAdapter>\r\n    implements ICacheManager\r\n{\r\n    adapter: CacheAdapter;\r\n\r\n    constructor(adapter: CacheAdapter) {\r\n        this.adapter = adapter;\r\n    }\r\n\r\n    async get<T = unknown>(key: string): Promise<T | undefined> {\r\n        const data = await this.adapter.get(key);\r\n\r\n        if (data) {\r\n            const { value, expires } = JSON.parse(data) as {\r\n                value: T;\r\n                expires: number;\r\n            };\r\n\r\n            if (!expires || expires > Date.now()) {\r\n                return value;\r\n            }\r\n\r\n            this.adapter.delete(key).catch(() => {});\r\n        }\r\n\r\n        return undefined;\r\n    }\r\n\r\n    async set<T>(key: string, value: T, opts?: CacheOptions): Promise<void> {\r\n        return this.adapter.set(\r\n            key,\r\n            JSON.stringify({ value, expires: opts?.expires ?? 0 })\r\n        );\r\n    }\r\n\r\n    async delete(key: string): Promise<void> {\r\n        return this.adapter.delete(key);\r\n    }\r\n}\r\n"],"mappings":"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","names":["names","uniqueNamesGenerator","config","path","path","settings","GoalStatus","ModelClass","ModelProviderName","CacheStore","IrysMessageType","IrysDataType","ServiceType","LoggingLevel","TokenizerType","TranscriptionProvider","ActionTimelineType","KnowledgeScope","CacheKeyPrefix","path","fileURLToPath","__filename","fileURLToPath","__dirname","path","fs","options","config","input","runtime","names","uniqueNamesGenerator","uniqueNamesGenerator","names","fs","path","baseURL","apiKey","options","config","fs","path","options","settings","actor","join","names","uniqueNamesGenerator","path","existsSync","join","result","uniqueNamesGenerator","names","message","actors","z","z","path","path","fs"]}